(function(q){var i=q.Vector3DUtil;var g=q.JNumber3D;var r=q.JConstraint;var b=q.JConfig;var h=q.JSphere;var k=q.MaterialProperties;var j=q.RigidBody;var o=q.CollPointInfo;var a=q.CollisionInfo;var p=q.JBox;var d=q.JIndexedTriangle;var m=q.JSegment;var f=q.JTriangle;var e=q.JTriangleMesh;var n=q.CollOutData;var c=q.EdgeData;var l=function(){this.name="BoxMesh";this.type0="BOX";this.type1="TRIANGLEMESH";};q.extend(l,q.CollDetectFunctor);l.prototype.disjoint=function(y,v,B,A){var x=B.getSpan(v);var w=A.getSpan(v);var t=x.min,z=x.max,C=w.min,u=w.max,s=g.NUM_TINY;if(t>(u+b.collToll+s)||C>(z+b.collToll+s)){y.flag=true;return true;}if((z>u)&&(C>t)){y.depth=Math.min(z-C,u-t);}else{if((u>z)&&(t>C)){y.depth=Math.min(u-t,z-C);}else{y.depth=Math.min(z,u);y.depth-=Math.max(t,C);}}y.flag=false;return false;};l.prototype.addPoint=function(v,u,s){for(var t=0;t<v.length;t++){var w=v[t];if(i.get_lengthSquared(i.subtract(w,u))<s){w=i.add(w,u);i.scaleBy(w,0.5);return false;}}v.push(u);return true;};l.prototype.getBoxTriangleIntersectionPoints=function(D,z,y,C){var v=z.edges;var s=z.getCornerPoints(z.currentState);var x;var t;var u;for(var w=0;w<12;w++){t=v[w];x=new n();u=new m(s[t.ind0],i.subtract(s[t.ind1],s[t.ind0]));if(y.segmentTriangleIntersection(x,u)){this.addPoint(D,u.getPoint(x.frac),C);if(D.length>8){return D.length;}}}var B,A;for(w=0;w<3;w++){B=y.getVertex(w);A=y.getVertex((w+1)%3);x=new n();if(z.segmentIntersect(x,new m(B,i.subtract(A,B)),z.get_currentState())){this.addPoint(D,x.position,C);if(D.length>8){return D.length;}}if(z.segmentIntersect(x,new m(A,i.subtract(B,A)),z.get_currentState())){this.addPoint(D,x.position,C);if(D.length>8){return D.length;}}}return D.length;};l.prototype.doOverlapBoxTriangleTest=function(A,R,s,W,S){var O,J,I,V,G,x,B,Y,U,aa;var E=A.get_currentState().getOrientationCols();var M=new f(s.octree.getVertex(R.getVertexIndex(0)),s.octree.getVertex(R.getVertexIndex(1)),s.octree.getVertex(R.getVertexIndex(2)));O=i.subtract(M.getVertex(1),M.getVertex(0));i.normalize(O);J=i.subtract(M.getVertex(2),M.getVertex(1));i.normalize(J);I=i.subtract(M.getVertex(0),M.getVertex(2));i.normalize(I);var V=i.clone(R.plane.normal);var C=13;var Q=[[V,E[0],E[1],E[2],i.crossProduct(E[0],O),i.crossProduct(E[0],J),i.crossProduct(E[0],I),i.crossProduct(E[1],O),i.crossProduct(E[1],J),i.crossProduct(E[1],I),i.crossProduct(E[2],O),i.crossProduct(E[2],J),i.crossProduct(E[2],I)]];var z=[];for(var P=0;P<C;P++){z[P]=new SpanData();if(this.disjoint(z[P],Q[P],A,M)){return false;}}var F=-1;var v=g.NUM_TINY,X=g.NUM_HUGE,H,y,ab,t,Z;for(P=0;P<C;P++){H=i.get_lengthSquared(Q[P]);if(H<v){continue;}y=1/Math.sqrt(H);i.scaleBy(Q[P],y);z[P].depth*=y;if(z[P].depth<X){X=z[P].depth;F=P;}}if(F==-1){return false;}G=i.subtract(A.get_currentState().position,M.getCentre());x=Q[F];ab=z[F].depth;if(i.dotProduct(G,x)<0){i.negate(x);}B=A.get_oldState().position;Y=A.get_currentState().position;U=s.get_currentState().position;var ac=[];t=ab+0.05;this.getBoxTriangleIntersectionPoints(ac,A,M,t*t);aa=i.subtract(Y,B);Z=ab+i.dotProduct(aa,x);var u=ac.length;var L=[];if(u>0){var w;for(P=0;P<u;P++){w=new o();w.r0=i.subtract(ac[P],Y);w.r1=i.subtract(ac[P],U);w.initialPenetration=Z;L[P]=w;}var K=new a();K.objInfo=W;K.dirToBody=x;K.pointInfo=L;var T=new k();T.set_restitution(0.5*(A.get_material().get_restitution()+s.get_material().get_restitution()));T.set_friction(0.5*(A.get_material().get_friction()+s.get_material().get_friction()));K.mat=T;S.push(K);W.body0.collisions.push(K);W.body1.collisions.push(K);return true;}else{return false;}};l.prototype.collDetectBoxStaticMeshOverlap=function(w,D,t,A){var u=w.get_boundingSphere();var C=w.get_currentState().position;var v=[];var s=D.octree.getTrianglesIntersectingtAABox(v,w.get_boundingBox());var B=false;var y;var x;for(var z=0;z<s;++z){x=D.octree.getTriangle(v[z]);y=x.plane.pointPlaneDistance(C);if(y>u||y<0){continue;}if(this.doOverlapBoxTriangleTest(w,x,D,t,A)){B=true;}}return B;};l.prototype.collDetect=function(v,u){var s;if(v.body0.type=="TRIANGLEMESH"){s=v.body0;v.body0=v.body1;v.body1=s;}var t=v.body0;var w=v.body1;this.collDetectBoxStaticMeshOverlap(t,w,v,u);};q.CollDetectBoxMesh=l;})(jigLib);