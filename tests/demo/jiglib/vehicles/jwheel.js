(function(f){var o=f.Vector3DUtil;var h=f.JMatrix3D;var a=f.JNumber3D;var p=f.JSegment;var j=f.JConfig;var i=f.PhysicsSystem;var c=Math,g=c.PI,e=c.min,k=c.max,m=c.cos,n=c.abs,l=c.sqrt;var d=function(q){this._car=q;};d.prototype.name=null;d.prototype.noslipVel=0.2;d.prototype.slipVel=0.4;d.prototype.slipFactor=0.7;d.prototype.smallVel=3;d.prototype._car=null;d.prototype._pos=null;d.prototype._axisUp=null;d.prototype._spring=null;d.prototype._travel=null;d.prototype._inertia=null;d.prototype._radius=null;d.prototype._sideFriction=null;d.prototype._fwdFriction=null;d.prototype._damping=null;d.prototype._numRays=null;d.prototype._angVel=null;d.prototype._steerAngle=null;d.prototype._torque=null;d.prototype._driveTorque=null;d.prototype._axisAngle=null;d.prototype._displacement=null;d.prototype._upSpeed=null;d.prototype._rotDamping=null;d.prototype._normalForce=null;d.prototype._locked=null;d.prototype._lastDisplacement=null;d.prototype._lastOnFloor=null;d.prototype._angVelForGrip=null;d.prototype.worldPos=null;d.prototype.worldAxis=null;d.prototype.wheelFwd=null;d.prototype.wheelUp=null;d.prototype.wheelLeft=null;d.prototype.wheelRayEnd=null;d.prototype.wheelRay=null;d.prototype.groundUp=null;d.prototype.groundLeft=null;d.prototype.groundFwd=null;d.prototype.wheelPointVel=null;d.prototype.rimVel=null;d.prototype.worldVel=null;d.prototype.wheelCentreVel=null;d.prototype._collSystem=null;d.prototype.setup=function(y,v,A,r,w,x,s,u,t,z,B,q){if(A==null){A=0;}if(r==null){r=0;}if(w==null){w=0;}if(x==null){x=0;}if(s==null){s=0;}if(u==null){u=0;}if(t==null){t=0;}if(z==null){z=0;}if(B==null){B=0;}if(q==null){q=0;}this._pos=y;this._axisUp=v;this._spring=A;this._travel=r;this._inertia=w;this._radius=x;this._sideFriction=s;this._fwdFriction=u;this._damping=t;this._numRays=z;this._drive=B;this._normalForce=q;this._torque=0;this.reset();};d.prototype.addTorque=function(q){this._driveTorque+=q;};d.prototype.setLock=function(q){this._locked=q;};d.prototype.setSteerAngle=function(q){this._steerAngle=q;};d.prototype.getSteerAngle=function(){return this._steerAngle;};d.prototype.getPos=function(){return this._pos;};d.prototype.getLocalAxisUp=function(){return this._axisUp;};d.prototype.getActualPos=function(){return o.add(this._pos,a.getScaleVector(this._axisUp,this._displacement));};d.prototype.getRadius=function(){return this._radius;};d.prototype.getDisplacement=function(){return this._displacement;};d.prototype.getAxisAngle=function(){return this._axisAngle;};d.prototype.getRollAngle=function(){return 0.1*this._angVel*180/g;};d.prototype.setRotationDamping=function(q){this._rotDamping=q;};d.prototype.getRotationDamping=function(){return this._rotDamping;};d.prototype.getOnFloor=function(){return this._lastOnFloor;};var b=0;d.prototype.addForcesToCar=function(P){var r=[0,0,0,0];this._lastDisplacement=this._displacement;this._displacement=0;var Y=this._car._chassis;worldPos=this._pos.slice(0);h.multiplyVector(Y.get_currentState().get_orientation(),worldPos);worldPos=o.add(Y.get_currentState().position,worldPos);worldAxis=this._axisUp.slice(0);h.multiplyVector(Y.get_currentState().get_orientation(),worldAxis);wheelFwd=Y.get_currentState().getOrientationCols()[2].slice(0);h.multiplyVector(h.getRotationMatrix(worldAxis[0],worldAxis[1],worldAxis[2],this._steerAngle/180*2*Math.PI),wheelFwd);wheelUp=worldAxis;wheelLeft=o.crossProduct(wheelUp,wheelFwd);o.normalize(wheelLeft);var X=2*this._radius+this._travel;wheelRayEnd=o.subtract(worldPos,a.getScaleVector(worldAxis,this._radius));wheelRay=new p(o.add(wheelRayEnd,a.getScaleVector(worldAxis,X)),a.getScaleVector(worldAxis,-X));if(this._collSystem==null){this._collSystem=i.getInstance().getCollisionSystem();}var V=10;var t=e(this._numRays,V);var x=[];var T=[];var B=(2*this._radius)/(t+1);var W=B;this._lastOnFloor=false;var z;var I;var D=0;var L=0;var q=null;for(L=0;L<t;L++){x[L]={};z=(W+L*B)-this._radius;I=this._radius*(1-m(90*(z/this._radius)*g/180));q=wheelRay.clone();q.origin=o.add(q.origin,o.add(a.getScaleVector(wheelFwd,z),a.getScaleVector(wheelUp,I)));if(this._collSystem.segmentIntersect(x[L],q,Y)){this._lastOnFloor=true;if(x[L].fracOut<x[D].fracOut){D=L;}}T[L]=q;}if(!this._lastOnFloor){return false;}var v=x[D].fracOut;var O=x[D].posOut;var M=x[D].bodyOut;var R=worldAxis.slice(0);if(t>1){for(L=0;L<t;L++){var G=x[L].fracOut;if(G<=1){R=o.add(R,a.getScaleVector(o.subtract(worldPos,T[L].getEnd()),1-G));}}o.normalize(R);}else{R=x[D].normalOut;}wheelFwd=o.crossProduct(wheelLeft,R);this._displacement=X*(1-v);if(this._displacement<0){this._displacement=0;}var Q=Y.get_mass();var F=Q/4;var s=M.get_friction();var K=Y.getVelocity(this._pos);var y=this._displacement;if(this._displacement>this._travel){this._displacement=this._travel;var w=o.dotProduct(K,R)/P*F;w=w*2*M.get_restitution()/10;A=a.getScaleVector(R,-w);r=o.add(r,A);}A=a.getScaleVector(this._axisUp,this._spring*this._displacement+this._upSpeed*this._damping);r=o.add(r,A);groundUp=R;groundLeft=o.crossProduct(R,wheelFwd);o.normalize(groundLeft);groundFwd=o.crossProduct(groundLeft,groundUp);var S=a.getScaleVector(o.crossProduct(groundLeft,o.subtract(O,worldPos)),-this._angVel);var u=a.getScaleVector(groundFwd,o.dotProduct(K,groundFwd));var C=this._fwdFriction*s;var A=a.getScaleVector(o.subtract(S,u),F/P/this._radius*C);var H=o.get_length(A);if(H>this._normalForce*C){A=a.getScaleVector(A,this._normalForce*C/H);}r=o.add(r,A);this._torque-=o.dotProduct(o.subtract(S,u),groundFwd)/this._radius*F/P;this._angVelForGrip=o.dotProduct(K,groundFwd)/this._radius;var E=o.dotProduct(K,groundLeft);var C=this._sideFriction*s;var U=a.getScaleVector(groundLeft,-E*C);var A=a.getScaleVector(U,F/P/this._radius);var H=o.get_length(A);if(H>this._normalForce*C){A=a.getScaleVector(A,this._normalForce*C/H);}r=o.add(r,A);Y.addWorldForce(r,O);if(M.get_movable()){var J=500;var N=J*M.get_mass();if(o.get_lengthSquared(r)>(N*N)){r=a.getScaleVector(r,N/o.get_length(r));}M.addWorldForce(a.getScaleVector(r,-1),O);}return true;};d.prototype.update=function(r){if(r<=0){return;}var q=this._angVel;this._upSpeed=(this._displacement-this._lastDisplacement)/k(r,a.NUM_TINY);if(this._locked){this._angVel=0;this._torque=0;}else{this._angVel+=(this._torque*r/this._inertia);this._torque=0;if(((q>this._angVelForGrip)&&(this._angVel<this._angVelForGrip))||((q<this._angVelForGrip)&&(this._angVel>this._angVelForGrip))){this._angVel=this._angVelForGrip;}this._angVel+=this._driveTorque*r/this._inertia*this._drive;this._driveTorque=0;if(this._angVel<-100){this._angVel=-100;}else{if(this._angVel>100){this._angVel=100;}}this._angVel*=this._rotDamping;this._axisAngle+=(this._angVel*r*180/g);}};d.prototype.reset=function(){this._angVel=0;this._steerAngle=0;this._torque=0;this._driveTorque=0;this._axisAngle=0;this._displacement=0;this._upSpeed=0;this._locked=false;this._lastDisplacement=0;this._lastOnFloor=false;this._angVelForGrip=0;this._rotDamping=0.99;};f.JWheel=d;})(jigLib);