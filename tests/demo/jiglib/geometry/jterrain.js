(function(c){var e=c.Vector3DUtil;var d=c.JNumber3D;var b=c.ISkin3D;var a=c.PhysicsState;var f=c.RigidBody;var h=c.ITerrain;var g=function(i){this.Super(null);this._terrain=i;this.set_movable(false);this._type="TERRAIN";};c.extend(g,c.RigidBody);g.prototype._terrain=null;g.prototype.get_terrainMesh=function(){return this._terrain;};g.prototype.getHeightByIndex=function(l,k){l=this.limiteInt(l,0,_terrain.sw);k=this.limiteInt(k,0,_terrain.sh);return _terrain.heights[l][k];};g.prototype.getHeightAndNormalByPoint=function(v){var u=this.limiteInt(v[0],this._terrain.minW,this._terrain.maxW);var q=this.limiteInt(v[2],this._terrain.minH,this._terrain.maxH);var m=((u-_terrain.minW)/this._terrain.dw)|0;var i=((q-_terrain.minH)/this._terrain.dh)|0;m=this.limiteInt(m,0,this._terrain.sw);i=this.limiteInt(i,0,this._terrain.sh);var k=m+1;var x=i+1;k=this.limiteInt(k,0,this._terrain.sw);x=this.limiteInt(x,0,this._terrain.sh);var l=1-(u-(m*this._terrain.dw+this._terrain.minW))/this._terrain.dw;var j=(q-(i*this._terrain.dh+this._terrain.minH))/this._terrain.dh;l=d.getLimiteNumber(l,0,1);j=d.getLimiteNumber(j,0,1);var t=this._terrain.heights[m][i];var s=this._terrain.heights[m][x];var p=this._terrain.heights[k][i];var o=this._terrain.heights[k][x];var n={};n.height=0;n.normal=[0,0,0,0];var r;if(l<j||m==k||i==x){n.normal=e.crossProduct([0,o-p,this._terrain.dh,0],[this._terrain.dw,o-s,0,0]);e.normalize(n.normal);r=new PlaneData([(k*this._terrain.dw+this._terrain.minW),o,(x*this._terrain.dh+this._terrain.minH),0],n.normal);n.height=r.pointPlaneDistance(v);}else{n.normal=e.crossProduct([0,s-t,this._terrain.dh,0],[this._terrain.dw,p-t,0,0]);e.normalize(n.normal);r=new PlaneData([(m*this._terrain.dw+this._terrain.minW),t,(i*this._terrain.dh+this._terrain.minH),0],n.normal);n.height=r.pointPlaneDistance(v);}return n;};g.prototype.getHeightByPoint=function(i){return this.getHeightAndNormalByPoint(i).height;};g.prototype.getNormalByPoint=function(i){return this.getHeightAndNormalByPoint(i).normal;};g.prototype.getSurfacePosByPoint=function(i){return[i[0],this.getHeightAndNormalByPoint(i).height,i[2],0];};g.prototype.segmentIntersect=function(l,i,m){l.fracOut=0;l.posOut=[0,0,0,0];l.normalOut=[0,0,0,0];if(i.delta[1]>-d.NUM_TINY){return false;}var p=this.getHeightAndNormalByPoint(i.origin);if(p.height<0){return false;}var o=getHeightAndNormalByPoint(i.getEnd());if(o.height>0){return false;}var k=-o.height;var j=1/(d.NUM_TINY+p.height);var n=1/(d.NUM_TINY+o.height);e.scaleBy(p.normal,j);e.scaleBy(o.normal,n);l.normalOut=e.add(p.normal,o.normal);e.scaleBy(l.normalOut,1/(j+n));l.fracOut=p.height/(p.height+k+d.NUM_TINY);l.posOut=i.getPoint(l.fracOut);return true;};g.prototype.limiteInt=function(j,k,i){var l=j;if(l<k){l=k;}else{if(l>i){l=i;}}return l;};c.JTerrain=g;})(jigLib);