(function(b){var e=b.Vector3DUtil;var a=b.JMatrix3D;var c=b.JNumber3D;var g=b.JConstraint;var f=b.RigidBody;var d=function(j,k,h,i,l){if(!l){l=1;}this.Super();this._body0=j;this._body0Pos=k;this._body1=h;this._body1Pos=i;this._maxDistance=l;j.addConstraint(this);h.addConstraint(this);};b.extend(d,b.JConstraint);d.prototype._maxVelMag=20;d.prototype._minVelForProcessing=0.01;d.prototype._body0=null;d.prototype._body1=null;d.prototype._body0Pos=null;d.prototype._body1Pos=null;d.prototype._maxDistance=null;d.prototype.r0=null;d.prototype.r1=null;d.prototype._worldPos=null;d.prototype._currentRelPos0=null;d.prototype.preApply=function(j){this.set_satisfied(false);this.r0=this._body0Pos.slice(0);this.r1=this._body1Pos.slice(0);a.multiplyVector(this._body0.get_currentState().get_orientation(),this.r0);a.multiplyVector(this._body1.get_currentState().get_orientation(),this.r1);var i=e.add(this._body0.get_currentState().position,this.r0);var h=e.add(this._body1.get_currentState().position,this.r1);this._worldPos=c.getScaleVector(e.add(i,h),0.5);this._currentRelPos0=e.subtract(i,h);};d.prototype.apply=function(i){this.set_satisfied(true);if(!this._body0.isActive&&!this._body1.isActive){return false;}var n=this._body0.getVelocity(this.r0);var m=this._body1.getVelocity(this.r1);var p=e.add(this._currentRelPos0,c.getScaleVector(e.subtract(n,m),i));var o=p.slice(0);var u=e.get_length(o);if(u<=c.NUM_TINY){return false;}if(u>this._maxDistance){o=c.getScaleVector(o,this._maxDistance/u);}var s=c.getDivideVector(e.subtract(o,this._currentRelPos0),i);var h=e.subtract(e.subtract(n,m),s);var l=e.get_length(h);if(l>this._maxVelMag){h=c.getScaleVector(h,this._maxVelMag/l);l=this._maxVelMag;}else{if(l<this._minVelForProcessing){return false;}}var r=c.getDivideVector(h,l);var t=e.crossProduct(this.r0,r);a.multiplyVector(this._body0.get_worldInvInertia(),t);var q=e.crossProduct(this.r1,r);a.multiplyVector(this._body1.get_worldInvInertia(),q);var k=this._body0.get_invMass()+this._body1.get_invMass()+e.dotProduct(r,e.crossProduct(t,this.r0))+e.dotProduct(r,e.crossProduct(q,this.r1));if(k<c.NUM_TINY){return false;}var j=c.getScaleVector(r,-l/k);this._body0.applyWorldImpulse(j,this._worldPos);this._body1.applyWorldImpulse(c.getScaleVector(j,-1),this._worldPos);this._body0.setConstraintsAndCollisionsUnsatisfied();this._body1.setConstraintsAndCollisionsUnsatisfied();this.set_satisfied(true);return true;};b.JConstraintMaxDistance=d;})(jigLib);