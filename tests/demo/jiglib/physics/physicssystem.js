(function(d){var l=d.Vector3DUtil;var h=d.JConfig;var k=d.CollPointInfo;var m=d.CollisionInfo;var i=d.CollisionSystem;var g=d.ContactData;var e=d.JMatrix3D;var b=d.JNumber3D;var j=d.JConstraint;var c=d.BodyPair;var a=d.CachedImpulse;var f=function(){this.setSolverType(h.solverType);this._doingIntegration=false;this._bodies=[];this._collisions=[];this._effects=[];this._activeBodies=[];this._constraints=[];this._controllers=[];this._cachedContacts=[];this._collisionSystem=new i();this.setGravity(b.getScaleVector(l.Y_AXIS,-10));};f.prototype._currentPhysicsSystem=null;f.prototype._maxVelMag=0.5;f.prototype._minVelForProcessing=0.001;f.prototype._bodies=null;f.prototype._activeBodies=null;f.prototype._collisions=null;f.prototype._constraints=null;f.prototype._controllers=null;f.prototype._effects=null;f.prototype._gravityAxis=null;f.prototype._gravity=null;f.prototype._doingIntegration=null;f.prototype.preProcessCollisionFn=function(){};f.prototype.preProcessContactFn=function(){};f.prototype.processCollisionFn=function(){};f.prototype.processContactFn=function(){};f.prototype._cachedContacts=null;f.prototype._collisionSystem=null;f.getInstance=function(){if(!f._currentPhysicsSystem){f._currentPhysicsSystem=new f();}return f._currentPhysicsSystem;};f.prototype.getAllExternalForces=function(p){for(var o=0,q=this._bodies.length;o<q;o++){this._bodies[o].addExternalForces(p);}for(var o=0,n=this._controllers.length;o<n;o++){this._controllers[o].updateController(p);}};f.prototype.getCollisionSystem=function(){return this._collisionSystem;};f.prototype.setGravity=function(n){this._gravity=n;if(this._gravity[0]==this._gravity[1]&&this._gravity[1]==this._gravity[2]){this._gravityAxis=-1;}this._gravityAxis=0;if(Math.abs(this._gravity[1])>Math.abs(this._gravity[2])){this._gravityAxis=1;}if(Math.abs(this._gravity[2])>Math.abs(b.toArray(this._gravity)[this._gravityAxis])){this._gravityAxis=2;}};f.prototype.get_gravity=function(){return this._gravity;};f.prototype.get_gravityAxis=function(){return this._gravityAxis;};f.prototype.get_bodies=function(){return this._bodies;};f.prototype.addBody=function(n){if(!this.findBody(n)){this._bodies.push(n);this._collisionSystem.addCollisionBody(n);}};f.prototype.removeBody=function(n){if(this.findBody(n)){this._bodies.splice(this._bodies.indexOf(n),1);this._collisionSystem.removeCollisionBody(n);}};f.prototype.removeAllBodies=function(){this._bodies=[];this._collisionSystem.removeAllCollisionBodies();};f.prototype.addConstraint=function(n){if(!this.findConstraint(n)){this._constraints.push(n);}};f.prototype.removeConstraint=function(n){if(this.findConstraint(n)){this._constraints.splice(this._constraints.indexOf(n),1);}};f.prototype.removeAllConstraints=function(){this._constraints=[];};f.prototype.addEffect=function(n){if(!this.findEffect(n)){this._effects.push(n);}};f.prototype.removeEffect=function(n){if(this.findEffect(n)){this._effects.splice(this._effects.indexOf(n),1);}};f.prototype.removeAllEffects=function(){this._effects=[];};f.prototype.addController=function(n){if(!this.findController(n)){this._controllers.push(n);}};f.prototype.removeController=function(n){if(this.findController(n)){this._controllers.splice(this._controllers.indexOf(n),1);}};f.prototype.removeAllControllers=function(){this._controllers=[];};f.prototype.setSolverType=function(n){switch(n){case"FAST":this.preProcessCollisionFn=this.preProcessCollisionFast;this.preProcessContactFn=this.preProcessCollisionFast;this.processCollisionFn=this.processCollision;this.processContactFn=this.processCollision;return;case"NORMAL":this.preProcessCollisionFn=this.preProcessCollisionNormal;this.preProcessContactFn=this.preProcessCollisionNormal;this.processCollisionFn=this.processCollision;this.processContactFn=this.processCollision;return;case"ACCUMULATED":this.preProcessCollisionFn=this.preProcessCollisionAccumulated;this.preProcessContactFn=this.preProcessCollisionAccumulated;this.processCollisionFn=this.processCollision;this.processContactFn=this.processCollisionAccumulated;return;default:this.preProcessCollisionFn=this.preProcessCollisionNormal;this.preProcessContactFn=this.preProcessCollisionNormal;this.processCollisionFn=this.processCollision;this.processContactFn=this.processCollision;return;}};f.prototype.findBody=function(n){var o=this._bodies.length-1;if(o>0){do{if(n==this._bodies[o]){return true;}}while(o--);}return false;};f.prototype.findConstraint=function(o){var n=this._constraints.length-1;if(n>0){do{if(o==this._constraints[n]){return true;}}while(n--);}return false;};f.prototype.findEffect=function(o){var n=this._effects.length-1;if(n>0){do{if(o==this._effects[n]){return true;}}while(n--);}return false;};f.prototype.findController=function(n){var o=this._controllers.length-1;if(o>0){do{if(n==this._controllers[o]){return true;}}while(o--);}return false;};f.prototype.preProcessCollisionFast=function(z,p){z.satisfied=false;var o=z.objInfo.body0;var n=z.objInfo.body1;var u=z.dirToBody;var B=h.numPenetrationRelaxationTimesteps*p;var y=0;var A;var s;var r=z.pointInfo.length;var t=b.NUM_TINY;if(r>1){var x=[0,0,0,0];var v=[0,0,0,0];var D=0;for(var q=0;q<r;q++){A=z.pointInfo[q];x=l.add(x,A.r0);v=l.add(v,A.r1);D+=A.initialPenetration;}x=b.getDivideVector(x,r);v=b.getDivideVector(v,r);D/=r;var C=new k();C.r0=x;C.r1=v;C.initialPenetration=D;z.pointInfo=[C];}A=z.pointInfo[0];if(!o.get_movable()){A.denominator=0;}else{s=l.crossProduct(A.r0,u);e.multiplyVector(o.get_worldInvInertia(),s);A.denominator=o.get_invMass()+l.dotProduct(u,l.crossProduct(s,A.r0));}if(n.get_movable()){s=l.crossProduct(A.r1,u);e.multiplyVector(n.get_worldInvInertia(),s);A.denominator+=(n.get_invMass()+l.dotProduct(u,l.crossProduct(s,A.r1)));}if(A.denominator<t){A.denominator=t;}if(A.initialPenetration>h.allowedPenetration){A.minSeparationVel=(A.initialPenetration-h.allowedPenetration)/B;}else{y=-0.1*(A.initialPenetration-h.allowedPenetration)/h.allowedPenetration;if(y<t){y=t;}else{if(y>1){y=1;}}var w=(p>t)?p:t;A.minSeparationVel=y*(A.initialPenetration-h.allowedPenetration)/w;}if(A.minSeparationVel>this._maxVelMag){A.minSeparationVel=this._maxVelMag;}};f.prototype.preProcessCollisionNormal=function(w,p){w.satisfied=false;var o=w.objInfo.body0;var n=w.objInfo.body1;var t=w.dirToBody;var y=h.numPenetrationRelaxationTimesteps*p;var v=0;var x;var s;var r=w.pointInfo.length;for(var q=0;q<r;q++){x=w.pointInfo[q];if(!o.get_movable()){x.denominator=0;}else{s=l.crossProduct(x.r0,t);e.multiplyVector(o.get_worldInvInertia(),s);x.denominator=o.get_invMass()+l.dotProduct(t,l.crossProduct(s,x.r0));}if(n.get_movable()){s=l.crossProduct(x.r1,t);e.multiplyVector(n.get_worldInvInertia(),s);x.denominator+=(n.get_invMass()+l.dotProduct(t,l.crossProduct(s,x.r1)));}if(x.denominator<b.NUM_TINY){x.denominator=b.NUM_TINY;}if(x.initialPenetration>h.allowedPenetration){x.minSeparationVel=(x.initialPenetration-h.allowedPenetration)/y;}else{v=-0.1*(x.initialPenetration-h.allowedPenetration)/h.allowedPenetration;if(v<b.NUM_TINY){v=b.NUM_TINY;}else{if(v>1){v=1;}}var u=(p>b.NUM_TINY)?p:b.NUM_TINY;x.minSeparationVel=v*(x.initialPenetration-h.allowedPenetration)/u;}if(x.minSeparationVel>this._maxVelMag){x.minSeparationVel=this._maxVelMag;}}};f.prototype.preProcessCollisionAccumulated=function(s,A){s.satisfied=false;var z=s.objInfo.body0;var x=s.objInfo.body1;var t=s.dirToBody;var y=h.numPenetrationRelaxationTimesteps*A;var r;var v;var J;var G=0;var H=b.NUM_TINY;var w=h.allowedPenetration;var F=s.pointInfo.length;for(var E=0;E<F;E++){v=s.pointInfo[E];J=v.initialPenetration-w;if(!z.get_movable()){v.denominator=0;}else{r=l.crossProduct(v.r0,t);e.multiplyVector(z.get_worldInvInertia(),r);v.denominator=z.get_invMass()+l.dotProduct(t,l.crossProduct(r,v.r0));}if(x.get_movable()){r=l.crossProduct(v.r1,t);e.multiplyVector(x.get_worldInvInertia(),r);v.denominator+=(x.get_invMass()+l.dotProduct(t,l.crossProduct(r,v.r1)));}if(v.denominator<H){v.denominator=H;}if(v.initialPenetration>w){v.minSeparationVel=J/y;}else{G=-0.1*J/w;if(G<H){G=H;}else{if(G>1){G=1;}}var D=(A>H)?A:H;v.minSeparationVel=G*J/D;}v.accumulatedNormalImpulse=0;v.accumulatedNormalImpulseAux=0;v.accumulatedFrictionImpulse=[0,0,0,0];var q=0.04;var I=new c(z,x,[0,0,0,0],[0,0,0,0]);for(var C=0,p=this._cachedContacts.length;C<p;C++){var n=this._cachedContacts[C];var B=n.pair;if(I.body0!=B.body0||I.body1==B.body1){continue;}var o=(B.body0==z)?l.get_lengthSquared(l.subtract(B.r,v.r0)):l.get_lengthSquared(l.subtract(B.r,v.r1));if(o<q){q=o;v.accumulatedNormalImpulse=this._cachedContacts[C].impulse.normalImpulse;v.accumulatedNormalImpulseAux=this._cachedContacts[C].impulse.normalImpulseAux;v.accumulatedFrictionImpulse=this._cachedContacts[C].impulse.frictionImpulse;if(this._cachedContacts[C].pair.body0!=z){v.accumulatedFrictionImpulse=b.getScaleVector(v.accumulatedFrictionImpulse,-1);}}}var u;if(v.accumulatedNormalImpulse!=0){u=b.getScaleVector(t,v.accumulatedNormalImpulse);u=l.add(u,v.accumulatedFrictionImpulse);z.applyBodyWorldImpulse(u,v.r0);x.applyBodyWorldImpulse(b.getScaleVector(u,-1),v.r1);}if(v.accumulatedNormalImpulseAux!=0){u=b.getScaleVector(t,v.accumulatedNormalImpulseAux);z.applyBodyWorldImpulseAux(u,v.r0);x.applyBodyWorldImpulseAux(b.getScaleVector(u,-1),v.r1);}}};f.prototype.processCollision=function(t,F){t.satisfied=true;var C=t.objInfo.body0;var B=t.objInfo.body1;var x=false;var v=t.dirToBody;var I=0;var J=0;var p=0;var E=0;var z;var w;var u;var A;var H=t.pointInfo.length;for(var G=0;G<H;G++){A=t.pointInfo[G];w=C.getVelocity(A.r0);u=B.getVelocity(A.r1);J=l.dotProduct(l.subtract(w,u),v);if(J>A.minSeparationVel){continue;}p=-1*t.mat.get_restitution()*J;if(p<this._minVelForProcessing){p=A.minSeparationVel;}I=p-J;if(I<=this._minVelForProcessing){continue;}E=I/A.denominator;x=true;z=b.getScaleVector(v,E);C.applyBodyWorldImpulse(z,A.r0);B.applyBodyWorldImpulse(b.getScaleVector(z,-1),A.r1);var r;var D=w.slice(0);if(B.get_movable()){D=l.subtract(w,u);}var s=l.subtract(D,b.getScaleVector(v,l.dotProduct(D,v)));var y=l.get_length(s);if(y>this._minVelForProcessing){var q=b.getDivideVector(s,-y);var n=0;if(C.get_movable()){r=l.crossProduct(A.r0,q);e.multiplyVector(C.get_worldInvInertia(),r);n=C.get_invMass()+l.dotProduct(q,l.crossProduct(r,A.r0));}if(B.get_movable()){r=l.crossProduct(A.r1,q);e.multiplyVector(B.get_worldInvInertia(),r);n+=(B.get_invMass()+l.dotProduct(q,l.crossProduct(r,A.r1)));}if(n>b.NUM_TINY){var o=y/n;q=b.getScaleVector(q,o);C.applyBodyWorldImpulse(q,A.r0);B.applyBodyWorldImpulse(b.getScaleVector(q,-1),A.r1);}}}if(x){C.setConstraintsAndCollisionsUnsatisfied();B.setConstraintsAndCollisionsUnsatisfied();}return x;};f.prototype.processCollisionAccumulated=function(t,K){t.satisfied=true;var y=false;var w=t.dirToBody;var H=t.objInfo.body0;var G=t.objInfo.body1;var Q=0;var S=0;var J=0;var B;var x;var v;var C;var P=t.pointInfo.length;for(var M=0;M<P;M++){C=t.pointInfo[M];x=H.getVelocity(C.r0);v=G.getVelocity(C.r1);S=l.dotProduct(l.subtract(x,v),w);Q=-S;if(C.minSeparationVel<0){Q+=C.minSeparationVel;}if(Math.abs(Q)>this._minVelForProcessing){J=Q/C.denominator;var E=C.accumulatedNormalImpulse;var L=(E+J);if(L<0){L=0;}C.accumulatedNormalImpulse=L;var u=L-E;B=b.getScaleVector(w,u);H.applyBodyWorldImpulse(B,C.r0);G.applyBodyWorldImpulse(b.getScaleVector(B,-1),C.r1);y=true;}x=H.getVelocityAux(C.r0);v=G.getVelocityAux(C.r1);S=l.dotProduct(l.subtract(x,v),w);Q=-S;if(C.minSeparationVel>0){Q+=C.minSeparationVel;}if(Math.abs(Q)>this._minVelForProcessing){J=Q/C.denominator;E=C.accumulatedNormalImpulseAux;var F=C.accumulatedNormalImpulseAux+J;if(F<0){F=0;}C.accumulatedNormalImpulseAux=F;u=F-E;B=b.getScaleVector(w,u);H.applyBodyWorldImpulseAux(B,C.r0);G.applyBodyWorldImpulseAux(b.getScaleVector(B,-1),C.r1);y=true;}if(C.accumulatedNormalImpulse>0){x=H.getVelocity(C.r0);v=G.getVelocity(C.r1);var r;var I=l.subtract(x,v);var s=l.subtract(I,b.getScaleVector(w,l.dotProduct(I,w)));var A=l.get_length(s);if(A>this._minVelForProcessing){var q=b.getScaleVector(b.getDivideVector(s,A),-1);var o=0;if(H.get_movable()){r=l.crossProduct(C.r0,q);e.multiplyVector(H.get_worldInvInertia(),r);o=H.invMass+l.dotProduct(q,l.crossProduct(r,C.r0));}if(G.get_movable()){r=l.crossProduct(C.r1,q);e.multiplyVector(G.get_worldInvInertia(),r);o+=(G.invMass+l.dotProduct(q,l.crossProduct(r,C.r1)));}if(o>b.NUM_TINY){var p=A/o;var n=b.getScaleVector(q,p);var R=C.accumulatedFrictionImpulse.slice(0);C.accumulatedFrictionImpulse=l.add(C.accumulatedFrictionImpulse,n);var O=l.get_length(C.accumulatedFrictionImpulse);var D=t.mat.friction*C.accumulatedNormalImpulse;if(O>b.NUM_TINY&&O>D){C.accumulatedFrictionImpulse=b.getScaleVector(C.accumulatedFrictionImpulse,D/O);}var z=l.subtract(C.accumulatedFrictionImpulse,R);H.applyBodyWorldImpulse(z,C.r0);G.applyBodyWorldImpulse(b.getScaleVector(z,-1),C.r1);}}}}if(y){H.setConstraintsAndCollisionsUnsatisfied();G.setConstraintsAndCollisionsUnsatisfied();}return y;};f.prototype.sortPositionX=function(o,n){if(o.get_currentState().position[0]<n.get_currentState().position[0]){return -1;}else{if(o.get_currentState().position[0]>n.get_currentState().position[0]){return 1;}else{return 0;}}};f.prototype.sortPositionY=function(o,n){if(o.get_currentState().position[1]<n.get_currentState().position[1]){return -1;}else{if(o.get_currentState().position[1]>n.get_currentState().position[1]){return 1;}else{return 0;}}};f.prototype.sortPositionZ=function(o,n){if(o.get_currentState().position[2]<n.get_currentState().position[2]){return -1;}else{if(o.get_currentState().position[2]>n.get_currentState().position[2]){return 1;}else{return 0;}}};f.prototype.doShockStep=function(q){if(Math.abs(this._gravity[0])>Math.abs(this._gravity[1])&&Math.abs(this._gravity[0])>Math.abs(this._gravity[2])){this._bodies=this._bodies.sort(this.sortPositionX);this._collisionSystem.collBody=this._collisionSystem.collBody.sort(this.sortPositionX);}else{if(Math.abs(this._gravity[1])>Math.abs(this._gravity[2])&&Math.abs(this._gravity[1])>Math.abs(this._gravity[0])){this._bodies=this._bodies.sort(this.sortPositionY);this._collisionSystem.collBody=this._collisionSystem.collBody.sort(this.sortPositionY);}else{if(Math.abs(this._gravity[2])>Math.abs(this._gravity[0])&&Math.abs(this._gravity[2])>Math.abs(this._gravity[1])){this._bodies=this._bodies.sort(this.sortPositionZ);this._collisionSystem.collBody=this._collisionSystem.collBody.sort(this.sortPositionZ);}}}var r;var n;var s=true;var t=[];var p;var o;while(s){s=false;for(var v=0;v<this._bodies.length;v++){var w=this._bodies[v];if(w.get_movable()&&w.get_doShockProcessing()){if(w.collisions.length==0||!w.isActive){w.internalSetImmovable();}else{n=false;t=w.collisions;for(var u=0;u<t.length;u++){r=t[u];p=r.objInfo.body0;o=r.objInfo.body1;if((p==w&&!o.get_movable())||(o==w&&!p.get_movable())){this.preProcessCollisionFast(r,q);this.processCollision(r,q);n=true;}}if(n){w.internalSetImmovable();s=true;}}}}}for(var v=0;v<this._bodies.length;v++){w=this._bodies[v];w.internalRestoreImmovable();t=w.collisions;for(var u=0;u<t.length;u++){r=t[u];this.preProcessCollisionFn(r,q);this.processCollisionFn(r,q);}}};f.prototype.updateContactCache=function(){this._cachedContacts=[];var s;var u;var n;for(var q=0,o=this._collisions.length;q<o;q++){var t=this._collisions[q];for(var p=0,r=t.pointInfo.length;p<r;p++){s=t.pointInfo[p];u=(t.objInfo.body0.id>t.objInfo.body1.id)?s.accumulatedFrictionImpulse:b.getScaleVector(s.accumulatedFrictionImpulse,-1);n=new g();n.pair=new c(t.objInfo.body0,t.objInfo.body1,s.r0,s.r1);n.impulse=new a(s.accumulatedNormalImpulse,s.accumulatedNormalImpulseAux,s.accumulatedFrictionImpulse);this._cachedContacts.push(n);}}};f.prototype.handleAllConstraints=function(n,w,y){var z=this._collisions.length;var v;var r;for(var s=0,x=this._constraints.length;s<x;s++){this._constraints[s].preApply(n);}if(y){for(var s=0,x=this._collisions.length;s<x;s++){this.preProcessContactFn(this._collisions[s],n);this._collisions[s].mat.set_restitution(0);this._collisions[s].satisfied=false;}}else{for(var s=0,x=this._collisions.length;s<x;s++){this.preProcessCollisionFn(this._collisions[s],n);
}}var u;var p;var t;for(var o=0;o<w;o++){p=false;for(var s=0,x=this._collisions.length;s<x;s++){v=this._collisions[s];if(!v.satisfied){if(y){u=this.processContactFn(v,n);p=p||u;}else{u=this.processCollisionFn(v,n);p=p||u;}}}for(var s=0,x=this._constraints.length;s<x;s++){var r=this._constraints[s];if(!r.get_satisfied()){u=r.apply(n);p=p||u;}}this.tryToActivateAllFrozenObjects();if(y){t=this._collisions.length;for(var q=z;q<t;q++){this._collisions[q].mat.set_restitution(0);this._collisions[q].satisfied=false;this.preProcessContactFn(this._collisions[q],n);}}else{t=this._collisions.length;for(q=z;q<t;q++){this.preProcessCollisionFn(this._collisions[q],n);}}z=this._collisions.length;if(!p){break;}}};f.prototype.handleAllEffects=function(){var o;var n=this._effects.length-1;if(n<0){return;}do{o=this._effects[n];if(o.enabled){o.Apply();}}while(n--);};f.prototype.activateObject=function(p){if(!p.get_movable()||p.isActive){return;}p.setActive();this._activeBodies.push(p);var r=this._collisions.length;this._collisionSystem.detectCollisions(p,this._collisions);var o;var s;for(var q=r,n=this._collisions.length;q<n;q++){o=this._collisions[q].objInfo.body0;s=this._collisions[q].dirToBody;if(o==p){o=this._collisions[q].objInfo.body1;s=b.getScaleVector(this._collisions[q].dirToBody,-1);}if(!o.isActive&&l.dotProduct(o.get_force(),s)<-b.NUM_TINY){this.activateObject(o);}}};f.prototype.dampAllActiveBodies=function(){for(var n=0,o=this._activeBodies.length;n<o;n++){_activeBody=this._activeBodies[n];_activeBody.dampForDeactivation();}};f.prototype.tryToActivateAllFrozenObjects=function(){for(var n=0,p=this._bodies.length;n<p;n++){var o=this._bodies[n];if(!o.isActive){if(o.getShouldBeActive()){this.activateObject(o);}else{if(o.getVelChanged()){o.setVelocity([0,0,0,0]);o.setAngVel([0,0,0,0]);o.clearVelChanged();}}}}};f.prototype.activateAllFrozenObjectsLeftHanging=function(){var n;for(var p=0,s=this._bodies.length;p<s;p++){var r=this._bodies[p];if(r.isActive){r.doMovementActivations();if(r.collisions.length>0){for(var o=0,q=r.collisions.length;o<q;o++){n=r.collisions[o].objInfo.body0;if(n==r){n=r.collisions[o].objInfo.body1;}if(!n.isActive){r.addMovementActivation(r.get_currentState().position,n);}}}}}};f.prototype.updateAllVelocities=function(o){for(var n=0,p=this._activeBodies.length;n<p;n++){_activeBody=this._activeBodies[n];_activeBody.updateVelocity(o);}};f.prototype.updateAllPositions=function(o){for(var n=0,p=this._activeBodies.length;n<p;n++){_activeBody=this._activeBodies[n];_activeBody.updatePositionWithAux(o);}};f.prototype.notifyAllPostPhysics=function(o){for(var n=0,p=this._bodies.length;n<p;n++){_body=this._bodies[n];_body.postPhysics(o);}};f.prototype.updateAllObject3D=function(){for(var n=0,o=this._bodies.length;n<o;n++){_body=this._bodies[n];_body.updateObject3D();}};f.prototype.limitAllVelocities=function(){for(var n=0,o=this._activeBodies.length;n<o;n++){_activeBody=this._activeBodies[n];_activeBody.limitVel();_activeBody.limitAngVel();}};f.prototype.tryToFreezeAllObjects=function(o){for(var n=0,p=this._activeBodies.length;n<p;n++){_activeBody=this._activeBodies[n];_activeBody.tryToFreeze(o);}};f.prototype.detectAllCollisions=function(o){for(var n=0,p=this._activeBodies.length;n<p;n++){_activeBody=this._activeBodies[n];_activeBody.storeState();}this.updateAllVelocities(o);this.updateAllPositions(o);for(var n=0,q=this._bodies.length;n<q;n++){_body=this._bodies[n];_body.collisions=[];}this._collisions=[];this._collisionSystem.detectAllCollisions(this._activeBodies,this._collisions);for(var n=0,p=this._activeBodies.length;n<p;n++){_activeBody=this._activeBodies[n];_activeBody.restoreState();}};f.prototype.copyAllCurrentStatesToOld=function(){for(var n=0,o=this._bodies.length;n<o;n++){_body=this._bodies[n];if(_body.isActive||_body.getVelChanged()){_body.copyCurrentStateToOld();}}};f.prototype.findAllActiveBodies=function(){this._activeBodies=[];for(var n=0,p=this._bodies.length;n<p;n++){var o=this._bodies[n];if(o.isActive){this._activeBodies.push(o);}}};f.prototype.integrate=function(o){this._doingIntegration=true;this.findAllActiveBodies();this.copyAllCurrentStatesToOld();this.getAllExternalForces(o);this.handleAllEffects();this.detectAllCollisions(o);this.handleAllConstraints(o,h.numCollisionIterations,false);this.updateAllVelocities(o);this.handleAllConstraints(o,h.numContactIterations,true);if(h.doShockStep){this.doShockStep(o);}this.dampAllActiveBodies();this.tryToFreezeAllObjects(o);this.activateAllFrozenObjectsLeftHanging();this.limitAllVelocities();this.updateAllPositions(o);this.notifyAllPostPhysics(o);this.updateAllObject3D();if(h.solverType=="ACCUMULATED"){this.updateContactCache();}for(var n=0,p=this._bodies.length;n<p;n++){_body=this._bodies[n];_body.clearForces();}this._doingIntegration=false;};d.PhysicsSystem=f;})(jigLib);