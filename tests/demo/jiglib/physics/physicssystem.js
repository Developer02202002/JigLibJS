(function(d){var k=d.Vector3DUtil;var i=d.JConfig;var j=d.CollPointInfo;var e=d.CollisionSystemBrute;var l=d.CollisionSystemGrid;var h=d.ContactData;var f=d.JMatrix3D;var b=d.JNumber3D;var c=d.BodyPair;var a=d.CachedImpulse;var g=function(){this.setSolverType(i.solverType);this._doingIntegration=false;this._bodies=[];this._collisions=[];this._effects=[];this._activeBodies=[];this._constraints=[];this._controllers=[];this._cachedContacts=[];this._collisionSystem=new e();this.setGravity(b.getScaleVector(k.Y_AXIS,-10));};g.prototype._currentPhysicsSystem=null;g.prototype._maxVelMag=0.5;g.prototype._minVelForProcessing=0.001;g.prototype._bodies=null;g.prototype._activeBodies=null;g.prototype._collisions=null;g.prototype._constraints=null;g.prototype._controllers=null;g.prototype._effects=null;g.prototype._gravityAxis=null;g.prototype._gravity=null;g.prototype._doingIntegration=null;g.prototype.preProcessCollisionFn=function(){};g.prototype.preProcessContactFn=function(){};g.prototype.processCollisionFn=function(){};g.prototype.processContactFn=function(){};g.prototype._cachedContacts=null;g.prototype._collisionSystem=null;g.getInstance=function(){if(!g._currentPhysicsSystem){g._currentPhysicsSystem=new g();}return g._currentPhysicsSystem;};g.prototype.getAllExternalForces=function(o){for(var n=0,p=this._bodies.length;n<p;n++){this._bodies[n].addExternalForces(o);}for(var n=0,m=this._controllers.length;n<m;n++){this._controllers[n].updateController(o);}};g.prototype.etCollisionSystem=function(p,s,r,q,o,n,m,v,u,t){if(!s){s=0;}if(!r){r=0;}if(!q){q=0;}if(o==undefined){o=20;}if(n==undefined){n=20;}if(m==undefined){m=20;}if(v==undefined){v=200;}if(u==undefined){u=200;}if(t==undefined){t=200;}if(p){this._collisionSystem=new l(s,r,q,o,n,m,v,u,t);}else{this._collisionSystem=new e();}};g.prototype.getCollisionSystem=function(){return this._collisionSystem;};g.prototype.setGravity=function(m){this._gravity=m;if(this._gravity[0]==this._gravity[1]&&this._gravity[1]==this._gravity[2]){this._gravityAxis=-1;}this._gravityAxis=0;if(Math.abs(this._gravity[1])>Math.abs(this._gravity[2])){this._gravityAxis=1;}if(Math.abs(this._gravity[2])>Math.abs(this._gravity[this._gravityAxis])){this._gravityAxis=2;}};g.prototype.get_gravity=function(){return this._gravity;};g.prototype.get_gravityAxis=function(){return this._gravityAxis;};g.prototype.get_bodies=function(){return this._bodies;};g.prototype.addBody=function(m){if(!this.findBody(m)){this._bodies.push(m);this._collisionSystem.addCollisionBody(m);}};g.prototype.removeBody=function(m){if(this.findBody(m)){this._bodies.splice(this._bodies.indexOf(m),1);this._collisionSystem.removeCollisionBody(m);}};g.prototype.removeAllBodies=function(){this._bodies=[];this._collisionSystem.removeAllCollisionBodies();};g.prototype.addConstraint=function(m){if(!this.findConstraint(m)){this._constraints.push(m);}};g.prototype.removeConstraint=function(m){if(this.findConstraint(m)){this._constraints.splice(this._constraints.indexOf(m),1);}};g.prototype.removeAllConstraints=function(){this._constraints=[];};g.prototype.addEffect=function(m){if(!this.findEffect(m)){this._effects.push(m);}};g.prototype.removeEffect=function(m){if(this.findEffect(m)){this._effects.splice(this._effects.indexOf(m),1);}};g.prototype.removeAllEffects=function(){this._effects=[];};g.prototype.addController=function(m){if(!this.findController(m)){this._controllers.push(m);}};g.prototype.removeController=function(m){if(this.findController(m)){this._controllers.splice(this._controllers.indexOf(m),1);}};g.prototype.removeAllControllers=function(){this._controllers=[];};g.prototype.setSolverType=function(m){switch(m){case"FAST":this.preProcessCollisionFn=this.preProcessCollisionFast;this.preProcessContactFn=this.preProcessCollisionFast;this.processCollisionFn=this.processCollision;this.processContactFn=this.processCollision;return;case"NORMAL":this.preProcessCollisionFn=this.preProcessCollisionNormal;this.preProcessContactFn=this.preProcessCollisionNormal;this.processCollisionFn=this.processCollision;this.processContactFn=this.processCollision;return;case"ACCUMULATED":this.preProcessCollisionFn=this.preProcessCollisionAccumulated;this.preProcessContactFn=this.preProcessCollisionAccumulated;this.processCollisionFn=this.processCollision;this.processContactFn=this.processCollisionAccumulated;return;default:this.preProcessCollisionFn=this.preProcessCollisionNormal;this.preProcessContactFn=this.preProcessCollisionNormal;this.processCollisionFn=this.processCollision;this.processContactFn=this.processCollision;return;}};g.prototype.findBody=function(m){var n=this._bodies.length-1;if(n>0){do{if(m==this._bodies[n]){return true;}}while(n--);}return false;};g.prototype.findConstraint=function(n){var m=this._constraints.length-1;if(m>0){do{if(n==this._constraints[m]){return true;}}while(m--);}return false;};g.prototype.findEffect=function(n){var m=this._effects.length-1;if(m>0){do{if(n==this._effects[m]){return true;}}while(m--);}return false;};g.prototype.findController=function(m){var n=this._controllers.length-1;if(n>0){do{if(m==this._controllers[n]){return true;}}while(n--);}return false;};g.prototype.preProcessCollisionFast=function(y,o){y.satisfied=false;var n=y.objInfo.body0;var m=y.objInfo.body1;var t=y.dirToBody;var A=i.numPenetrationRelaxationTimesteps*o;var x=0;var z;var r;var q=y.pointInfo.length;var s=b.NUM_TINY;if(q>1){var w=[0,0,0,0];var u=[0,0,0,0];var C=0;for(var p=0;p<q;p++){z=y.pointInfo[p];w=k.add(w,z.r0);u=k.add(u,z.r1);C+=z.initialPenetration;}w=b.getDivideVector(w,q);u=b.getDivideVector(u,q);C/=q;var B=new j();B.r0=w;B.r1=u;B.initialPenetration=C;y.pointInfo=[B];}z=y.pointInfo[0];if(!n.get_movable()){z.denominator=0;}else{r=k.crossProduct(z.r0,t);f.multiplyVector(n.get_worldInvInertia(),r);z.denominator=n.get_invMass()+k.dotProduct(t,k.crossProduct(r,z.r0));}if(m.get_movable()){r=k.crossProduct(z.r1,t);f.multiplyVector(m.get_worldInvInertia(),r);z.denominator+=(m.get_invMass()+k.dotProduct(t,k.crossProduct(r,z.r1)));}if(z.denominator<s){z.denominator=s;}if(z.initialPenetration>i.allowedPenetration){z.minSeparationVel=(z.initialPenetration-i.allowedPenetration)/A;}else{x=-0.1*(z.initialPenetration-i.allowedPenetration)/i.allowedPenetration;if(x<s){x=s;}else{if(x>1){x=1;}}var v=(o>s)?o:s;z.minSeparationVel=x*(z.initialPenetration-i.allowedPenetration)/v;}if(z.minSeparationVel>this._maxVelMag){z.minSeparationVel=this._maxVelMag;}};g.prototype.preProcessCollisionNormal=function(v,o){v.satisfied=false;var n=v.objInfo.body0;var m=v.objInfo.body1;var s=v.dirToBody;var x=i.numPenetrationRelaxationTimesteps*o;var u=0;var w;var r;var q=v.pointInfo.length;for(var p=0;p<q;p++){w=v.pointInfo[p];if(!n.get_movable()){w.denominator=0;}else{r=k.crossProduct(w.r0,s);f.multiplyVector(n.get_worldInvInertia(),r);w.denominator=n.get_invMass()+k.dotProduct(s,k.crossProduct(r,w.r0));}if(m.get_movable()){r=k.crossProduct(w.r1,s);f.multiplyVector(m.get_worldInvInertia(),r);w.denominator+=(m.get_invMass()+k.dotProduct(s,k.crossProduct(r,w.r1)));}if(w.denominator<b.NUM_TINY){w.denominator=b.NUM_TINY;}if(w.initialPenetration>i.allowedPenetration){w.minSeparationVel=(w.initialPenetration-i.allowedPenetration)/x;}else{u=-0.1*(w.initialPenetration-i.allowedPenetration)/i.allowedPenetration;if(u<b.NUM_TINY){u=b.NUM_TINY;}else{if(u>1){u=1;}}var t=(o>b.NUM_TINY)?o:b.NUM_TINY;w.minSeparationVel=u*(w.initialPenetration-i.allowedPenetration)/t;}if(w.minSeparationVel>this._maxVelMag){w.minSeparationVel=this._maxVelMag;}}};g.prototype.preProcessCollisionAccumulated=function(r,z){r.satisfied=false;var y=r.objInfo.body0;var w=r.objInfo.body1;var s=r.dirToBody;var x=i.numPenetrationRelaxationTimesteps*z;var q;var u;var I;var F=0;var G=b.NUM_TINY;var v=i.allowedPenetration;var E=r.pointInfo.length;for(var D=0;D<E;D++){u=r.pointInfo[D];I=u.initialPenetration-v;if(!y.get_movable()){u.denominator=0;}else{q=k.crossProduct(u.r0,s);f.multiplyVector(y.get_worldInvInertia(),q);u.denominator=y.get_invMass()+k.dotProduct(s,k.crossProduct(q,u.r0));}if(w.get_movable()){q=k.crossProduct(u.r1,s);f.multiplyVector(w.get_worldInvInertia(),q);u.denominator+=(w.get_invMass()+k.dotProduct(s,k.crossProduct(q,u.r1)));}if(u.denominator<G){u.denominator=G;}if(u.initialPenetration>v){u.minSeparationVel=I/x;}else{F=-0.1*I/v;if(F<G){F=G;}else{if(F>1){F=1;}}var C=(z>G)?z:G;u.minSeparationVel=F*I/C;}u.accumulatedNormalImpulse=0;u.accumulatedNormalImpulseAux=0;u.accumulatedFrictionImpulse=[0,0,0,0];var p=0.04;var H=new c(y,w,[0,0,0,0],[0,0,0,0]);for(var B=0,o=this._cachedContacts.length;B<o;B++){var m=this._cachedContacts[B];var A=m.pair;if(H.body0!=A.body0||H.body1==A.body1){continue;}var n=(A.body0==y)?k.get_lengthSquared(k.subtract(A.r,u.r0)):k.get_lengthSquared(k.subtract(A.r,u.r1));if(n<p){p=n;u.accumulatedNormalImpulse=this._cachedContacts[B].impulse.normalImpulse;u.accumulatedNormalImpulseAux=this._cachedContacts[B].impulse.normalImpulseAux;u.accumulatedFrictionImpulse=this._cachedContacts[B].impulse.frictionImpulse;if(this._cachedContacts[B].pair.body0!=y){u.accumulatedFrictionImpulse=b.getScaleVector(u.accumulatedFrictionImpulse,-1);}}}var t;if(u.accumulatedNormalImpulse!=0){t=b.getScaleVector(s,u.accumulatedNormalImpulse);t=k.add(t,u.accumulatedFrictionImpulse);y.applyBodyWorldImpulse(t,u.r0);w.applyBodyWorldImpulse(b.getScaleVector(t,-1),u.r1);}if(u.accumulatedNormalImpulseAux!=0){t=b.getScaleVector(s,u.accumulatedNormalImpulseAux);y.applyBodyWorldImpulseAux(t,u.r0);w.applyBodyWorldImpulseAux(b.getScaleVector(t,-1),u.r1);}}};g.prototype.processCollision=function(s,F){s.satisfied=true;var C=s.objInfo.body0;var B=s.objInfo.body1;var w=false;var u=s.dirToBody;var I=0;var J=0;var o=0;var E=0;var y;var v;var t;var z;var A=[0,0,0,0];var H=s.pointInfo.length;for(var G=0;G<H;G++){z=s.pointInfo[G];v=C.getVelocity(z.r0);t=B.getVelocity(z.r1);J=k.dotProduct(k.subtract(v,t),u);if(J>z.minSeparationVel){continue;}o=-1*s.mat.get_restitution()*J;if(o<this._minVelForProcessing){o=z.minSeparationVel;}I=o-J;if(I<=this._minVelForProcessing){continue;}E=I/z.denominator;w=true;y=b.getScaleVector(u,E);A=k.add(A,y);C.applyBodyWorldImpulse(y,z.r0);B.applyBodyWorldImpulse(b.getScaleVector(y,-1),z.r1);var q;var D=v.slice(0);if(B.get_movable()){D=k.subtract(v,t);}var r=k.subtract(D,b.getScaleVector(u,k.dotProduct(D,u)));var x=k.get_length(r);if(x>this._minVelForProcessing){var p=b.getDivideVector(r,-x);var m=0;if(C.get_movable()){q=k.crossProduct(z.r0,p);f.multiplyVector(C.get_worldInvInertia(),q);m=C.get_invMass()+k.dotProduct(p,k.crossProduct(q,z.r0));}if(B.get_movable()){q=k.crossProduct(z.r1,p);f.multiplyVector(B.get_worldInvInertia(),q);m+=(B.get_invMass()+k.dotProduct(p,k.crossProduct(q,z.r1)));}if(m>b.NUM_TINY){var n=x/m;p=b.getScaleVector(p,n);C.applyBodyWorldImpulse(p,z.r0);B.applyBodyWorldImpulse(b.getScaleVector(p,-1),z.r1);}}}if(w){C.setConstraintsAndCollisionsUnsatisfied();B.setConstraintsAndCollisionsUnsatisfied();C.dispatchEvent(new JCollisionEvent(B,A));B.dispatchEvent(new JCollisionEvent(C,b.getScaleVector(A,-1)));}return w;};g.prototype.processCollisionAccumulated=function(s,K){s.satisfied=true;var x=false;var v=s.dirToBody;var H=s.objInfo.body0;var G=s.objInfo.body1;var Q=0;var S=0;var J=0;var A;var w;var u;var B;var C=[0,0,0,0];var P=s.pointInfo.length;for(var M=0;M<P;M++){B=s.pointInfo[M];w=H.getVelocity(B.r0);u=G.getVelocity(B.r1);S=k.dotProduct(k.subtract(w,u),v);Q=-S;if(B.minSeparationVel<0){Q+=B.minSeparationVel;}if(Math.abs(Q)>this._minVelForProcessing){J=Q/B.denominator;var E=B.accumulatedNormalImpulse;var L=(E+J);if(L<0){L=0;}B.accumulatedNormalImpulse=L;var t=L-E;A=b.getScaleVector(v,t);C=k.add(C,A);H.applyBodyWorldImpulse(A,B.r0);G.applyBodyWorldImpulse(b.getScaleVector(A,-1),B.r1);x=true;}w=H.getVelocityAux(B.r0);u=G.getVelocityAux(B.r1);S=k.dotProduct(k.subtract(w,u),v);Q=-S;if(B.minSeparationVel>0){Q+=B.minSeparationVel;}if(Math.abs(Q)>this._minVelForProcessing){J=Q/B.denominator;E=B.accumulatedNormalImpulseAux;var F=B.accumulatedNormalImpulseAux+J;if(F<0){F=0;}B.accumulatedNormalImpulseAux=F;t=F-E;A=b.getScaleVector(v,t);H.applyBodyWorldImpulseAux(A,B.r0);G.applyBodyWorldImpulseAux(b.getScaleVector(A,-1),B.r1);x=true;}if(B.accumulatedNormalImpulse>0){w=H.getVelocity(B.r0);u=G.getVelocity(B.r1);var q;var I=k.subtract(w,u);var r=k.subtract(I,b.getScaleVector(v,k.dotProduct(I,v)));var z=k.get_length(r);if(z>this._minVelForProcessing){var p=b.getScaleVector(b.getDivideVector(r,z),-1);var n=0;if(H.get_movable()){q=k.crossProduct(B.r0,p);f.multiplyVector(H.get_worldInvInertia(),q);n=H.invMass+k.dotProduct(p,k.crossProduct(q,B.r0));}if(G.get_movable()){q=k.crossProduct(B.r1,p);f.multiplyVector(G.get_worldInvInertia(),q);n+=(G.invMass+k.dotProduct(p,k.crossProduct(q,B.r1)));}if(n>b.NUM_TINY){var o=z/n;var m=b.getScaleVector(p,o);var R=B.accumulatedFrictionImpulse.slice(0);B.accumulatedFrictionImpulse=k.add(B.accumulatedFrictionImpulse,m);var O=k.get_length(B.accumulatedFrictionImpulse);var D=s.mat.friction*B.accumulatedNormalImpulse;if(O>b.NUM_TINY&&O>D){B.accumulatedFrictionImpulse=b.getScaleVector(B.accumulatedFrictionImpulse,D/O);}var y=k.subtract(B.accumulatedFrictionImpulse,R);H.applyBodyWorldImpulse(y,B.r0);G.applyBodyWorldImpulse(b.getScaleVector(y,-1),B.r1);}}}}if(x){H.setConstraintsAndCollisionsUnsatisfied();G.setConstraintsAndCollisionsUnsatisfied();H.dispatchEvent(new JCollisionEvent(G,C));G.dispatchEvent(new JCollisionEvent(H,b.getScaleVector(C,-1)));}return x;};g.prototype.sortPositionX=function(n,m){if(n.get_currentState().position[0]<m.get_currentState().position[0]){return -1;}else{if(n.get_currentState().position[0]>m.get_currentState().position[0]){return 1;}else{return 0;}}};g.prototype.sortPositionY=function(n,m){if(n.get_currentState().position[1]<m.get_currentState().position[1]){return -1;}else{if(n.get_currentState().position[1]>m.get_currentState().position[1]){return 1;}else{return 0;}}};g.prototype.sortPositionZ=function(n,m){if(n.get_currentState().position[2]<m.get_currentState().position[2]){return -1;}else{if(n.get_currentState().position[2]>m.get_currentState().position[2]){return 1;}else{return 0;}}};g.prototype.doShockStep=function(p){if(Math.abs(this._gravity[0])>Math.abs(this._gravity[1])&&Math.abs(this._gravity[0])>Math.abs(this._gravity[2])){this._bodies=this._bodies.sort(this.sortPositionX);this._collisionSystem.collBody=this._collisionSystem.collBody.sort(this.sortPositionX);}else{if(Math.abs(this._gravity[1])>Math.abs(this._gravity[2])&&Math.abs(this._gravity[1])>Math.abs(this._gravity[0])){this._bodies=this._bodies.sort(this.sortPositionY);this._collisionSystem.collBody=this._collisionSystem.collBody.sort(this.sortPositionY);}else{if(Math.abs(this._gravity[2])>Math.abs(this._gravity[0])&&Math.abs(this._gravity[2])>Math.abs(this._gravity[1])){this._bodies=this._bodies.sort(this.sortPositionZ);this._collisionSystem.collBody=this._collisionSystem.collBody.sort(this.sortPositionZ);}}}var q;var m;var r=true;var s=[];var o;var n;while(r){r=false;for(var u=0;u<this._bodies.length;u++){var v=this._bodies[u];if(v.get_movable()&&v.get_doShockProcessing()){if(v.collisions.length==0||!v.isActive){v.internalSetImmovable();}else{m=false;s=v.collisions;for(var t=0;t<s.length;t++){q=s[t];o=q.objInfo.body0;n=q.objInfo.body1;if((o==v&&!n.get_movable())||(n==v&&!o.get_movable())){this.preProcessCollisionFast(q,p);this.processCollision(q,p);m=true;}}if(m){v.internalSetImmovable();r=true;}}}}}for(var u=0;u<this._bodies.length;u++){v=this._bodies[u];v.internalRestoreImmovable();s=v.collisions;for(var t=0;t<s.length;t++){q=s[t];this.preProcessCollisionFn(q,p);this.processCollisionFn(q,p);}}};g.prototype.updateContactCache=function(){this._cachedContacts=[];var r;var t;var m;for(var p=0,n=this._collisions.length;p<n;p++){var s=this._collisions[p];for(var o=0,q=s.pointInfo.length;o<q;o++){r=s.pointInfo[o];t=(s.objInfo.body0.id>s.objInfo.body1.id)?r.accumulatedFrictionImpulse:b.getScaleVector(r.accumulatedFrictionImpulse,-1);m=new h();m.pair=new c(s.objInfo.body0,s.objInfo.body1,r.r0,r.r1);
m.impulse=new a(r.accumulatedNormalImpulse,r.accumulatedNormalImpulseAux,r.accumulatedFrictionImpulse);this._cachedContacts.push(m);}}};g.prototype.handleAllConstraints=function(m,v,x){var y=this._collisions.length;var u;var q;for(var r=0,w=this._constraints.length;r<w;r++){this._constraints[r].preApply(m);}if(x){for(var r=0,w=this._collisions.length;r<w;r++){this.preProcessContactFn(this._collisions[r],m);this._collisions[r].mat.set_restitution(0);this._collisions[r].satisfied=false;}}else{for(var r=0,w=this._collisions.length;r<w;r++){this.preProcessCollisionFn(this._collisions[r],m);}}var t;var o;var s;for(var n=0;n<v;n++){o=false;for(var r=0,w=this._collisions.length;r<w;r++){u=this._collisions[r];if(!u.satisfied){if(x){t=this.processContactFn(u,m);o=o||t;}else{t=this.processCollisionFn(u,m);o=o||t;}}}for(var r=0,w=this._constraints.length;r<w;r++){var q=this._constraints[r];if(!q.get_satisfied()){t=q.apply(m);o=o||t;}}this.tryToActivateAllFrozenObjects();if(x){s=this._collisions.length;for(var p=y;p<s;p++){this._collisions[p].mat.set_restitution(0);this._collisions[p].satisfied=false;this.preProcessContactFn(this._collisions[p],m);}}else{s=this._collisions.length;for(p=y;p<s;p++){this.preProcessCollisionFn(this._collisions[p],m);}}y=this._collisions.length;if(!o){break;}}};g.prototype.handleAllEffects=function(){var n;var m=this._effects.length-1;if(m<0){return;}do{n=this._effects[m];if(n.enabled){n.Apply();}}while(m--);};g.prototype.activateObject=function(o){if(!o.get_movable()||o.isActive){return;}o.setActive();this._activeBodies.push(o);var q=this._collisions.length;this._collisionSystem.detectCollisions(o,this._collisions);var n;var r;for(var p=q,m=this._collisions.length;p<m;p++){n=this._collisions[p].objInfo.body0;r=this._collisions[p].dirToBody;if(n==o){n=this._collisions[p].objInfo.body1;r=b.getScaleVector(this._collisions[p].dirToBody,-1);}if(!n.isActive&&k.dotProduct(n.get_force(),r)<-b.NUM_TINY){this.activateObject(n);}}};g.prototype.dampAllActiveBodies=function(){for(var m=0,n=this._activeBodies.length;m<n;m++){_activeBody=this._activeBodies[m];_activeBody.dampForDeactivation();}};g.prototype.tryToActivateAllFrozenObjects=function(){for(var m=0,o=this._bodies.length;m<o;m++){var n=this._bodies[m];if(!n.isActive){if(n.getShouldBeActive()){this.activateObject(n);}else{if(n.getVelChanged()){n.setVelocity([0,0,0,0]);n.setAngVel([0,0,0,0]);n.clearVelChanged();}}}}};g.prototype.activateAllFrozenObjectsLeftHanging=function(){var m;for(var o=0,r=this._bodies.length;o<r;o++){var q=this._bodies[o];if(q.isActive){q.doMovementActivations();if(q.collisions.length>0){for(var n=0,p=q.collisions.length;n<p;n++){m=q.collisions[n].objInfo.body0;if(m==q){m=q.collisions[n].objInfo.body1;}if(!m.isActive){q.addMovementActivation(q.get_currentState().position,m);}}}}}};g.prototype.updateAllVelocities=function(n){for(var m=0,o=this._activeBodies.length;m<o;m++){_activeBody=this._activeBodies[m];_activeBody.updateVelocity(n);}};g.prototype.updateAllPositions=function(n){for(var m=0,o=this._activeBodies.length;m<o;m++){_activeBody=this._activeBodies[m];_activeBody.updatePositionWithAux(n);}};g.prototype.notifyAllPostPhysics=function(n){for(var m=0,o=this._bodies.length;m<o;m++){_body=this._bodies[m];_body.postPhysics(n);}};g.prototype.updateAllObject3D=function(){for(var m=0,n=this._bodies.length;m<n;m++){_body=this._bodies[m];_body.updateObject3D();}};g.prototype.limitAllVelocities=function(){for(var m=0,n=this._activeBodies.length;m<n;m++){_activeBody=this._activeBodies[m];_activeBody.limitVel();_activeBody.limitAngVel();}};g.prototype.tryToFreezeAllObjects=function(n){for(var m=0,o=this._activeBodies.length;m<o;m++){_activeBody=this._activeBodies[m];_activeBody.tryToFreeze(n);}};g.prototype.detectAllCollisions=function(n){for(var m=0,o=this._activeBodies.length;m<o;m++){_activeBody=this._activeBodies[m];_activeBody.storeState();}this.updateAllVelocities(n);this.updateAllPositions(n);for(var m=0,p=this._bodies.length;m<p;m++){_body=this._bodies[m];_body.collisions=[];}this._collisions=[];this._collisionSystem.detectAllCollisions(this._activeBodies,this._collisions);for(var m=0,o=this._activeBodies.length;m<o;m++){_activeBody=this._activeBodies[m];_activeBody.restoreState();}};g.prototype.copyAllCurrentStatesToOld=function(){for(var m=0,n=this._bodies.length;m<n;m++){_body=this._bodies[m];if(_body.isActive||_body.getVelChanged()){_body.copyCurrentStateToOld();}}};g.prototype.findAllActiveBodies=function(){this._activeBodies=[];for(var m=0,o=this._bodies.length;m<o;m++){var n=this._bodies[m];if(n.isActive){this._activeBodies.push(n);}}};g.prototype.integrate=function(n){this._doingIntegration=true;this.findAllActiveBodies();this.copyAllCurrentStatesToOld();this.getAllExternalForces(n);this.handleAllEffects();this.detectAllCollisions(n);this.handleAllConstraints(n,i.numCollisionIterations,false);this.updateAllVelocities(n);this.handleAllConstraints(n,i.numContactIterations,true);if(i.doShockStep){this.doShockStep(n);}this.dampAllActiveBodies();this.tryToFreezeAllObjects(n);this.activateAllFrozenObjectsLeftHanging();this.limitAllVelocities();this.updateAllPositions(n);this.notifyAllPostPhysics(n);this.updateAllObject3D();if(i.solverType=="ACCUMULATED"){this.updateContactCache();}for(var m=0,o=this._bodies.length;m<o;m++){_body=this._bodies[m];_body.clearForces();}this._doingIntegration=false;};d.PhysicsSystem=g;})(jigLib);