(function(c){var g=c.Vector3DUtil;var e=c.CollOutBodyData;var f=c.JAABox;var h=c.JSegment;var i=c.JMath3D;var a=c.JNumber3D;var j=c.RigidBody;var b=c.CollisionSystemGridEntry;var d=c.CollDetectInfo;var k=function(p,o,n,t,s,r){this.Super();this.nx=p;this.ny=o;this.nz=n;this.dx=t;this.dy=s;this.dz=r;this.sizeX=p*t;this.sizeY=o*s;this.sizeZ=n*r;this.minDelta=Math.min(t,s,r);this.gridEntries=[];var q=gridEntries.length;for(var m=0;m<q;++m){var l=new b(null);l.gridIndex=m;gridEntries[m]=l;}this.overflowEntries=new b(null);this.overflowEntries.gridIndex=-1;};c.extend(k,c.CollisionSystemAbstract);k.prototype.gridEntries=null;k.prototype.overflowEntries=null;k.prototype.nx=0;k.prototype.ny=0;k.prototype.nz=0;k.prototype.dx=0;k.prototype.dy=0;k.prototype.dz=0;k.prototype.sizeX=0;k.prototype.sizeY=0;k.prototype.sizeZ=0;k.prototype.minDelta=0;k.prototype.calcIndex=function(n,m,l){var q=n%nx;var p=m%ny;var o=l%nz;return(q+nx*p+(nx+ny)*o);};k.prototype.calcGridForSkin3=function(m){var p;var n;var l;var q=m.get_boundingBox().get_sideLengths();if((q[0]>dx)||(q[1]>dy)||(q[2]>dz)){p=n=l=-1;return new [p,n,l];}var o=m.get_boundingBox().get_minPos();o[0]=i.wrap(o[0],0,sizeX);o[1]=i.wrap(o[1],0,sizeY);o[2]=i.wrap(o[2],0,sizeZ);p=parseInt((o[0]/dx)%nx);n=parseInt((o[1]/dy)%ny);l=parseInt((o[2]/dz)%nz);return[p,n,l];};k.prototype.calcGridForSkin6=function(m){var r={};var q;var p;var n;var u;var t;var s;var l=m.get_boundingBox().get_sideLengths();if((l[0]>dx)||(l[1]>dy)||(l[2]>dz)){q=p=n=-1;u=t=s=0;r.i=q;r.j=p;r.k=n;r.fi=u;r.fj=t;r.fk=s;return r;}var o=m.get_boundingBox().get_minPos();o[0]=i.wrap(o[0],0,sizeX);o[1]=i.wrap(o[1],0,sizeY);o[2]=i.wrap(o[2],0,sizeZ);u=o[0]/dx;t=o[1]/dy;s=o[2]/dz;q=u;p=t;n=s;if(q<0){q=0;u=0;}else{if(q>=nx){q=0;u=0;}else{u-=q;}}if(p<0){p=0;t=0;}else{if(p>=ny){p=0;t=0;}else{t-=p;}}if(n<0){n=0;s=0;}else{if(n>=nz){n=0;s=0;}else{s-=n;}}r.i=q;r.j=p;r.k=n;r.fi=u;r.fj=t;r.fk=s;return r;};k.prototype.calcGridIndexForBody=function(m){var l=this.calcGridForSkin3(m);if(l.x==-1){return -1;}return this.calcIndex(l[0],l[1],l[2]);};k.prototype.addCollisionBody=function(l){if(!this.findBody(l)){this.collBody.push(l);}l.collisionSystem=this;var m=new b(l);l.externalData=m;b.insertGridEntryAfter(m,this.overflowEntries);this.collisionSkinMoved(l);};k.prototype.removeCollisionBody=function(l){if(l.externalData!=null){l.externalData.collisionBody=null;b.removeGridEntry(l.externalData);l.externalData=null;}if(this.findBody(l)){this.collBody.splice(this.collBody.indexOf(l),1);}};k.prototype.removeAllCollisionBodies=function(){for(var m=0;m<this.collBody.length;m++){var l=this.collBody[m];if(l.externalData!=null){l.externalData.collisionBody=null;b.removeGridEntry(l.externalData);}}collBody=[];};k.prototype.collisionSkinMoved=function(l){var n=l.externalData;if(n==null){return;}var m=this.calcGridIndexForBody(l);if(m==n.gridIndex){return;}var o;if(gridEntries.length-1>m&&m>=0){o=gridEntries[m];}else{o=overflowEntries;}b.removeGridEntry(n);b.insertGridEntryAfter(n,o);};k.prototype.getListsToCheck=function(l){var u=[];var m=l.externalData;if(m==null){return null;}var z;var x;var w;var t;var s;var r;var C=this.calcGridForSkin6(l);z=C.i;x=C.j;w=C.k;t=C.fi;s=C.fj;r=C.fk;if(z==-1){u=this.gridEntries.concat();u.push(this.overflowEntries);return u;}u.push(this.overflowEntries);var D=l.get_boundingBox().get_sideLengths();var p=1,o=1,n=1;if(t+(D.x/dx)<1){p=0;}if(s+(D.y/dy)<1){o=0;}if(r+(D.z/dz)<1){n=0;}for(var B=-1;B<=p;++B){for(var A=-1;A<=o;++A){for(var y=-1;y<=n;++y){var v=this.calcIndex(nx+z+B,ny+x+A,nz+w+y);if(this.gridEntries.length-1>v&&v>=0){var q=this.gridEntries[v];if(q!=null&&q.next!=null){u.push(q);}}}}}return u;};k.prototype.detectAllCollisions=function(l,s){var m;var q;var n;var t;this._numCollisionsChecks=0;for(var p=0;p<l.length;p++){var r=l[p];if(!r.isActive){continue;}n=r.id;t=r.type;var v=this.getListsToCheck(r);for(var o=0;o<v.length;o++){var u=v[o];for(u=u.next;u!=null;u=u.next){if(r==u.collisionBody){continue;}if(u.collisionBody&&u.collisionBody.isActive&&n>u.collisionBody.id){continue;}if(this.checkCollidables(r,u.collisionBody)&&this.detectionFunctors[t+"_"+u.collisionBody.type]!=undefined){m=new d();m.body0=r;m.body1=u.collisionBody;q=this.detectionFunctors[m.body0.type+"_"+m.body1.type];q.collDetect(m,s);this._numCollisionsChecks+=1;}}}}};c.CollisionSystemGrid=k;})(jigLib);