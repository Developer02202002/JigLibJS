jigLib={};jigLib.extend=function(a,b){for(proto in b.prototype){a.prototype[proto]=b.prototype[proto];}a.prototype.Super=b;};(function(a){a.JConfig={solverType:"ACCUMULATED",boxCollisionsType:"EDGEBASE",rotationType:"DEGREES",aabbDetection:true,doShockStep:false,allowedPenetration:0.01,collToll:0.05,velThreshold:0.5,angVelThreshold:5,posThreshold:0.2,orientThreshold:0.2,deactivationTime:1,numPenetrationRelaxationTimesteps:50,numCollisionIterations:4,numContactIterations:8,numConstraintIterations:15};})(jigLib);(function(a){glMatrixArrayType=typeof Float32Array!="undefined"?Float32Array:typeof WebGLFloatArray!="undefined"?WebGLFloatArray:Array;var d={};d.create=function(f){var e=new glMatrixArrayType(3);if(f){e[0]=f[0];e[1]=f[1];e[2]=f[2];}return e;};d.set=function(f,e){e[0]=f[0];e[1]=f[1];e[2]=f[2];return e;};d.add=function(f,e,g){if(!g||f==g){f[0]+=e[0];f[1]+=e[1];f[2]+=e[2];return f;}g[0]=f[0]+e[0];g[1]=f[1]+e[1];g[2]=f[2]+e[2];return g;};d.subtract=function(f,e,g){if(!g||f==g){f[0]-=e[0];f[1]-=e[1];f[2]-=e[2];return f;}g[0]=f[0]-e[0];g[1]=f[1]-e[1];g[2]=f[2]-e[2];return g;};d.negate=function(f,e){e||(e=f);e[0]=-f[0];e[1]=-f[1];e[2]=-f[2];return e;};d.scale=function(f,e,g){if(!g||f==g){f[0]*=e;f[1]*=e;f[2]*=e;return f;}g[0]=f[0]*e;g[1]=f[1]*e;g[2]=f[2]*e;return g;};d.normalize=function(h,f){f||(f=h);var l=h[0],k=h[1],j=h[2],i=Math.sqrt(l*l+k*k+j*j);if(i){if(i==1){f[0]=l;f[1]=k;f[2]=j;return f;}}else{f[0]=0;f[1]=0;f[2]=0;return f;}i=1/i;f[0]=l*i;f[1]=k*i;f[2]=j*i;return f;};d.cross=function(i,h,n){n||(n=i);var m=i[0],l=i[1];i=i[2];var j=h[0],k=h[1];h=h[2];n[0]=l*h-i*k;n[1]=i*j-m*h;n[2]=m*k-l*j;return n;};d.length=function(f){var e=f[0],g=f[1];f=f[2];return Math.sqrt(e*e+g*g+f*f);};d.dot=function(f,e){return f[0]*e[0]+f[1]*e[1]+f[2]*e[2];};d.direction=function(g,f,j){j||(j=g);var i=g[0]-f[0],h=g[1]-f[1];g=g[2]-f[2];f=Math.sqrt(i*i+h*h+g*g);if(!f){j[0]=0;j[1]=0;j[2]=0;return j;}f=1/f;j[0]=i*f;j[1]=h*f;j[2]=g*f;return j;};d.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+"]";};var c={};c.create=function(f){var e=new glMatrixArrayType(9);if(f){e[0]=f[0];e[1]=f[1];e[2]=f[2];e[3]=f[3];e[4]=f[4];e[5]=f[5];e[6]=f[6];e[7]=f[7];e[8]=f[8];e[9]=f[9];}return e;};c.set=function(f,e){e[0]=f[0];e[1]=f[1];e[2]=f[2];e[3]=f[3];e[4]=f[4];e[5]=f[5];e[6]=f[6];e[7]=f[7];e[8]=f[8];return e;};c.identity=function(e){e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=1;e[5]=0;e[6]=0;e[7]=0;e[8]=1;return e;};c.toMat4=function(f,e){e||(e=b.create());e[0]=f[0];e[1]=f[1];e[2]=f[2];e[3]=0;e[4]=f[3];e[5]=f[4];e[6]=f[5];e[7]=0;e[8]=f[6];e[9]=f[7];e[10]=f[8];e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return e;};c.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+"]";};var b={};b.create=function(f){var e=new glMatrixArrayType(16);if(f){e[0]=f[0];e[1]=f[1];e[2]=f[2];e[3]=f[3];e[4]=f[4];e[5]=f[5];e[6]=f[6];e[7]=f[7];e[8]=f[8];e[9]=f[9];e[10]=f[10];e[11]=f[11];e[12]=f[12];e[13]=f[13];e[14]=f[14];e[15]=f[15];}return e;};b.set=function(f,e){e[0]=f[0];e[1]=f[1];e[2]=f[2];e[3]=f[3];e[4]=f[4];e[5]=f[5];e[6]=f[6];e[7]=f[7];e[8]=f[8];e[9]=f[9];e[10]=f[10];e[11]=f[11];e[12]=f[12];e[13]=f[13];e[14]=f[14];e[15]=f[15];return e;};b.identity=function(e){e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=1;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=1;e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return e;};b.transpose=function(j,i){if(!i||j==i){var p=j[1],o=j[2],n=j[3],l=j[6],m=j[7],k=j[11];j[1]=j[4];j[2]=j[8];j[3]=j[12];j[4]=p;j[6]=j[9];j[7]=j[13];j[8]=o;j[9]=l;j[11]=j[14];j[12]=n;j[13]=m;j[14]=k;return j;}i[0]=j[0];i[1]=j[4];i[2]=j[8];i[3]=j[12];i[4]=j[1];i[5]=j[5];i[6]=j[9];i[7]=j[13];i[8]=j[2];i[9]=j[6];i[10]=j[10];i[11]=j[14];i[12]=j[3];i[13]=j[7];i[14]=j[11];i[15]=j[15];return i;};b.determinant=function(F){var E=F[0],D=F[1],C=F[2],B=F[3],z=F[4],A=F[5],y=F[6],x=F[7],w=F[8],v=F[9],u=F[10],r=F[11],t=F[12],s=F[13],q=F[14];F=F[15];return t*v*y*B-w*s*y*B-t*A*u*B+z*s*u*B+w*A*q*B-z*v*q*B-t*v*C*x+w*s*C*x+t*D*u*x-E*s*u*x-w*D*q*x+E*v*q*x+t*A*C*r-z*s*C*r-t*D*y*r+E*s*y*r+z*D*q*r-E*A*q*r-w*A*C*F+z*v*C*F+w*D*y*F-E*v*y*F-z*D*u*F+E*A*u*F;};b.inverse=function(aj,ai){ai||(ai=aj);var ah=aj[0],ag=aj[1],af=aj[2],ad=aj[3],ae=aj[4],ac=aj[5],ab=aj[6],aa=aj[7],Z=aj[8],Y=aj[9],V=aj[10],X=aj[11],W=aj[12],U=aj[13],Q=aj[14],O=aj[15],T=ah*ac-ag*ae,S=ah*ab-af*ae,M=ah*aa-ad*ae,K=ag*ab-af*ac,J=ag*aa-ad*ac,I=af*aa-ad*ab,H=Z*U-Y*W,G=Z*Q-V*W,F=Z*O-X*W,P=Y*Q-V*U,N=Y*O-X*U,L=V*O-X*Q,R=1/(T*L-S*N+M*P+K*F-J*G+I*H);ai[0]=(ac*L-ab*N+aa*P)*R;ai[1]=(-ag*L+af*N-ad*P)*R;ai[2]=(U*I-Q*J+O*K)*R;ai[3]=(-Y*I+V*J-X*K)*R;ai[4]=(-ae*L+ab*F-aa*G)*R;ai[5]=(ah*L-af*F+ad*G)*R;ai[6]=(-W*I+Q*M-O*S)*R;ai[7]=(Z*I-V*M+X*S)*R;ai[8]=(ae*N-ac*F+aa*H)*R;ai[9]=(-ah*N+ag*F-ad*H)*R;ai[10]=(W*J-U*M+O*T)*R;ai[11]=(-Z*J+Y*M-X*T)*R;ai[12]=(-ae*P+ac*G-ab*H)*R;ai[13]=(ah*P-ag*G+af*H)*R;ai[14]=(-W*K+U*S-Q*T)*R;ai[15]=(Z*K-Y*S+V*T)*R;return ai;};b.toMat3=function(f,e){e||(e=c.create());e[0]=f[0];e[1]=f[1];e[2]=f[2];e[3]=f[4];e[4]=f[5];e[5]=f[6];e[6]=f[8];e[7]=f[9];e[8]=f[10];return e;};b.toInverseMat3=function(D,C){var B=D[0],A=D[1],z=D[2],x=D[4],y=D[5],w=D[6],v=D[8],u=D[9],t=D[10],s=t*y-w*u,p=-t*x+w*v,r=u*x-y*v,q=B*s+A*p+z*r;if(!q){return null;}q=1/q;C||(C=c.create());C[0]=s*q;C[1]=(-t*A+z*u)*q;C[2]=(w*A-z*y)*q;C[3]=p*q;C[4]=(t*B-z*v)*q;C[5]=(-w*B+z*x)*q;C[6]=r*q;C[7]=(-u*B+A*v)*q;C[8]=(y*B-A*x)*q;return C;};b.multiply=function(an,am,al){al||(al=an);var ak=an[0],aj=an[1],ah=an[2],ai=an[3],ag=an[4],af=an[5],ae=an[6],ad=an[7],ac=an[8],Z=an[9],ab=an[10],aa=an[11],Y=an[12],U=an[13],S=an[14];an=an[15];var X=am[0],W=am[1],Q=am[2],O=am[3],M=am[4],K=am[5],J=am[6],I=am[7],H=am[8],T=am[9],R=am[10],P=am[11],V=am[12],N=am[13],L=am[14];am=am[15];al[0]=X*ak+W*ag+Q*ac+O*Y;al[1]=X*aj+W*af+Q*Z+O*U;al[2]=X*ah+W*ae+Q*ab+O*S;al[3]=X*ai+W*ad+Q*aa+O*an;al[4]=M*ak+K*ag+J*ac+I*Y;al[5]=M*aj+K*af+J*Z+I*U;al[6]=M*ah+K*ae+J*ab+I*S;al[7]=M*ai+K*ad+J*aa+I*an;al[8]=H*ak+T*ag+R*ac+P*Y;al[9]=H*aj+T*af+R*Z+P*U;al[10]=H*ah+T*ae+R*ab+P*S;al[11]=H*ai+T*ad+R*aa+P*an;al[12]=V*ak+N*ag+L*ac+am*Y;al[13]=V*aj+N*af+L*Z+am*U;al[14]=V*ah+N*ae+L*ab+am*S;al[15]=V*ai+N*ad+L*aa+am*an;return al;};b.multiplyVec3=function(g,f,j){j||(j=f);var i=f[0],h=f[1];f=f[2];j[0]=g[0]*i+g[4]*h+g[8]*f+g[12];j[1]=g[1]*i+g[5]*h+g[9]*f+g[13];j[2]=g[2]*i+g[6]*h+g[10]*f+g[14];return j;};b.multiplyVec4=function(h,f,l){l||(l=f);var k=f[0],j=f[1],i=f[2];f=f[3];l[0]=h[0]*k+h[4]*j+h[8]*i+h[12]*f;l[1]=h[1]*k+h[5]*j+h[9]*i+h[13]*f;l[2]=h[2]*k+h[6]*j+h[10]*i+h[14]*f;l[4]=h[4]*k+h[7]*j+h[11]*i+h[15]*f;return l;};b.translate=function(H,G,F){var E=G[0],D=G[1];G=G[2];if(!F||H==F){H[12]=H[0]*E+H[4]*D+H[8]*G+H[12];H[13]=H[1]*E+H[5]*D+H[9]*G+H[13];H[14]=H[2]*E+H[6]*D+H[10]*G+H[14];H[15]=H[3]*E+H[7]*D+H[11]*G+H[15];return H;}var B=H[0],C=H[1],A=H[2],z=H[3],y=H[4],x=H[5],w=H[6],t=H[7],v=H[8],u=H[9],s=H[10],q=H[11];F[0]=B;F[1]=C;F[2]=A;F[3]=z;F[4]=y;F[5]=x;F[6]=w;F[7]=t;F[8]=v;F[9]=u;F[10]=s;F[11]=q;F[12]=B*E+y*D+v*G+H[12];F[13]=C*E+x*D+u*G+H[13];F[14]=A*E+w*D+s*G+H[14];F[15]=z*E+t*D+q*G+H[15];return F;};b.scale=function(g,f,j){var i=f[0],h=f[1];f=f[2];if(!j||g==j){g[0]*=i;g[1]*=i;g[2]*=i;g[3]*=i;g[4]*=h;g[5]*=h;g[6]*=h;g[7]*=h;g[8]*=f;g[9]*=f;g[10]*=f;g[11]*=f;return g;}j[0]=g[0]*i;j[1]=g[1]*i;j[2]=g[2]*i;j[3]=g[3]*i;j[4]=g[4]*h;j[5]=g[5]*h;j[6]=g[6]*h;j[7]=g[7]*h;j[8]=g[8]*f;j[9]=g[9]*f;j[10]=g[10]*f;j[11]=g[11]*f;j[12]=g[12];j[13]=g[13];j[14]=g[14];j[15]=g[15];return j;};b.rotate=function(ab,aa,Z,Y){var X=Z[0],V=Z[1];Z=Z[2];var W=Math.sqrt(X*X+V*V+Z*Z);if(!W){return null;}if(W!=1){W=1/W;X*=W;V*=W;Z*=W;}var U=Math.sin(aa),T=Math.cos(aa),S=1-T;aa=ab[0];W=ab[1];var R=ab[2],Q=ab[3],N=ab[4],P=ab[5],O=ab[6],M=ab[7],J=ab[8],I=ab[9],L=ab[10],K=ab[11],H=X*X*S+T,G=V*X*S+Z*U,F=Z*X*S-V*U,E=X*V*S-Z*U,D=V*V*S+T,C=Z*V*S+X*U,q=X*Z*S+V*U;X=V*Z*S-X*U;V=Z*Z*S+T;if(Y){if(ab!=Y){Y[12]=ab[12];Y[13]=ab[13];Y[14]=ab[14];Y[15]=ab[15];}}else{Y=ab;}Y[0]=aa*H+N*G+J*F;Y[1]=W*H+P*G+I*F;Y[2]=R*H+O*G+L*F;Y[3]=Q*H+M*G+K*F;Y[4]=aa*E+N*D+J*C;Y[5]=W*E+P*D+I*C;Y[6]=R*E+O*D+L*C;Y[7]=Q*E+M*D+K*C;Y[8]=aa*q+N*X+J*V;Y[9]=W*q+P*X+I*V;Y[10]=R*q+O*X+L*V;Y[11]=Q*q+M*X+K*V;return Y;};b.rotateX=function(x,w,v){var u=Math.sin(w);w=Math.cos(w);var t=x[4],r=x[5],s=x[6],q=x[7],p=x[8],o=x[9],n=x[10],m=x[11];if(v){if(x!=v){v[0]=x[0];v[1]=x[1];v[2]=x[2];v[3]=x[3];v[12]=x[12];v[13]=x[13];v[14]=x[14];v[15]=x[15];}}else{v=x;}v[4]=t*w+p*u;v[5]=r*w+o*u;v[6]=s*w+n*u;v[7]=q*w+m*u;v[8]=t*-u+p*w;v[9]=r*-u+o*w;v[10]=s*-u+n*w;v[11]=q*-u+m*w;return v;};b.rotateY=function(x,w,v){var u=Math.sin(w);w=Math.cos(w);var t=x[0],r=x[1],s=x[2],q=x[3],p=x[8],o=x[9],n=x[10],m=x[11];if(v){if(x!=v){v[4]=x[4];v[5]=x[5];v[6]=x[6];v[7]=x[7];v[12]=x[12];v[13]=x[13];v[14]=x[14];v[15]=x[15];}}else{v=x;}v[0]=t*w+p*-u;v[1]=r*w+o*-u;v[2]=s*w+n*-u;v[3]=q*w+m*-u;v[8]=t*u+p*w;v[9]=r*u+o*w;v[10]=s*u+n*w;v[11]=q*u+m*w;return v;};b.rotateZ=function(x,w,v){var u=Math.sin(w);w=Math.cos(w);var t=x[0],r=x[1],s=x[2],q=x[3],p=x[4],o=x[5],n=x[6],m=x[7];if(v){if(x!=v){v[8]=x[8];v[9]=x[9];v[10]=x[10];v[11]=x[11];v[12]=x[12];v[13]=x[13];v[14]=x[14];v[15]=x[15];}}else{v=x;}v[0]=t*w+p*u;v[1]=r*w+o*u;v[2]=s*w+n*u;v[3]=q*w+m*u;v[4]=t*-u+p*w;v[5]=r*-u+o*w;v[6]=s*-u+n*w;v[7]=q*-u+m*w;return v;};b.frustum=function(t,s,r,q,p,n,o){o||(o=b.create());var m=s-t,l=q-r,k=n-p;o[0]=p*2/m;o[1]=0;o[2]=0;o[3]=0;o[4]=0;o[5]=p*2/l;o[6]=0;o[7]=0;o[8]=(s+t)/m;o[9]=(q+r)/l;o[10]=-(n+p)/k;o[11]=-1;o[12]=0;o[13]=0;o[14]=-(n*p*2)/k;o[15]=0;return o;};b.perspective=function(g,f,j,i,h){g=j*Math.tan(g*Math.PI/360);f=g*f;return b.frustum(-f,f,-g,g,j,i,h);};b.ortho=function(t,s,r,q,p,n,o){o||(o=b.create());var m=s-t,l=q-r,k=n-p;o[0]=2/m;o[1]=0;o[2]=0;o[3]=0;o[4]=0;o[5]=2/l;o[6]=0;o[7]=0;o[8]=0;o[9]=0;o[10]=-2/k;o[11]=0;o[12]=(t+s)/m;o[13]=(q+r)/l;o[14]=(n+p)/k;o[15]=1;return o;};b.lookAt=function(B,A,z,y){y||(y=b.create());var x=B[0],v=B[1];B=B[2];var w=z[0],u=z[1],t=z[2];z=A[1];var s=A[2];if(x==A[0]&&v==z&&B==s){return b.identity(y);}var r,q,n,p;z=x-A[0];s=v-A[1];A=B-A[2];p=1/Math.sqrt(z*z+s*s+A*A);z*=p;s*=p;A*=p;r=u*A-t*s;t=t*z-w*A;w=w*s-u*z;if(p=Math.sqrt(r*r+t*t+w*w)){p=1/p;r*=p;t*=p;w*=p;}else{w=t=r=0;}u=s*w-A*t;q=A*r-z*w;n=z*t-s*r;if(p=Math.sqrt(u*u+q*q+n*n)){p=1/p;u*=p;q*=p;n*=p;}else{n=q=u=0;}y[0]=r;y[1]=u;y[2]=z;y[3]=0;y[4]=t;y[5]=q;y[6]=s;y[7]=0;y[8]=w;y[9]=n;y[10]=A;y[11]=0;y[12]=-(r*x+t*v+w*B);y[13]=-(u*x+q*v+n*B);y[14]=-(z*x+s*v+A*B);y[15]=1;return y;};b.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+"]";};quat4={};quat4.create=function(f){var e=new glMatrixArrayType(4);if(f){e[0]=f[0];e[1]=f[1];e[2]=f[2];e[3]=f[3];}return e;};quat4.set=function(f,e){e[0]=f[0];e[1]=f[1];e[2]=f[2];e[3]=f[3];return e;};quat4.calculateW=function(g,f){var j=g[0],i=g[1],h=g[2];if(!f||g==f){g[3]=-Math.sqrt(Math.abs(1-j*j-i*i-h*h));return g;}f[0]=j;f[1]=i;f[2]=h;f[3]=-Math.sqrt(Math.abs(1-j*j-i*i-h*h));return f;};quat4.inverse=function(f,e){if(!e||f==e){f[0]*=1;f[1]*=1;f[2]*=1;return f;}e[0]=-f[0];e[1]=-f[1];e[2]=-f[2];e[3]=f[3];return e;};quat4.length=function(f){var e=f[0],h=f[1],g=f[2];f=f[3];return Math.sqrt(e*e+h*h+g*g+f*f);};quat4.normalize=function(i,h){h||(h=i);var n=i[0],m=i[1],l=i[2],j=i[3],k=Math.sqrt(n*n+m*m+l*l+j*j);if(k==0){h[0]=0;h[1]=0;h[2]=0;h[3]=0;return h;}k=1/k;h[0]=n*k;h[1]=m*k;h[2]=l*k;h[3]=j*k;return h;};quat4.multiply=function(r,q,p){p||(p=r);var o=r[0],n=r[1],l=r[2];r=r[3];var m=q[0],k=q[1],j=q[2];q=q[3];p[0]=o*q+r*m+n*j-l*k;p[1]=n*q+r*k+l*m-o*j;p[2]=l*q+r*j+o*k-n*m;p[3]=r*q-o*m-n*k-l*j;return p;};quat4.multiplyVec3=function(v,u,t){t||(t=u);var s=u[0],r=u[1],p=u[2];u=v[0];var q=v[1],o=v[2];v=v[3];var n=v*s+q*p-o*r,m=v*r+o*s-u*p,l=v*p+u*r-q*s;s=-u*s-q*r-o*p;t[0]=n*v+s*-u+m*-o-l*-q;t[1]=m*v+s*-q+l*-u-n*-o;t[2]=l*v+s*-o+n*-q-m*-u;return t;};quat4.toMat3=function(x,w){w||(w=c.create());var v=x[0],u=x[1],t=x[2],r=x[3],s=v+v,q=u+u,p=t+t,o=v*s,n=v*q;v=v*p;var m=u*q;u=u*p;t=t*p;s=r*s;q=r*q;r=r*p;w[0]=1-(m+t);w[1]=n-r;w[2]=v+q;w[3]=n+r;w[4]=1-(o+t);w[5]=u-s;w[6]=v-q;w[7]=u+s;w[8]=1-(o+m);return w;};quat4.toMat4=function(x,w){w||(w=b.create());var v=x[0],u=x[1],t=x[2],r=x[3],s=v+v,q=u+u,p=t+t,o=v*s,n=v*q;v=v*p;var m=u*q;u=u*p;t=t*p;s=r*s;q=r*q;r=r*p;w[0]=1-(m+t);w[1]=n-r;w[2]=v+q;w[3]=0;w[4]=n+r;w[5]=1-(o+t);w[6]=u-s;w[7]=0;w[8]=v-q;w[9]=u+s;w[10]=1-(o+m);w[11]=0;w[12]=0;w[13]=0;w[14]=0;w[15]=1;return w;};quat4.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+"]";};a.GLMatrix=b;})(jigLib);(function(a){var b=function(){throw new Error("Vector3DUtil is a utility class and should not be instantiated");};b.X_AXIS=[1,0,0,0];b.Y_AXIS=[0,1,0,0];b.Z_AXIS=[0,0,1,0];b.add=function(g,e){return[g[0]+e[0],g[1]+e[1],g[2]+e[2],g[3]+e[3]];};b.subtract=function(g,e){return[g[0]-e[0],g[1]-e[1],g[2]-e[2],g[3]-e[3]];};b.decrementBy=function(g,e){g[0]-=e[0];g[1]-=e[1];g[2]-=e[2];g[3]-=e[3];};b.IncrementBy=function(g,e){g[0]+=e[0];g[1]+=e[1];g[2]+=e[2];g[3]+=e[3];};b.distance=function(l,j){var h=Math;var g=h.pow;var e=g(l[0]-j[0],2);var k=g(l[1]-j[1],2);var i=g(l[2]-j[2],2);return h.sqrt(e+k+i);};b.dotProduct=function(g,e){return g[0]*e[0]+g[1]*e[1]+g[2]*e[2];};b.crossProduct=function(g,e){return[g[1]*e[2]-g[2]*e[1],g[2]*e[0]-g[0]*e[2],g[0]*e[1]-g[1]*e[0],0];};b.get_length=function(e){var g=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];return(g>0)?Math.pow(g,0.5):0;};b.get_lengthSquared=function(e){var g=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];return g;};b.normalize=function(e){f=b.get_length(e);e[0]/=f;e[1]/=f;e[2]/=f;return f;};b.negate=function(e){e[0]*=-1;e[1]*=-1;e[2]*=-1;return e;};b.scaleBy=function(e,g){e[0]*=g;e[1]*=g;e[2]*=g;};b.getSum=function(g){var e=Math.abs;return e(g[0])+e(g[1])+e(g[2]);};b.limitSum=function(g,h){var e=Math.abs;c=b.getSum(g);if(h>=c){return;}f=h/c;b.scaleBy(g,f);};b.project=function(e){e[0]/=e[3];e[1]/=e[3];e[2]/=e[3];e[3]=1;};b.angleBetween=function(i,g){var h=i.slice(0);var e=g.slice(0);b.normalize(h);b.normalize(e);d=b.dotProduct(h,e);if(d<-1){d=-1;}else{if(d>1){d=1;}}return Math.acos(d);};b.equals=function(h,g,e){if(!e){return(h[0]==g[0]&&h[1]==g[1]&&h[2]==g[2]);}else{return(h[0]==g[0]&&h[1]==g[1]&&h[2]==g[2]&&h[3]==g[3]);}};b.create=function(e,j,i,g){var h=[];h[0]=(e)?e:0;h[1]=(j)?j:0;h[2]=(i)?i:0;h[3]=(g)?g:0;return h;};a.Vector3DUtil=b;})(jigLib);(function(b){var c=b.Vector3DUtil;var a=b.GLMatrix;var d=function(e){if(e){this.glmatrix=a.create(e);}else{this.glmatrix=a.create([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);}};d.prototype.glmatrix=null;d.prototype.get_determinant=function(){return a.determinant(this.glmatrix);};d.prototype.prepend=function(e){a.multiply(e.glmatrix,this.glmatrix,this.glmatrix);return;};d.prototype.append=function(e){a.multiply(this.glmatrix,e.glmatrix);return;};d.prototype.angleAxis=function(s,j){var u,p,v,t,o,f,g,q,k;s=s/(3.14159*2);var n=j[0];var m=j[1];var l=j[2];var i=Math.cos(s);var h=1-i;var e=Math.sin(s);g=n*e;q=m*e;k=l*e;u=n*n;p=m*m;v=l*l;t=n*m;o=m*l;f=l*n;var r=[(h*u)+i,(h*t)-k,(h*f)+q,0,(h*t)+k,(h*p)+i,(h*o)-g,0,(h*f)-q,(h*o)+g,(h*v)+i,0,0,0,0,1];return new d(r);};d.prototype.rotate=function(g,f){var e=this.clone();a.rotate(e.glmatrix,g,f);return e;};d.prototype.translateMatrix=function(e){return new d([1,0,0,e[0],0,1,0,e[1],0,0,1,e[2],0,0,0,1]);};d.prototype.scaleMatrix=function(e){return new d([e[0],0,0,0,0,e[1],0,0,0,0,e[2],0,0,0,0,1]);};d.prototype.appendRotation=function(h,g,e){h=h/(3.14159*2);c.negate(g);if(e){var f=c.negate(e.slice(0));this.appendTranslation(f[0],f[1],f[2]);}a.rotate(this.glmatrix,h,g);if(e){this.appendTranslation(e[0],e[1],e[2]);}};d.prototype.prependRotation=function(g,f,e){if(e){this.prepend(this.translateMatrix(c.negate(e.slice(0))));}this.prepend(this.angleAxis(g,f));if(e){this.prepend(this.translateMatrix(e));}};d.prototype.appendScale=function(e,g,f){a.scale(this.glmatrix,[e,g,f]);};d.prototype.prependScale=function(e,g,f){this.prepend(this.scaleMatrix([e,g,f]));};d.prototype.appendTranslation=function(e,g,f){this.append(this.translateMatrix([e,g,f]));};d.prototype.prependTranslation=function(e,g,f){this.prepend(this.translateMatrix([e,g,f]));};d.prototype.identity=function(){a.identity(this.glmatrix);return;};d.prototype.transpose=function(){a.transpose(this.glmatrix);};d.prototype.invert=function(){a.inverse(this.glmatrix);return;};d.prototype.clone=function(){return new d(this.glmatrix);};d.prototype.transformVector=function(e){return a.multiplyVec3(this.glmatrix,e);};b.Matrix3D=d;})(jigLib);(function(a){var c=a.Vector3DUtil;var b={};b.NUM_TINY=0.00001;b.NUM_HUGE=100000;b.getScaleVector=function(d,e){return[d[0]*e,d[1]*e,d[2]*e,d[3]];};b.getDivideVector=function(e,d){return(d)?[e[0]/d,e[1]/d,e[2]/d,0]:[0,0,0,0];};b.getNormal=function(d,i,h){var f=i.slice(0);var e=h.slice(0);var g=c.crossProduct(c.subtract(f,d),c.subtract(e,i));c.normalize(g);return g;};b.copyFromArray=function(e,d){if(d.length>=3){e=d.slice(0);}};b.getLimiteNumber=function(e,f,d){var g=e;if(g<f){g=f;}else{if(g>d){g=d;}}return g;};a.JNumber3D=b;})(jigLib);(function(b){var c=b.Vector3DUtil;var d=b.Matrix3D;var a={};a.getTranslationMatrix=function(e,h,g){var f=new d();f.appendTranslation(e,h,g);return f;};a.getScaleMatrix=function(e,h,g){var f=new d();f.prependScale(e,h,g);return f;};a.getRotationMatrix=function(e,j,i,g,f){var h=new d();h.appendRotation(g,c.create(e,j,i,0),f);return h;};a.getInverseMatrix=function(e){var f=e.clone();f.invert();return f;};a.getTransposeMatrix=function(e){var f=e.clone();f.transpose();return f;};a.getAppendMatrix3D=function(f,e){var g=f.clone();g.append(e);return g;};a.getPrependMatrix=function(f,e){var g=f.clone();g.prepend(e);return g;};a.getSubMatrix=function(f,e){var g=[16];for(var h=0;h<16;h++){g[h]=f.glmatrix[h]-e.glmatrix[h];}return new d(g);};a.getRotationMatrixAxis=function(f,e){var g=new d();g.appendRotation(f,e?e:c.X_AXIS);return g;};a.getCols=function(g){var e=g.glmatrix;var f=[];f[0]=c.create(e[0],e[4],e[8],0);f[1]=c.create(e[1],e[5],e[9],0);f[2]=c.create(e[2],e[6],e[10],0);return f;};a.multiplyVector=function(j,e){var h=e[0];var g=e[1];var f=e[2];if(h==0&&g==0&&f==0){return;}var i=j.glmatrix;e[0]=h*i[0]+g*i[1]+f*i[2]+i[3];e[1]=h*i[4]+g*i[5]+f*i[6]+i[7];e[2]=h*i[8]+g*i[9]+f*i[10]+i[11];};b.JMatrix3D=a;})(jigLib);(function(a){var c=a.Vector3DUtil;var b={};b.fromNormalAndPoint=function(f,d){var e=c.create(f[0],f[1],f[2],0);e[3]=-(e[0]*d[0]+e[1]*d[1]+e[2]*d[2]);return f;};b.getIntersectionLine=function(f,e,i){var h=f[0]*e[0]+f[1]*e[1]+f[2]*e[2]-f[3];var g=f[0]*i[0]+f[1]*i[1]+f[2]*i[2]-f[3];var d=g/(g-h);return[i[0]+(e[0]-i[0])*d,i[1]+(e[1]-i[1])*d,i[2]+(e[2]-i[2])*d,0];};b.unproject=function(j,e,f,i,g){var h=(e*f)/e;var d=c.create(i/h,-g/h,e,0);return j.transformVector(d);};})(jigLib);(function(a){var b=function(){};b.prototype.pair=null;b.prototype.impulse=null;a.ContactData=b;})(jigLib);(function(a){var b=function(d,c){this.ind0=d;this.ind1=c;};a.EdgeData=b;})(jigLib);(function(a){var b=a.Vector3DUtil;var c=function(e,d){this.position=e.slice(0);this.normal=d.slice(0);this.distance=b.dotProduct(this.position,this._normal);};c.prototype.position=null;c.prototype.normal=null;c.prototype.distance=null;c.prototype.pointPlaneDistance=function(d){return b.dotProduct(normal,d)-distance;};a.PlaneData=c;})(jigLib);(function(a){var b=function(){};b.prototype.min=null;b.prototype.max=null;b.prototype.flag=null;b.prototype.depth=null;a.SpanData=b;})(jigLib);(function(c){var b=c.PhysicsSystem;var d=c.RigidBody;var a=function(e){if(!e){e=5;}this.inittime=(new Date()).getTime();this.speed=e;this.physicsSystem=b.getInstance();};a.prototype.addBody=function(e){this.physicsSystem.addBody(e);};a.prototype.removeBody=function(e){physicsSystem.removeBody(e);};a.prototype.get_engine=function(){return this.physicsSystem;};a.prototype.step=function(){var e=(new Date()).getTime();deltaTime=((e-this.initTime)/1000)*this.speed;this.initTime=e;this.physicsSystem.integrate(deltaTime);};c.AbstractPhysics=a;})(jigLib);(function(b){var c=b.Matrix3D;function a(){this.matrix=new c();}a.prototype.get_transform=function(){return this.matrix;};a.prototype.set_transform=function(d){this.matrix=d;};b.ISkin3D=a;})(jigLib);(function(a){var b=function(){};b.prototype.get_minW=function(){};b.prototype.get_minH=function(){};b.prototype.get_maxW=function(){};b.prototype.get_maxH=function(){};b.prototype.get_dw=function(){};b.prototype.get_dh=function(){};b.prototype.get_sw=function(){};b.prototype.get_sh=function(){};b.prototype.get_heights=function(){};a.ITerrain=b;})(jigLib);(function(a){var d=a.Vector3DUtil;var c=a.JNumber3D;var b=function(f,e){this._minPos=f.slice(0);this._maxPos=e.slice(0);};b.prototype._minPos=null;b.prototype._maxPos=null;b.prototype.get_minPos=function(){return this._minPos;};b.prototype.set_minPos=function(e){this._minPos=e.slice(0);};b.prototype.get_maxPos=function(){return this._maxPos;};b.prototype.set_maxPos=function(e){this._maxPos=e.slice(0);};b.prototype.get_sideLengths=function(){var e=this._maxPos.slice(0);d.subtract(e,this._minPos);return e;};b.prototype.get_centrePos=function(){var e=this._minPos.slice(0);return c.getScaleVector(d.add(e,this._maxPos),0.5);};b.prototype.move=function(e){d.add(this._minPos,e);d.add(this._maxPos,e);};b.prototype.clear=function(){this._minPos=d.create(c.NUM_HUGE,c.NUM_HUGE,c.NUM_HUGE,0);this._maxPos=d.create(-c.NUM_HUGE,-c.NUM_HUGE,-c.NUM_HUGE,0);};b.prototype.clone=function(){return new b(this._minPos,this._maxPos);};b.prototype.addPoint=function(g){var f=this._minPos;var e=this._maxPos;if(g[0]<f[0]){f[0]=g[0]-c.NUM_TINY;}if(g[0]>e[0]){e[0]=g[0]+c.NUM_TINY;}if(g[1]<f[1]){f[1]=g[1]-c.NUM_TINY;}if(g[1]>e[1]){e[1]=g[1]+c.NUM_TINY;}if(g[2]<f[2]){f[2]=g[2]-c.NUM_TINY;}if(g[2]>e[2]){e[2]=g[2]+c.NUM_TINY;}};b.prototype.addBox=function(e){var f=e.getCornerPoints(e.get_currentState());this.addPoint(f[0]);this.addPoint(f[1]);this.addPoint(f[2]);this.addPoint(f[3]);this.addPoint(f[4]);this.addPoint(f[5]);this.addPoint(f[6]);this.addPoint(f[7]);};b.prototype.addSphere=function(e){var g=this._minPos;var f=this._maxPos;if(e.get_currentState().position[0]-e.get_radius()<g[0]){g[0]=(e.get_currentState().position[0]-e.get_radius())-c.NUM_TINY;}if(e.get_currentState().position[0]+e.get_radius()>f[0]){f[0]=(e.get_currentState().position[0]+e.get_radius())+c.NUM_TINY;}if(e.get_currentState().position[1]-e.get_radius()<g[1]){g[1]=(e.get_currentState().position[1]-e.get_radius())-c.NUM_TINY;}if(e.get_currentState().position[1]+e.get_radius()>f[1]){f[1]=(e.get_currentState().position[1]+e.get_radius())+c.NUM_TINY;}if(e.get_currentState().position[2]-e.get_radius()<g[2]){g[2]=(e.get_currentState().position[2]-e.get_radius())-c.NUM_TINY;}if(e.get_currentState().position[2]+e.get_radius()>f[2]){f[2]=(e.get_currentState().position[2]+e.get_radius())+c.NUM_TINY;}};b.prototype.addCapsule=function(f){var h=f.getBottomPos(f.get_currentState());var g=this._minPos;var e=this._maxPos;if(h[0]-f.get_radius()<g[0]){g[0]=(h[0]-f.get_radius())-c.NUM_TINY;}if(h[0]+f.get_radius()>e[0]){e[0]=(h[0]+f.get_radius())+c.NUM_TINY;}if(h[1]-f.get_radius()<g[1]){g[1]=(h[1]-f.get_radius())-c.NUM_TINY;}if(h[1]+f.get_radius()>e[1]){e[1]=(h[1]+f.get_radius())+c.NUM_TINY;}if(h[2]-f.get_radius()<g[2]){g[2]=(h[2]-f.get_radius())-c.NUM_TINY;}if(h[2]+f.get_radius()>e[2]){e[2]=(h[2]+f.get_radius())+c.NUM_TINY;}h=f.getEndPos(f.get_currentState());if(h[0]-f.get_radius()<g[0]){g[0]=(h[0]-f.get_radius())-c.NUM_TINY;}if(h[0]+f.get_radius()>e[0]){e[0]=(h[0]+f.get_radius())+c.NUM_TINY;}if(h[1]-f.get_radius()<g[1]){g[1]=(h[1]-f.get_radius())-c.NUM_TINY;}if(h[1]+f.get_radius()>e[1]){e[1]=(h[1]+f.get_radius())+c.NUM_TINY;}if(h[2]-f.get_radius()<g[2]){g[2]=(h[2]-f.get_radius())-c.NUM_TINY;}if(h[2]+f.get_radius()>e[2]){e[2]=(h[2]+f.get_radius())+c.NUM_TINY;}};b.prototype.addSegment=function(e){this.addPoint(e.origin);this.addPoint(e.getEnd());};b.prototype.overlapTest=function(g){var f=this._minPos;var e=this._maxPos;return((f[2]>=g.get_maxPos()[2])||(e[2]<=g.get_minPos()[2])||(f[1]>=g.get_maxPos()[1])||(e[1]<=g.get_minPos()[1])||(f[0]>=g.get_maxPos()[0])||(e[0]<=g.get_minPos()[0]))?false:true;};b.prototype.isPointInside=function(g){var f=this._minPos;var e=this._maxPos;return((g[0]>=f[0])&&(g[0]<=e[0])&&(g[1]>=f[1])&&(g[1]<=e[1])&&(g[2]>=f[2])&&(g[2]<=e[2]));};b.prototype.toString=function(){var f=this._minPos;var e=this._maxPos;return[f[0],f[1],f[2],e[0],e[1],e[2]].toString();};a.JAABox=b;})(jigLib);(function(a){var b=function(f,e,d,c){if(f.id>e.id){this.body0=f;this.body1=e;this.r=d;}else{this.body0=e;this.body1=f;this.r=c;}};b.prototype.body0=null;b.prototype.body1=null;b.prototype.r=null;a.BodyPair=b;})(jigLib);(function(a){var b=function(d,e,c){this.normalImpulse=d;this.normalImpulseAux=e;this.frictionImpulse=c;};b.prototype.normalImpulse=null;b.prototype.normalImpulseAux=null;b.prototype.frictionImpulse=null;a.CachedImpulse=b;})(jigLib);(function(a){var b=function(c,d){if(c==null){c=0.25;}if(d==null){d=0.25;}this._restitution=c;this._friction=d;};b.prototype._restitution=null;b.prototype._friction=null;b.prototype.get_restitution=function(){return this._restitution;};b.prototype.set_restitution=function(c){this._restitution=c;};b.prototype.get_friction=function(){return this._friction;};b.prototype.set_friction=function(c){this._friction=c;};a.MaterialProperties=b;})(jigLib);(function(a){var b=function(){this._controllerEnabled=false;};b.prototype._controllerEnabled=null;b.prototype.updateController=function(c){};b.prototype.enableController=function(){if(this._controllerEnabled){return;}this._controllerEnabled=true;a.PhysicsSystem.getInstance().addController(this);};b.prototype.disableController=function(){if(!this._controllerEnabled){return;}this._controllerEnabled=false;a.PhysicsSystem.getInstance().removeController(this);};b.prototype.get_controllerEnabled=function(){return this._controllerEnabled;};a.PhysicsController=b;})(jigLib);(function(c){var f=c.Matrix3D;var e=c.JMaths3D;var b=c.JMatrix3D;var d=c.JNumber3D;var a=function(){this.position=[0,0,0,0];this._orientation=new f();this.linVelocity=[0,0,0,0];this.rotVelocity=[0,0,0,0];this.orientationCols=[];this.orientationCols[0]=[0,0,0,0];this.orientationCols[1]=[0,0,0,0];this.orientationCols[2]=[0,0,0,0];};a.prototype.get_orientation=function(){return this._orientation;};a.prototype.set_orientation=function(h){this._orientation=h;var g=this._orientation.glmatrix;this.orientationCols[0][0]=g[0];this.orientationCols[0][1]=g[1];this.orientationCols[0][2]=g[2];this.orientationCols[1][0]=g[4];this.orientationCols[1][1]=g[5];this.orientationCols[1][2]=g[6];this.orientationCols[2][0]=g[8];this.orientationCols[2][1]=g[9];this.orientationCols[2][2]=g[10];};a.prototype.getOrientationCols=function(){return b.getCols(this._orientation);};c.PhysicsState=a;})(jigLib);(function(d){var j=d.Vector3DUtil;var g=d.JConfig;var h=d.Matrix3D;var e=d.JMatrix3D;var a=d.JNumber3D;var c=d.MaterialProperties;var b=d.PhysicsState;var f=d.PhysicsSystem;var i=d.JAABox;var k=function(l){this._useDegrees=(g.rotationType=="DEGREES")?true:false;this._id=k.idCounter++;this._skin=l;this._material=new c();this._bodyInertia=new h();this._bodyInvInertia=e.getInverseMatrix(this._bodyInertia);this._currState=new b();this._oldState=new b();this._storeState=new b();this._invOrientation=e.getInverseMatrix(this._currState.get_orientation());this._currLinVelocityAux=[0,0,0,0];this._currRotVelocityAux=[0,0,0,0];this._force=[0,0,0,0];this._torque=[0,0,0,0];this._linVelDamping=[0.995,0.995,0.995,0];this._rotVelDamping=[0.5,0.5,0.5,0];this._maxLinVelocities=500;this._maxRotVelocities=50;this._velChanged=false;this._inactiveTime=0;this._doShockProcessing=true;this.isActive=this._activity=true;this._movable=true;this._origMovable=true;this.collisions=[];this._constraints=[];this._nonCollidables=[];this._storedPositionForActivation=[0,0,0,0];this._bodiesToBeActivatedOnMovement=[];this._lastPositionForDeactivation=this._currState.position.slice(0);this._lastOrientationForDeactivation=this._currState.get_orientation().clone();this._type="Object3D";this._boundingSphere=0;this._boundingBox=new i([0,0,0,0],[0,0,0,0]);this._boundingBox.clear();};k.idCounter=0;k.prototype._id=null;k.prototype._skin=null;k.prototype._type=null;k.prototype._boundingSphere=null;k.prototype._boundingBox=null;k.prototype._currState=null;k.prototype._oldState=null;k.prototype._storeState=null;k.prototype._invOrientation=null;k.prototype._currLinVelocityAux=null;k.prototype._currRotVelocityAux=null;k.prototype._mass=null;k.prototype._invMass=null;k.prototype._bodyInertia=null;k.prototype._bodyInvInertia=null;k.prototype._worldInertia=null;k.prototype._worldInvInertia=null;k.prototype._force=null;k.prototype._torque=null;k.prototype._linVelDamping=null;k.prototype._rotVelDamping=null;k.prototype._maxLinVelocities=null;k.prototype._maxRotVelocities=null;k.prototype._velChanged=null;k.prototype._activity=null;k.prototype._movable=null;k.prototype._origMovable=null;k.prototype._inactiveTime=null;k.prototype._doShockProcessing=null;k.prototype._bodiesToBeActivatedOnMovement=null;k.prototype._storedPositionForActivation=null;k.prototype._lastPositionForDeactivation=null;k.prototype._lastOrientationForDeactivation=null;k.prototype._material=null;k.prototype._rotationX=0;k.prototype._rotationY=0;k.prototype._rotationZ=0;k.prototype._useDegrees=null;k.prototype._nonCollidables=null;k.prototype._constraints=null;k.prototype.collisions=null;k.prototype.isActive=null;k.prototype.radiansToDegrees=function(l){return l*180/Math.PI;};k.prototype.degreesToRadians=function(l){return l*Math.PI/180;};k.prototype.get_rotationX=function(){return this._rotationX;};k.prototype.get_rotationY=function(){return this._rotationY;};k.prototype.get_rotationZ=function(){return this._rotationZ;};k.prototype.set_rotationX=function(l){this._rotationX=l;this.setOrientation(this.createRotationMatrix());};k.prototype.set_rotationY=function(l){this._rotationY=l;this.setOrientation(this.createRotationMatrix());};k.prototype.set_rotationZ=function(l){this._rotationZ=l;this.setOrientation(this.createRotationMatrix());};k.prototype.setRotation=function(l){this._rotationX=l[0];this._rotationY=l[1];this._rotationZ=l[2];this.setOrientation(this.createRotationMatrix());};k.prototype.pitch=function(l){this.setOrientation(e.getAppendMatrix3D(this.get_currentState().orientation,e.getRotationMatrixAxis(l,j.X_AXIS)));};k.prototype.yaw=function(l){this.setOrientation(e.getAppendMatrix3D(this.get_currentState().orientation,e.getRotationMatrixAxis(l,j.Y_AXIS)));};k.prototype.roll=function(l){this.setOrientation(e.getAppendMatrix3D(this.get_currentState().orientation,e.getRotationMatrixAxis(l,j.Z_AXIS)));};k.prototype.createRotationMatrix=function(){var l=new h();l.appendRotation(this._rotationX,j.X_AXIS);l.appendRotation(this._rotationY,j.Y_AXIS);l.appendRotation(this._rotationZ,j.Z_AXIS);return l;};k.prototype.setOrientation=function(l){this._currState.set_orientation(l.clone());this.updateInertia();this.updateState();};k.prototype.get_position=function(){return this._currState.position;};k.prototype.get_x=function(){return this._currState.position[0];};k.prototype.get_y=function(){return this._currState.position[1];};k.prototype.get_z=function(){return _currState.position[2];};k.prototype.set_x=function(l){this._currState.position[0]=l;this.updateState();};k.prototype.set_y=function(l){this._currState.position[1]=l;this.updateState();};k.prototype.set_z=function(l){this._currState.position[2]=l;this.updateState();};k.prototype.moveTo=function(l){this._currState.position=l.slice(0);this.updateState();};k.prototype.updateState=function(){this._currState.linVelocity=[0,0,0,0];this._currState.rotVelocity=[0,0,0,0];this.copyCurrentStateToOld();this.updateBoundingBox();};k.prototype.setVelocity=function(l){this._currState.linVelocity=l.slice(0);};k.prototype.setAngVel=function(l){this._currState.rotVelocity=l.slice(0);};k.prototype.setVelocityAux=function(l){this._currLinVelocityAux=l.slice(0);};k.prototype.setAngVelAux=function(l){this._currRotVelocityAux=l.slice(0);};k.prototype.addGravity=function(){if(!this._movable){return;}this._force=j.add(this._force,a.getScaleVector(d.PhysicsSystem.getInstance().get_gravity(),this._mass));this._velChanged=true;};k.prototype.addExternalForces=function(l){this.addGravity();};k.prototype.addWorldTorque=function(l){if(!this._movable){return;}this._torque=j.add(this._torque,l);this._velChanged=true;this.setActive();};k.prototype.addBodyTorque=function(l){if(!this._movable){return;}e.multiplyVector(this._currState.get_orientation(),l);this.addWorldTorque(l);};k.prototype.addWorldForce=function(l,m){if(!this._movable){return;}this._force=j.add(this._force,l);this.addWorldTorque(j.crossProduct(j.subtract(m,this._currState.position),l));this._velChanged=true;this.setActive();};k.prototype.addBodyForce=function(l,m){if(!this._movable){return;}e.multiplyVector(this._currState.get_orientation(),l);e.multiplyVector(this._currState.get_orientation(),m);this.addWorldForce(l,j.add(this._currState.position,m));};k.prototype.clearForces=function(){this._force=[0,0,0,0];this._torque=[0,0,0,0];};k.prototype.applyWorldImpulse=function(m,n){if(!this._movable){return;}this._currState.linVelocity=j.add(this._currState.linVelocity,a.getScaleVector(m,this._invMass));var l=j.crossProduct(j.subtract(n,this._currState.position),m);e.multiplyVector(this._worldInvInertia,l);this._currState.rotVelocity=j.add(this._currState.rotVelocity,l);this._velChanged=true;};k.prototype.applyWorldImpulseAux=function(m,n){if(!this._movable){return;}this._currLinVelocityAux=j.add(this._currLinVelocityAux,a.getScaleVector(m,this._invMass));var l=j.crossProduct(j.subtract(n,this._currState.position),m);e.multiplyVector(this._worldInvInertia,l);this._currRotVelocityAux=j.add(this._currRotVelocityAux,l);this._velChanged=true;};k.prototype.applyBodyWorldImpulse=function(m,n){if(!this._movable){return;}this._currState.linVelocity=j.add(this._currState.linVelocity,a.getScaleVector(m,this._invMass));var l=j.crossProduct(n,m);e.multiplyVector(this._worldInvInertia,l);this._currState.rotVelocity=j.add(this._currState.rotVelocity,l);this._velChanged=true;};k.prototype.applyBodyWorldImpulseAux=function(m,n){if(!this._movable){return;}this._currLinVelocityAux=j.add(this._currLinVelocityAux,a.getScaleVector(m,this._invMass));var l=j.crossProduct(n,m);e.multiplyVector(this._worldInvInertia,l);this._currRotVelocityAux=j.add(this._currRotVelocityAux,l);this._velChanged=true;};k.prototype.addConstraint=function(l){if(!this.findConstraint(l)){this._constraints.push(l);}};k.prototype.removeConstraint=function(l){if(this.findConstraint(l)){this._constraints.splice(this._constraints.indexOf(l),1);}};k.prototype.removeAllConstraints=function(){this._constraints=[];};k.prototype.findConstraint=function(n){for(var m=0,l=this._constraints.length;m<l;m++){if(n==this._constraints[m]){return true;}}return false;};k.prototype.updateVelocity=function(m){if(!this._movable||!this._activity){return;}this._currState.linVelocity=j.add(this._currState.linVelocity,a.getScaleVector(this._force,this._invMass*m));var l=a.getScaleVector(this._torque,m);e.multiplyVector(this._worldInvInertia,l);this._currState.rotVelocity=j.add(this._currState.rotVelocity,l);};k.prototype.updatePositionWithAux=function(q){if(!this._movable||!this._activity){this._currLinVelocityAux=[0,0,0,0];this._currRotVelocityAux=[0,0,0,0];return;}var r=d.PhysicsSystem.getInstance().get_gravityAxis();if(r!=-1){var l=this._currLinVelocityAux.slice(0);l[(r+1)%3]*=0.1;l[(r+2)%3]*=0.1;a.copyFromArray(this._currLinVelocityAux,l);}var n=this._currState.rotVelocity.slice(0);e.multiplyVector(this._worldInertia,n);this._currState.position=j.add(this._currState.position,a.getScaleVector(j.add(this._currState.linVelocity,this._currLinVelocityAux),q));var p=j.add(this._currState.rotVelocity,this._currRotVelocityAux);var o=j.get_length(p)*180/Math.PI;if(o>0){j.normalize(p);o*=q;var m=e.getRotationMatrix(p[0],p[1],p[2],o);this._currState.set_orientation(e.getAppendMatrix3D(this._currState.get_orientation(),m));this.updateInertia();}this._currLinVelocityAux=[0,0,0,0];this._currRotVelocityAux=[0,0,0,0];e.multiplyVector(this._worldInvInertia,n);this._currState.rotVelocity=n.slice(0);this.updateBoundingBox();};k.prototype.postPhysics=function(l){};k.prototype.tryToFreeze=function(m){if(!this._movable||!this._activity){return;}if(j.get_length(j.subtract(this._currState.position,this._lastPositionForDeactivation))>g.posThreshold){this._lastPositionForDeactivation=this._currState.position.slice(0);this._inactiveTime=0;return;}var l=g.orientThreshold;var o=e.getSubMatrix(this._currState.get_orientation(),this._lastOrientationForDeactivation);var n=e.getCols(o);if(j.get_length(n[0])>l||j.get_length(n[1])>l||j.get_length(n[2])>l){this._lastOrientationForDeactivation=this._currState.get_orientation().clone();this._inactiveTime=0;return;}if(this.getShouldBeActive()){return;}this._inactiveTime+=m;if(this._inactiveTime>g.deactivationTime){this._lastPositionForDeactivation=this._currState.position.slice(0);this._lastOrientationForDeactivation=this._currState.get_orientation().clone();this.setInactive();}};k.prototype.set_mass=function(l){this._mass=l;this._invMass=1/l;this.setInertia(this.getInertiaProperties(l));};k.prototype.setInertia=function(l){this._bodyInertia=l.clone();this._bodyInvInertia=e.getInverseMatrix(this._bodyInertia.clone());this.updateInertia();};k.prototype.updateInertia=function(){this._invOrientation=e.getTransposeMatrix(this._currState.get_orientation());this._worldInertia=e.getAppendMatrix3D(this._invOrientation,e.getAppendMatrix3D(this._currState.get_orientation(),this._bodyInertia));this._worldInvInertia=e.getAppendMatrix3D(this._invOrientation,e.getAppendMatrix3D(this._currState.get_orientation(),this._bodyInvInertia));};k.prototype.get_movable=function(){return this._movable;};k.prototype.set_movable=function(l){if(this._type=="PLANE"||this._type=="TERRAIN"){return;}this._movable=l;this.isActive=this._activity=l;this._origMovable=l;};k.prototype.internalSetImmovable=function(){if(this._type=="PLANE"||this._type=="TERRAIN"){return;}this._origMovable=this._movable;this._movable=false;};k.prototype.internalRestoreImmovable=function(){if(this._type=="PLANE"||this._type=="TERRAIN"){return;}this._movable=this._origMovable;};k.prototype.getVelChanged=function(){return this._velChanged;};k.prototype.clearVelChanged=function(){this._velChanged=false;};k.prototype.setActive=function(l){if(!l){l=1;}if(this._movable){this.isActive=this._activity=true;this._inactiveTime=(1-l)*g.deactivationTime;}};k.prototype.setInactive=function(){if(this._movable){this.isActive=this._activity=false;}};k.prototype.getVelocity=function(l){return j.add(this._currState.linVelocity,j.crossProduct(this._currState.rotVelocity,l));};k.prototype.getVelocityAux=function(l){return j.add(this._currLinVelocityAux,j.crossProduct(this._currRotVelocityAux,l));};k.prototype.getShouldBeActive=function(){return((j.get_length(this._currState.linVelocity)>g.velThreshold)||(j.get_length(this._currState.rotVelocity)>g.angVelThreshold));};k.prototype.getShouldBeActiveAux=function(){return((j.get_length(this._currLinVelocityAux)>g.velThreshold)||(j.get_length(this._currRotVelocityAux)>g.angVelThreshold));};k.prototype.dampForDeactivation=function(){this._currState.linVelocity[0]*=this._linVelDamping[0];this._currState.linVelocity[1]*=this._linVelDamping[1];this._currState.linVelocity[2]*=this._linVelDamping[2];this._currState.rotVelocity[0]*=this._rotVelDamping[0];this._currState.rotVelocity[1]*=this._rotVelDamping[1];this._currState.rotVelocity[2]*=this._rotVelDamping[2];this._currLinVelocityAux[0]*=this._linVelDamping[0];this._currLinVelocityAux[1]*=this._linVelDamping[1];this._currLinVelocityAux[2]*=this._linVelDamping[2];this._currRotVelocityAux[0]*=this._rotVelDamping[0];this._currRotVelocityAux[1]*=this._rotVelDamping[1];this._currRotVelocityAux[2]*=this._rotVelDamping[2];var m=0.5;var l=this._inactiveTime/g.deactivationTime;if(l<m){return;}var n=1-((l-m)/(1-m));if(n<0){n=0;}else{if(n>1){n=1;}}this._currState.linVelocity=a.getScaleVector(this._currState.linVelocity,n);this._currState.rotVelocity=a.getScaleVector(this._currState.rotVelocity,n);};k.prototype.doMovementActivations=function(){var l=this._bodiesToBeActivatedOnMovement.length;if(l==0||j.get_length(j.subtract(this._currState.position,this._storedPositionForActivation))<g.posThreshold){return;}for(var m=0;m<l;m++){d.PhysicsSystem.getInstance().activateObject(this._bodiesToBeActivatedOnMovement[m]);}this._bodiesToBeActivatedOnMovement=[];};k.prototype.addMovementActivation=function(o,n){var l=this._bodiesToBeActivatedOnMovement.length;for(var m=0;m<l;m++){if(this._bodiesToBeActivatedOnMovement[m]==n){return;}}if(this._bodiesToBeActivatedOnMovement.length==0){this._storedPositionForActivation=o;}this._bodiesToBeActivatedOnMovement.push(n);};k.prototype.setConstraintsAndCollisionsUnsatisfied=function(){for(var m=0,l=this._constraints.length;m<l;m++){this._constraints[m].set_satisfied(false);}for(var m=0,n=this.collisions.length;m<n;m++){this.collisions[m].satisfied=false;}};k.prototype.segmentIntersect=function(m,l,n){return false;};k.prototype.getInertiaProperties=function(l){return new h();};k.prototype.updateBoundingBox=function(){};k.prototype.hitTestObject3D=function(l){var n=j.get_length(j.subtract(this._currState.position,l.get_currentState().position));var m=this._boundingSphere+l.get_boundingSphere();if(n<=m){return true;}return false;};k.prototype.findNonCollidablesBody=function(l){for(var n=0,m=this._nonCollidables.length;n<m;n++){if(l==this._nonCollidables[n]){return true;}}return false;};k.prototype.disableCollisions=function(l){if(!this.findNonCollidablesBody(l)){this._nonCollidables.push(l);}};k.prototype.enableCollisions=function(l){if(this.findNonCollidablesBody(l)){this._nonCollidables.splice(this._nonCollidables.indexOf(l),1);}};k.prototype.copyCurrentStateToOld=function(){this._oldState.position=this._currState.position.slice(0);this._oldState.set_orientation(this._currState.get_orientation().clone());this._oldState.linVelocity=this._currState.linVelocity.slice(0);this._oldState.rotVelocity=this._currState.rotVelocity.slice(0);};k.prototype.storeState=function(){this._storeState.position=this._currState.position.slice(0);this._storeState.set_orientation(this._currState.get_orientation().clone());this._storeState.linVelocity=this._currState.linVelocity.slice(0);this._storeState.rotVelocity=this._currState.rotVelocity.slice(0);};k.prototype.restoreState=function(){this._currState.position=this._storeState.position.slice(0);this._currState.set_orientation(this._storeState.get_orientation().clone());this._currState.linVelocity=this._storeState.linVelocity.slice(0);
this._currState.rotVelocity=this._storeState.rotVelocity.slice(0);};k.prototype.get_currentState=function(){return this._currState;};k.prototype.get_oldState=function(){return this._oldState;};k.prototype.get_id=function(){return this._id;};k.prototype.get_type=function(){return this._type;};k.prototype.get_skin=function(){return this._skin;};k.prototype.get_boundingSphere=function(){return this._boundingSphere;};k.prototype.get_boundingBox=function(){return this._boundingBox;};k.prototype.get_force=function(){return this._force;};k.prototype.get_mass=function(){return this._mass;};k.prototype.get_invMass=function(){return this._invMass;};k.prototype.get_worldInertia=function(){return this._worldInertia;};k.prototype.get_worldInvInertia=function(){return this._worldInvInertia;};k.prototype.get_nonCollidables=function(){return this._nonCollidables;};k.prototype.get_doShockProcessing=function(){return this._doShockProcessing;};k.prototype.set_doShockProcessing=function(l){this._doShockProcessing=l;};k.prototype.set_linVelocityDamping=function(l){this._linVelDamping[0]=a.getLimiteNumber(l[0],0,1);this._linVelDamping[1]=a.getLimiteNumber(l[1],0,1);this._linVelDamping[2]=a.getLimiteNumber(l[2],0,1);};k.prototype.get_linVelocityDamping=function(){return this._linVelDamping;};k.prototype.set_rotVelocityDamping=function(l){this._rotVelDamping[0]=a.getLimiteNumber(l[0],0,1);this._rotVelDamping[1]=a.getLimiteNumber(l[1],0,1);this._rotVelDamping[2]=a.getLimiteNumber(l[2],0,1);};k.prototype.get_rotVelocityDamping=function(){return this._rotVelDamping;};k.prototype.set_maxLinVelocities=function(l){this._maxLinVelocities=a.getLimiteNumber(Math.abs(l),0,500);};k.prototype.get_maxLinVelocities=function(){return this._maxLinVelocities;};k.prototype.set_maxRotVelocities=function(l){this._maxRotVelocities=a.getLimiteNumber(Math.abs(l),a.NUM_TINY,50);};k.prototype.get_maxRotVelocities=function(){return this._maxRotVelocities;};k.prototype.limitVel=function(){this._currState.linVelocity[0]=a.getLimiteNumber(this._currState.linVelocity[0],-this._maxLinVelocities,this._maxLinVelocities);this._currState.linVelocity[1]=a.getLimiteNumber(this._currState.linVelocity[1],-this._maxLinVelocities,this._maxLinVelocities);this._currState.linVelocity[2]=a.getLimiteNumber(this._currState.linVelocity[2],-this._maxLinVelocities,this._maxLinVelocities);};k.prototype.limitAngVel=function(){var n=Math.abs(this._currState.rotVelocity[0])/this._maxRotVelocities;var m=Math.abs(this._currState.rotVelocity[1])/this._maxRotVelocities;var l=Math.abs(this._currState.rotVelocity[2])/this._maxRotVelocities;var o=Math.max(n,m,l);if(o>1){this._currState.rotVelocity=a.getDivideVector(this._currState.rotVelocity,o);}};k.prototype.getTransform=function(){if(this._skin!=null){return this._skin.get_transform();}else{return null;}};k.prototype.updateObject3D=function(){if(this._skin!=null){this._skin.set_transform(e.getAppendMatrix3D(this._currState.get_orientation(),e.getTranslationMatrix(this._currState.position[0],this._currState.position[1],this._currState.position[2])));}};k.prototype.get_material=function(){return this._material;};k.prototype.get_restitution=function(){return this._material.get_restitution();};k.prototype.set_restitution=function(l){this._material.set_restitution(a.getLimiteNumber(l,0,1));};k.prototype.get_friction=function(){return this._material.get_friction();};k.prototype.set_friction=function(l){this._material.set_friction(a.getLimiteNumber(l,0,1));};d.RigidBody=k;})(jigLib);(function(a){var b=function(){this.enabled=true;};b.prototype._eventEnabled=false;b.prototype.__defineGetter__("enabled",function(){return this._eventEnabled;});b.prototype.__defineSetter__("enabled",function(c){if(c==this._eventEnabled){return;}this._eventEnabled=c;if(c){a.PhysicsSystem.getInstance().addEvent(this);}else{a.PhysicsSystem.getInstance().removeEvent(this);}});b.prototype.Apply=function(){return false;};a.JEffect=b;})(jigLib);(function(a){var b=a.Vector3DUtil;var c=function(e,f,d,h,g){this.Super();this.location=e;this.radius=f;this.force=d;if(h){this.parent=h;}if(h&&g){this.relativity=true;}this.enabled=false;};a.extend(c,a.JEffect);c.prototype.location=null;c.prototype.radius=null;c.prototype.force=null;c.prototype.parent=null;c.prototype.relativity=false;c.prototype.explode=function(){this.enabled=true;};c.prototype.Apply=function(){this.enabled=false;var g=a.PhysicsSystem.getInstance();var e=g.get_bodies();var f=e.length;var l,k,h,j;var d=[0,0,0,0];if(this.parent){this.location=this.parent.get_position();}this._affectedBodies=[];while(f--){l=e[f];if(this.parent&&l==this.parent){continue;}if(l._type!="PLANE"){k=b.distance(l.get_position(),this.location);if(k<this.radius){j=b.subtract(l.get_position(),this.location);h=(1-(k/this.radius))*this.force;b.scaleBy(j,h);if(this.relativity){d=b.add(j,d);}if(l.get_movable()){g.activateObject(l);l.addWorldForce(j,this.location);}}}else{if(this.relativity){k=l.pointPlaneDistance(this.location);if(k<this.radius){j=b.negate(l.get_normal().slice(0));h=(1-(k/this.radius))*(this.force*2);b.scaleBy(j,h);d=b.add(j,d);}}}}if(this.relativity){b.limitSum(d,this.force);b.negate(d);g.activateObject(this.parent);this.parent.applyWorldImpulse(d,this.location);}};a.Explosion=c;})(jigLib);(function(a){var c=a.Vector3DUtil;var b=function(e,f,d,g){this.Super();this.location=e;this.radius=f;this.force=d;if(g){this.parent=g;}};a.extend(b,a.JEffect);b.prototype.location=null;b.prototype.radius=null;b.prototype.force=null;b.prototype.parent=null;b.prototype.Apply=function(){var f=a.PhysicsSystem.getInstance();var d=f.get_bodies();var e=d.length-1;var k,j,g,h;if(this.parent){this.location=this.parent.get_position();}this._affectedBodies=[];do{k=d[e];if(!k.get_movable()||(this.parent&&k==this.parent)){continue;}j=c.distance(k.get_position(),this.location);if(j<this.radius){h=c.subtract(k.get_position(),this.location);g=(1-(j/this.radius))*this.force;c.scaleBy(h,g);c.negate(h);f.activateObject(k);k.applyWorldImpulse(h,this.location);}}while(e--);};a.GravityField=b;})(jigLib);(function(a){var b=a.Vector3DUtil;var c=function(d,e){this.Super();this.direction=d;if(e){this.exclusions=e;}};a.extend(c,a.JEffect);c.prototype.direction=null;c.prototype.exclusions=[];c.prototype.isExcluded=function(d){var e=this.exclusions.length;while(e--){if(this.exclusions[e]==d){return true;}}return false;};c.prototype.Apply=function(){var f=a.PhysicsSystem.getInstance();var d=f.get_bodies();var e=d.length;var g;this._affectedBodies=[];while(e--){g=d[e];if(!g.get_movable()||this.isExcluded(g)){continue;}f.activateObject(g);g.applyWorldImpulse(this.direction,g.get_position());}};a.Wind=c;})(jigLib);(function(c){var g=c.Vector3DUtil;var b=c.JMatrix3D;var d=c.JNumber3D;var h=c.RigidBody;var f=c.EdgeData;var e=c.SpanData;var a=function(k,j,l,i){c.RigidBody.call(this);this._edges=[new f(0,1),new f(3,1),new f(2,3),new f(2,0),new f(4,5),new f(5,7),new f(6,7),new f(4,6),new f(7,1),new f(5,3),new f(4,2),new f(6,0)];this._faces=[[6,7,1,0],[5,4,2,3],[3,1,7,5],[4,6,0,2],[1,3,2,0],[7,6,4,5]];this._type="BOX";this._sideLengths=g.create(j,i,l,0);this._boundingSphere=0.5*g.get_length(this._sideLengths);this.initPoints();this.set_mass(1);this.updateBoundingBox();};c.extend(a,c.RigidBody);a.prototype._sideLengths=null;a.prototype._points=null;a.prototype._edges=null;a.prototype._faces=null;a.prototype.initPoints=function(){var i=this.getHalfSideLengths();this._points=[];this._points[0]=g.create(i[0],-i[1],i[2],0);this._points[1]=g.create(i[0],i[1],i[2],0);this._points[2]=g.create(-i[0],-i[1],i[2],0);this._points[3]=g.create(-i[0],i[1],i[2],0);this._points[4]=g.create(-i[0],-i[1],-i[2],0);this._points[5]=g.create(-i[0],i[1],-i[2],0);this._points[6]=g.create(i[0],-i[1],-i[2],0);this._points[7]=g.create(i[0],i[1],-i[2],0);};a.prototype.set_sideLengths=function(i){this._sideLengths=i.slice(0);this._boundingSphere=0.5*g.get_length(this._sideLengths);this.initPoints();this.setInertia(this.getInertiaProperties(this.get_mass()));this.setActive();this.updateBoundingBox();};a.prototype.get_sideLengths=function(){return this._sideLengths;};a.prototype.get_edges=function(){return this._edges;};a.prototype.getVolume=function(){return(this._sideLengths[0]*this._sideLengths[1]*this._sideLengths[2]);};a.prototype.getSurfaceArea=function(){return 2*(this._sideLengths[0]*this._sideLengths[1]+this._sideLengths[0]*this._sideLengths[2]+this._sideLengths[1]*this._sideLengths[2]);};a.prototype.getHalfSideLengths=function(){return d.getScaleVector(this._sideLengths,0.5);};a.prototype.getSpan=function(k){var o=this.get_currentState().getOrientationCols();var n=new e();var j=Math.abs(g.dotProduct(k,o[0]))*(0.5*this._sideLengths[0]);var i=Math.abs(g.dotProduct(k,o[1]))*(0.5*this._sideLengths[1]);var q=Math.abs(g.dotProduct(k,o[2]))*(0.5*this._sideLengths[2]);var l=j+i+q;var m=g.dotProduct(this.get_currentState().position,k);n.min=m-l;n.max=m+l;return n;};a.prototype.getCornerPoints=function(p){var o;var j=[];var k=b.getTranslationMatrix(p.position[0],p.position[1],p.position[2]);k=b.getAppendMatrix3D(p.get_orientation(),k);for(var l=0,m=this._points.length;l<m;l++){var n=this._points[l];o=g.create(n[0],n[1],n[2],0);b.multiplyVector(k,o);j.push(o);}return j;};a.prototype.getCornerPointsInBoxSpace=function(l,p){var k=b.getTransposeMatrix(p.get_orientation());var q=g.subtract(l.position,p.position);b.multiplyVector(k,q);var n=b.getAppendMatrix3D(l.get_orientation(),k);var j=[];var m=b.getTranslationMatrix(q[0],q[1],q[2]);m=b.getAppendMatrix3D(n,m);for(var o=0;o<this._points.length;o++){_point=this._points[o].slice(0);b.multiplyVector(m,_point);j[o]=_point;}return j;};a.prototype.getSqDistanceToPoint=function(m,k,j){k.pos=g.subtract(j,m.position);b.multiplyVector(b.getTransposeMatrix(m.get_orientation()),k.pos);var n=0;var l=0;var i=this.getHalfSideLengths();if(k.pos[0]<-i[0]){n=k.pos[0]+i[0];l+=(n*n);k.pos[0]=-i[0];}else{if(k.pos[0]>i[0]){n=k.pos[0]-i[0];l+=(n*n);k.pos[0]=i[0];}}if(k.pos[1]<-i[1]){n=k.pos[1]+i[1];l+=(n*n);k.pos[1]=-i[1];}else{if(k.pos[1]>i[1]){n=k.pos[1]-i[1];l+=(n*n);k.pos[1]=i[1];}}if(k.pos[2]<-i[2]){n=k.pos[2]+i[2];l+=(n*n);k.pos[2]=-i[2];}else{if(k.pos[2]>i[2]){n=(k.pos[2]-i[2]);l+=(n*n);k.pos[2]=i[2];}}b.multiplyVector(m.get_orientation(),k.pos);k.pos=g.add(m.position,k.pos);return l;};a.prototype.getDistanceToPoint=function(k,j,i){return Math.sqrt(this.getSqDistanceToPoint(k,j,i));};a.prototype.pointIntersect=function(n){var m=g.subtract(n,this.get_currentState().position);var k=d.getScaleVector(this._sideLengths,0.5);var j;var l=this.get_currentState().getOrientationCols();for(var i;i<3;i++){j=l[i].slice(0);g.normalize(j);if(Math.abs(g.dotProduct(j,m))>k[i]+d.NUM_TINY){return false;}}return true;};a.prototype.getSupportVertices=function(p){var v=[];var w=[1,1,1];var x;var y=this.get_currentState().getOrientationCols();g.normalize(y[0]);g.normalize(y[1]);g.normalize(y[2]);for(var s=0;s<3;s++){w[s]=g.dotProduct(p,y[s]);if(Math.abs(w[s])>1-0.001){var u=(w[s]<0)?(s*2):(s*2)+1;for(var r=0;r<4;r++){x=this._points[this._faces[u][r]];var z=v[r]=this.get_currentState().position.slice(0);z=g.add(z,d.getScaleVector(y[0],x[0]));z=g.add(z,d.getScaleVector(y[1],x[1]));z=g.add(z,d.getScaleVector(y[2],x[2]));}return v;}}for(s=0;s<3;s++){if(Math.abs(w[s])<0.005){var q;var o=(s+1)%3;var l=(s+2)%3;x=this.get_currentState().position.slice(0);q=(w[o]>0)?-1:1;x=g.add(x,d.getScaleVector(y[o],q*this._sideLengths[o]/2));q=(w[l]>0)?-1:1;x=g.add(x,d.getScaleVector(y[l],q*this._sideLengths[l]/2));v[0]=g.add(x,d.getScaleVector(y[s],this._sideLengths[s]/2));v[1]=g.add(x,d.getScaleVector(y[s],-this._sideLengths[s]/2));return v;}}var t=v[0]=this.get_currentState().position.slice(0);q=(w[0]>0)?-1:1;v[0]=g.add(t,d.getScaleVector(y[0],q*this._sideLengths[0]/2));q=(w[1]>0)?-1:1;v[0]=g.add(t,d.getScaleVector(y[1],q*this._sideLengths[1]/2));q=(w[2]>0)?-1:1;v[0]=g.add(t,d.getScaleVector(y[2],q*this._sideLengths[2]/2));return v;};a.prototype.segmentIntersect=function(x,z,k){x.fracOut=0;x.posOut=[0,0,0,0];x.normalOut=[0,0,0,0];var j=d.NUM_HUGE;var v=-d.NUM_HUGE;var w=d.NUM_HUGE;var C=0;var i=0;var u=0;var s=g.subtract(k.position,z.origin);var y=d.getScaleVector(this._sideLengths,0.5);var B;var A;var q;var n;var m;var o=k.getOrientationCols();var r=y.slice(0);var l;for(u=0;u<3;u++){l=r[u];B=g.dotProduct(o[u],s);A=g.dotProduct(o[u],z.delta);if(Math.abs(A)>d.NUM_TINY){n=(B+l)/A;m=(B-l)/A;if(n>m){q=n;n=m;m=q;}if(n>v){v=n;C=u;}if(m<w){w=m;i=u;}if(v>w){return false;}if(w<0){return false;}}else{if(-B-l>0||-B+l<0){return false;}}}if(v>0){u=C;j=v;}else{u=i;j=w;}if(j<0){j=0;}if(j>1-d.NUM_TINY){return false;}x.fracOut=j;x.posOut=z.getPoint(j);if(g.dotProduct(o[u],z.delta)<0){x.normalOut=d.getScaleVector(o[u],-1);}else{x.normalOut=o[u];}return true;};a.prototype.getInertiaProperties=function(i){return b.getScaleMatrix((i/12)*(this._sideLengths[1]*this._sideLengths[1]+this._sideLengths[2]*this._sideLengths[2]),(i/12)*(this._sideLengths[0]*this._sideLengths[0]+this._sideLengths[2]*this._sideLengths[2]),(i/12)*(this._sideLengths[0]*this._sideLengths[0]+this._sideLengths[1]*this._sideLengths[1]));};a.prototype.updateBoundingBox=function(){this._boundingBox.clear();this._boundingBox.addBox(this);};c.JBox=a;})(jigLib);(function(c){var f=c.Vector3DUtil;var b=c.JMatrix3D;var d=c.JNumber3D;var g=c.RigidBody;var h=c.JSegment;var e=function(k,j,i){this.Super(k);this._type="CAPSULE";this._radius=j;this._length=i;this._boundingSphere=this.getBoundingSphere(j,i);this.set_mass(1);this.updateBoundingBox();};c.extend(e,c.RigidBody);e.prototype._length=null;e.prototype._radius=null;e.prototype.set_radius=function(i){this._radius=i;this._boundingSphere=getBoundingSphere(this._radius,this._length);this.setInertia(this.getInertiaProperties(this.get_mass()));this.updateBoundingBox();this.setActive();};e.prototype.get_radius=function(){return this._radius;};e.prototype.set_length=function(i){this._length=i;this._boundingSphere=getBoundingSphere(this._radius,this._length);this.setInertia(this.getInertiaProperties(this.get_mass()));this.updateBoundingBox();this.setActive();};e.prototype.get_length=function(){return this._length;};e.prototype.getBottomPos=function(j){var i=j.getOrientationCols()[1];return f.add(j.position,d.getScaleVector(i,-this._length/2-this._radius));};e.prototype.getEndPos=function(j){var i=j.getOrientationCols()[1];return f.add(j.position,d.getScaleVector(i,this._length/2+this._radius));};e.prototype.segmentIntersect=function(y,A,n){y.fracOut=0;y.posOut=[0,0,0,0];y.normalOut=[0,0,0,0];var j=A.delta;var C=f.dotProduct(j,j);var x=this._radius*this._radius;var u=n.getOrientationCols();var p=new h(getBottomPos(n),u[1]);var r=p.delta;var o=f.subtract(p.origin,A.origin);var s=f.dotProduct(r,r);if(Math.abs(s)<d.NUM_TINY){return false;}var k=f.dotProduct(r,j);var z=f.dotProduct(o,j);var q=f.dotProduct(r,o);var i=f.dotProduct(o,o);var m=f.get_lengthSquared(f.subtract(o,d.getDivideVector(d.getScaleVector(r,q),s)));if(m<x){y.fracOut=0;y.posOut=A.origin.slice(0);y.normalOut=f.subtract(y.posOut,getBottomPos(n));y.normalOut=f.subtract(y.normalOut,d.getScaleVector(u[1],f.dotProduct(y.normalOut,u[1])));f.normalize(y.normalOut);return true;}var w=s*C-(k*k);if(Math.abs(a)<d.NUM_TINY){return false;}var D=2*(q*k-s*z);var B=s*(i-x)-(q*q);var l=(D*D)-4*a*B;if(l<0){return false;}var v=(-D-Math.sqrt(l))/(2*a);if(v<0||v>1){return false;}y.fracOut=v;y.posOut=A.getPoint(v);y.normalOut=f.subtract(y.posOut,getBottomPos(n));y.normalOut=f.subtract(y.normalOut,d.getScaleVector(u[1],f.dotProduct(y.normalOut,u[1])));f.normalize(y.normalOut);return true;};e.prototype.getInertiaProperties=function(i){var l=i*Math.PI*this._radius*this._radius*this._length/this.getVolume();var j=0.25*l*this._radius*this._radius+(1/12)*l*this._length*this._length;var k=0.5*l*this._radius*this._radius;var n=j;var o=i-l;j+=(0.4*o*this._radius*this._radius+o*Math.pow(0.5*this._length,2));k+=(0.2*o*this._radius*this._radius);n+=(0.4*o*this._radius*this._radius+o*Math.pow(0.5*this._length,2));return b.getScaleMatrix(j,k,n);};e.prototype.updateBoundingBox=function(){this._boundingBox.clear();this._boundingBox.addCapsule(this);};e.prototype.getBoundingSphere=function(j,i){return Math.sqrt(Math.pow(i/2,2)+j*j)+j;};e.prototype.getVolume=function(){return(4/3)*Math.PI*this._radius*this._radius*this._radius+this._length*Math.PI*this._radius*this._radius;};c.JCapsule=e;})(jigLib);(function(c){var e=c.Vector3DUtil;var b=c.JMatrix3D;var d=c.JNumber3D;var f=c.RigidBody;var a=function(g,h){this.Super(g);if(h==undefined){this._initNormal=[0,0,-1,0];this._normal=this._initNormal.slice(0);}else{this._initNormal=h.slice(0);this._normal=this._initNormal.slice(0);}this._distance=0;this._type="PLANE";this._movable=false;};c.extend(a,c.RigidBody);a.prototype._initNormal=null;a.prototype._normal=null;a.prototype._distance=null;a.prototype.get_normal=function(){return this._normal;};a.prototype.get_distance=function(){return this._distance;};a.prototype.pointPlaneDistance=function(g){return e.dotProduct(this._normal,g)-this._distance;};a.prototype.segmentIntersect=function(j,g,l){j.fracOut=0;j.posOut=[0,0,0,0];j.normalOut=[0,0,0,0];var i=0;var k;var h=e.dotProduct(this._normal,g.delta);if(Math.abs(h)>d.NUM_TINY){k=-1*(e.dotProduct(this._normal,g.origin)-this._distance)/h;if(k<0||k>1){return false;}else{i=k;j.fracOut=i;j.posOut=g.getPoint(i);j.normalOut=this._normal.slice(0);e.normalize(j.normalOut);return true;}}else{return false;}};a.prototype.updateState=function(){this.Super.prototype.updateState.call(this);this._normal=this._initNormal.slice(0);b.multiplyVector(this._currState._orientation,this._normal);this._distance=e.dotProduct(this._currState.position,this._normal);};c.JPlane=a;})(jigLib);(function(a){var d=a.Vector3DUtil;var b=a.JNumber3D;var c=function(f,e){this.origin=f;this.dir=e;};c.prototype.origin=null;c.prototype.dir=null;c.prototype.getOrigin=function(e){return d.add(this.origin,b.getScaleVector(this.dir,e));};a.JRay=c;})(jigLib);(function(a){var d=a.Vector3DUtil;var b=a.JNumber3D;var c=a.JRay;var e=function(g,f){this.origin=g;this.delta=f;};e.prototype.origin=null;e.prototype.delta=null;e.prototype.getPoint=function(f){return d.add(this.origin,b.getScaleVector(this.delta,f));};e.prototype.getEnd=function(){return d.add(this.origin,this.delta);};e.prototype.clone=function(){return new e(this.origin,this.delta);};e.prototype.segmentSegmentDistanceSq=function(j,k){j.t0=0;j.t1=0;var r=d.subtract(this.origin,k.origin);var o=d.get_lengthSquared(this.delta);var n=-d.dotProduct(this.delta,k.delta);var i=d.get_lengthSquared(k.delta);var h=d.dotProduct(r,this.delta);var m=d.get_lengthSquared(r);var t=Math.abs(o*i-n*n);var g;var s;var q;var l;var p;if(t>=b.NUM_TINY){g=-d.dotProduct(r,k.delta);s=n*g-i*h;q=n*h-o*g;if(s>=0){if(s<=t){if(q>=0){if(q<=t){var f=1/t;s*=f;q*=f;l=s*(o*s+n*q+2*h)+q*(n*s+i*q+2*g)+m;}else{q=1;p=n+h;if(p>=0){s=0;l=i+2*g+m;}else{if(-p>=o){s=1;l=o+i+m+2*(g+p);}else{s=-p/o;l=p*s+i+2*g+m;}}}}else{q=0;if(h>=0){s=0;l=m;}else{if(-h>=o){s=1;l=o+2*h+m;}else{s=-h/o;l=h*s+m;}}}}else{if(q>=0){if(q<=t){s=1;p=n+g;if(p>=0){q=0;l=o+2*h+m;}else{if(-p>=i){q=1;l=o+i+m+2*(h+p);}else{q=-p/i;l=p*q+o+2*h+m;}}}else{p=n+h;if(-p<=o){q=1;if(p>=0){s=0;l=i+2*g+m;}else{s=-p/o;l=p*s+i+2*g+m;}}else{s=1;p=n+g;if(p>=0){q=0;l=o+2*h+m;}else{if(-p>=i){q=1;l=o+i+m+2*(h+p);}else{q=-p/i;l=p*q+o+2*h+m;}}}}}else{if(-h<o){q=0;if(h>=0){s=0;l=m;}else{s=-h/o;l=h*s+m;}}else{s=1;p=n+g;if(p>=0){q=0;l=o+2*h+m;}else{if(-p>=i){q=1;l=o+i+m+2*(h+p);}else{q=-p/i;l=p*q+o+2*h+m;}}}}}}else{if(q>=0){if(q<=t){s=0;if(g>=0){q=0;l=m;}else{if(-g>=i){q=1;l=i+2*g+m;}else{q=-g/i;l=g*q+m;}}}else{p=n+h;if(p<0){q=1;if(-p>=o){s=1;l=o+i+m+2*(g+p);}else{s=-p/o;l=p*s+i+2*g+m;}}else{s=0;if(g>=0){q=0;l=m;}else{if(-g>=i){q=1;l=i+2*g+m;}else{q=-g/i;l=g*q+m;}}}}}else{if(h<0){q=0;if(-h>=o){s=1;l=o+2*h+m;}else{s=-h/o;l=h*s+m;}}else{s=0;if(g>=0){q=0;l=m;}else{if(-g>=i){q=1;l=i+2*g+m;}else{q=-g/i;l=g*q+m;}}}}}}else{if(n>0){if(h>=0){s=0;q=0;l=m;}else{if(-h<=o){s=-h/o;q=0;l=h*s+m;}else{g=-d.dotProduct(r,k.delta);s=1;p=o+h;if(-p>=n){q=1;l=o+i+m+2*(n+h+g);}else{q=-p/n;l=o+2*h+m+q*(i*q+2*(n+g));}}}}else{if(-h>=o){s=1;q=0;l=o+2*h+m;}else{if(h<=0){s=-h/o;q=0;l=h*s+m;}else{g=-d.dotProduct(r,k.delta);s=0;if(h>=-n){q=1;l=i+2*g+m;}else{q=-h/n;l=m+q*(2*g+i*q);}}}}}j.t0=s;j.t1=q;return Math.abs(l);};e.prototype.pointSegmentDistanceSq=function(g,h){g.t=0;var j=d.subtract(h,this.origin);var i=d.dotProduct(j,this.delta);if(i<=0){i=0;}else{var f=d.get_lengthSquared(this._delta);if(i>=f){i=1;j=d.subtract(j,this._delta);}else{i/=f;j=d.subtract(j,b.getScaleVector(this._delta,i));}}g.t=i;return d.get_lengthSquared(j);};e.prototype.segmentBoxDistanceSq=function(g,f,k){g.pfLParam=0;g.pfLParam0=0;g.pfLParam1=0;g.pfLParam2=0;var j={};var i=new c(this.origin,this.delta);var h=this.sqrDistanceLine(j,i,f,k);if(j.num>=0){if(j.num<=1){g.pfLParam=j.num;g.pfLParam0=j.num0;g.pfLParam1=j.num1;g.pfLParam2=j.num2;return Math.max(h,0);}else{h=this.sqrDistancePoint(g,d.add(this.origin,this.delta),f,k);g.pfLParam=1;return Math.max(h,0);}}else{h=this.sqrDistancePoint(g,this.origin,f,k);g.pfLParam=0;return Math.max(h,0);}};e.prototype.sqrDistanceLine=function(l,s,q,o){var h=o.getOrientationCols();l.num=0;l.num0=0;l.num1=0;l.num2=0;var r=d.subtract(s.origin,o.position);var f=d.create(d.dotProduct(r,h[0]),d.dotProduct(r,h[1]),d.dotProduct(r,h[2]),0);var k=d.create(d.dotProduct(s.dir,h[0]),d.dotProduct(s.dir,h[1]),d.dotProduct(s.dir,h[2]),0);var j=f.slice(0);var p=k.slice(0);var g=[1,1,1,0];for(var n=0;n<3;n++){if(p[n]<0){j[n]=-j[n];p[n]=-p[n];g[n]=true;}else{g[n]=false;}}b.copyFromArray(f,j);b.copyFromArray(k,p);var m={};m.rkPnt=f.slice(0);m.pfLParam=0;m.rfSqrDistance=0;if(k[0]>0){if(k[1]>0){if(k[2]>0){this.caseNoZeros(m,k,q);l.num=m.pfLParam;}else{this.case0(m,0,1,2,k,q);l.num=m.pfLParam;}}else{if(k[2]>0){this.case0(m,0,2,1,k,q);l.num=m.pfLParam;}else{this.case00(m,0,1,2,k,q);l.num=m.pfLParam;}}}else{if(k[1]>0){if(k[2]>0){this.case0(m,1,2,0,k,q);l.num=m.pfLParam;}else{this.case00(m,1,0,2,k,q);l.num=m.pfLParam;}}else{if(k[2]>0){this.case00(m,2,0,1,k,q);l.num=m.pfLParam;}else{this.case000(m,q);l.num=0;}}}j=m.rkPnt.slice(0);for(n=0;n<3;n++){if(g[n]){j[n]=-j[n];}}b.copyFromArray(m.rkPnt,j);l.num0=m.rkPnt[0];l.num1=m.rkPnt[1];l.num2=m.rkPnt[2];return Math.max(m.rfSqrDistance,0);};e.prototype.sqrDistancePoint=function(h,g,k,i){var m=i.getOrientationCols();var n=d.subtract(g,i.position);var j=d.create(d.dotProduct(n,m[0]),d.dotProduct(n,m[1]),d.dotProduct(n,m[2]),0);var f=0;var o;var l=k.getHalfSideLengths();if(j[0]<-l[0]){o=j[0]+l[0];f+=(o*o);j[0]=-l[0];}else{if(j[0]>l[0]){o=j[0]-l[0];f+=(o*o);j[0]=l[0];}}if(j[1]<-l[1]){o=j[1]+l[1];f+=(o*o);j[1]=-l[1];}else{if(j[1]>l[1]){o=j[1]-l[1];f+=(o*o);j[1]=l[1];}}if(j[2]<-l[2]){o=j[2]+l[2];f+=(o*o);j[2]=-l[2];}else{if(j[2]>l[2]){o=j[2]-l[2];f+=(o*o);j[2]=l[2];}}h.pfLParam0=j[0];h.pfLParam1=j[1];h.pfLParam2=j[2];return Math.max(f,0);};e.prototype.face=function(w,t,s,r,j,f,h){var x=[0,0,0,0];var k;var o;var m;var g;var y;var q;var v=f.getHalfSideLengths();var u=v;var i=w.rkPnt;var l=j;var n=x;var p=h;n[s]=i[s]+u[s];n[r]=i[r]+u[r];b.copyFromArray(h,n);if(l[t]*n[s]>=l[s]*p[t]){if(l[t]*n[r]>=l[r]*p[t]){i[t]=u[t];o=1/l[t];i[s]-=(l[s]*p[t]*o);i[r]-=(l[r]*p[t]*o);w.pfLParam=-p[t]*o;b.copyFromArray(w.rkPnt,i);}else{k=l[t]*l[t]+l[r]*l[r];m=k*n[s]-l[s]*(l[t]*p[t]+l[r]*n[r]);if(m<=2*k*u[s]){y=m/k;k+=(l[s]*l[s]);m=n[s]-y;q=l[t]*p[t]+l[s]*m+l[r]*n[r];g=-q/k;w.rfSqrDistance+=(p[t]*p[t]+m*m+n[r]*n[r]+q*g);w.pfLParam=g;i[t]=u[t];i[s]=y-u[s];i[r]=-u[r];b.copyFromArray(w.rkPnt,i);}else{k+=(l[s]*l[s]);q=l[t]*p[t]+l[s]*p[s]+l[r]*n[r];g=-q/k;w.rfSqrDistance+=(p[t]*p[t]+p[s]*p[s]+n[r]*n[r]+q*g);w.pfLParam=g;i[t]=u[t];i[s]=u[s];i[r]=-u[r];b.copyFromArray(w.rkPnt,i);}}}else{if(l[t]*n[r]>=l[r]*p[t]){k=l[t]*l[t]+l[s]*l[s];m=k*n[r]-l[r]*(l[t]*p[t]+l[s]*n[s]);if(m<=2*k*u[r]){y=m/k;k+=(l[r]*l[r]);m=n[r]-y;q=l[t]*p[t]+l[s]*n[s]+l[r]*m;g=-q/k;w.rfSqrDistance+=(p[t]*p[t]+n[s]*n[s]+m*m+q*g);w.pfLParam=g;i[t]=u[t];i[s]=-u[s];i[r]=y-u[r];b.copyFromArray(w.rkPnt,i);}else{k+=(l[r]*l[r]);q=l[t]*p[t]+l[s]*n[s]+l[r]*p[r];g=-q/k;w.rfSqrDistance+=(p[t]*p[t]+n[s]*n[s]+p[r]*p[r]+q*g);w.pfLParam=g;i[t]=u[t];i[s]=-u[s];i[r]=u[r];b.copyFromArray(w.rkPnt,i);}}else{k=l[t]*l[t]+l[r]*l[r];m=k*n[s]-l[s]*(l[t]*p[t]+l[r]*n[r]);if(m>=0){if(m<=2*k*u[s]){y=m/k;k+=(l[s]*l[s]);m=n[s]-y;q=l[t]*p[t]+l[s]*m+l[r]*n[r];g=-q/k;w.rfSqrDistance+=(p[t]*p[t]+m*m+n[r]*n[r]+q*g);w.pfLParam=g;i[t]=u[t];i[s]=y-u[s];i[r]=-u[r];b.copyFromArray(w.rkPnt,i);}else{k+=(l[s]*l[s]);q=l[t]*p[t]+l[s]*p[s]+l[r]*n[r];g=-q/k;w.rfSqrDistance+=(p[t]*p[t]+p[s]*p[s]+n[r]*n[r]+q*g);w.pfLParam=g;i[t]=u[t];i[s]=u[s];i[r]=-u[r];b.copyFromArray(w.rkPnt,i);}return;}k=l[t]*l[t]+l[s]*l[s];m=k*n[r]-l[r]*(l[t]*p[t]+l[s]*n[s]);if(m>=0){if(m<=2*k*u[r]){y=m/k;k+=(l[r]*l[r]);m=n[r]-y;q=l[t]*p[t]+l[s]*n[s]+l[r]*m;g=-q/k;w.rfSqrDistance+=(p[t]*p[t]+n[s]*n[s]+m*m+q*g);w.pfLParam=g;i[t]=u[t];i[s]=-u[s];i[r]=y-u[r];b.copyFromArray(w.rkPnt,i);}else{k+=(l[r]*l[r]);q=l[t]*p[t]+l[s]*n[s]+l[r]*p[r];g=-q/k;w.rfSqrDistance+=(p[t]*p[t]+n[s]*n[s]+p[r]*p[r]+q*g);w.pfLParam=g;i[t]=u[t];i[s]=-u[s];i[r]=u[r];b.copyFromArray(w.rkPnt,i);}return;}k+=(l[r]*l[r]);q=l[t]*p[t]+l[s]*n[s]+l[r]*n[r];g=-q/k;w.rfSqrDistance+=(p[t]*p[t]+n[s]*n[s]+n[r]*n[r]+q*g);w.pfLParam=g;i[t]=u[t];i[s]=-u[s];i[r]=-u[r];b.copyFromArray(w.rkPnt,i);}}};e.prototype.caseNoZeros=function(i,k,o){var p=o.getHalfSideLengths();var l=d.create(i.rkPnt[0]-p[0],i.rkPnt[1]-p[1],i.rkPnt[2]-p[2],0);var g=k[0]*l[1];var j=k[1]*l[0];var n;var f;var m;var h;if(j>=g){n=k[2]*l[0];f=k[0]*l[2];if(n>=f){this.face(i,0,1,2,k,o,l);}else{this.face(i,2,0,1,k,o,l);}}else{m=k[2]*l[1];h=k[1]*l[2];if(m>=h){this.face(i,1,2,0,k,o,l);}else{this.face(i,2,0,1,k,o,l);}}};e.prototype.case0=function(x,u,t,s,i,f){var w=f.getHalfSideLengths();var v=w.slice(0);var h=x.rkPnt.slice(0);var m=i.slice(0);var q=h[u]-v[u];var p=h[t]-v[t];var j=m[t]*q;var g=m[u]*p;var r;var n;var o;if(j>=g){h[u]=v[u];var k=h[t]+v[t];r=j-m[u]*k;if(r>=0){n=1/(m[u]*m[u]+m[t]*m[t]);x.rfSqrDistance+=(r*r*n);h[t]=-v[t];x.pfLParam=-(m[u]*q+m[t]*k)*n;}else{o=1/m[u];h[t]-=(j*o);x.pfLParam=-q*o;}b.copyFromArray(x.rkPnt,h);}else{h[t]=v[t];var l=h[u]+v[u];r=g-m[t]*l;if(r>=0){n=1/(m[u]*m[u]+m[t]*m[t]);x.rfSqrDistance+=(r*r*n);h[u]=-v[u];x.pfLParam=-(m[u]*l+m[t]*p)*n;}else{o=1/m[t];h[u]-=(g*o);x.pfLParam=-p*o;}b.copyFromArray(x.rkPnt,h);}if(h[s]<-v[s]){r=h[s]+v[s];x.rfSqrDistance+=(r*r);h[s]=-v[s];}else{if(h[s]>v[s]){r=h[s]-v[s];x.rfSqrDistance+=(r*r);h[s]=v[s];}}b.copyFromArray(x.rkPnt,h);};e.prototype.case00=function(j,i,h,g,k,m){var o=0;var n=m.getHalfSideLengths();var f=n.slice(0);var l=j.rkPnt.slice(0);var p=k.slice(0);j.pfLParam=(f[i]-l[i])/p[i];l[i]=f[i];if(l[h]<-f[h]){o=l[h]+f[h];j.rfSqrDistance+=(o*o);l[h]=-f[h];}else{if(l[h]>f[h]){o=l[h]-f[h];j.rfSqrDistance+=(o*o);l[h]=f[h];}}if(l[g]<-f[g]){o=l[g]+f[g];j.rfSqrDistance+=(o*o);l[g]=-f[g];}else{if(l[g]>f[g]){o=l[g]-f[g];j.rfSqrDistance+=(o*o);l[g]=f[g];}}b.copyFromArray(j.rkPnt,l);};e.prototype.case000=function(g,f){var h=0;var i=f.getHalfSideLengths();if(g.rkPnt[0]<-i[0]){h=g.rkPnt[0]+i[0];g.rfSqrDistance+=(h*h);g.rkPnt[0]=-i[0];}else{if(g.rkPnt[0]>i[0]){h=g.rkPnt[0]-i[0];g.rfSqrDistance+=(h*h);g.rkPnt[0]=i[0];}}if(g.rkPnt[1]<-i[1]){h=g.rkPnt[1]+i[1];g.rfSqrDistance+=(h*h);g.rkPnt[1]=-i[1];}else{if(g.rkPnt[1]>i[1]){h=g.rkPnt[1]-i[1];g.rfSqrDistance+=(h*h);g.rkPnt[1]=i[1];}}if(g.rkPnt[2]<-i[2]){h=g.rkPnt[2]+i[2];g.rfSqrDistance+=(h*h);g.rkPnt[2]=-i[2];}else{if(g.rkPnt[2]>i[2]){h=g.rkPnt[2]-i[2];g.rfSqrDistance+=(h*h);g.rkPnt[2]=i[2];}}};a.JSegment=e;})(jigLib);(function(c){var d=c.Vector3DUtil;var b=c.JMatrix3D;var e=c.RigidBody;var a=function(g,f){this.Super(g);this._type="SPHERE";this._radius=f;this._boundingSphere=this._radius;this.set_mass(1);this.updateBoundingBox();};c.extend(a,c.RigidBody);a.prototype.name=null;a.prototype._radius=null;a.prototype.set_radius=function(f){this._radius=f;this._boundingSphere=this._radius;this.setInertia(this.getInertiaProperties(this.get_mass()));this.setActive();this.updateBoundingBox();};a.prototype.get_radius=function(){return this._radius;};a.prototype.segmentIntersect=function(m,n,i){m.fracOut=0;m.posOut=[0,0,0,0];m.normalOut=[0,0,0,0];var j=0;var g=n.delta;var t=d.subtract(n.origin,i.position);var l=this._radius*this._radius;var u=d.get_lengthSquared(g);if(u<l){m.fracOut=0;m.posOut=n.origin.slice(0);m.normalOut=d.subtract(m.posOut,i.position);d.normalize(m.normalOut);return true;}var h=d.dotProduct(t,g);var k=d.get_lengthSquared(t);var o=h*h-u*(k-l);if(o<0){return false;}var q=Math.sqrt(o);var f=(-h-q)/u;var p=(-h+q)/u;if(f>1||p<0){return false;}j=Math.max(f,0);m.fracOut=j;m.posOut=n.getPoint(j);m.normalOut=d.subtract(m.posOut,i.position);d.normalize(m.normalOut);return true;};a.prototype.getInertiaProperties=function(f){var g=0.4*f*this._radius*this._radius;return b.getScaleMatrix(g,g,g);};a.prototype.updateBoundingBox=function(){this._boundingBox.clear();this._boundingBox.addSphere(this);};c.JSphere=a;})(jigLib);(function(a){var c=a.Vector3DUtil;var b=a.JNumber3D;var d=a.RigidBody;var e=function(f){this.Super(null);this._terrain=f;this.set_movable(false);this._type="TERRAIN";};a.extend(e,a.RigidBody);e.prototype._terrain=null;e.prototype.get_terrainMesh=function(){return this._terrain;};e.prototype.getHeightByIndex=function(g,f){g=this.limiteInt(g,0,_terrain.sw);f=this.limiteInt(f,0,_terrain.sh);return _terrain.heights[g][f];};e.prototype.getHeightAndNormalByPoint=function(t){var s=this.limiteInt(t[0],this._terrain.minW,this._terrain.maxW);var o=this.limiteInt(t[2],this._terrain.minH,this._terrain.maxH);var k=((s-_terrain.minW)/this._terrain.dw)|0;var f=((o-_terrain.minH)/this._terrain.dh)|0;k=this.limiteInt(k,0,this._terrain.sw);f=this.limiteInt(f,0,this._terrain.sh);var i=k+1;var u=f+1;i=this.limiteInt(i,0,this._terrain.sw);u=this.limiteInt(u,0,this._terrain.sh);var j=1-(s-(k*this._terrain.dw+this._terrain.minW))/this._terrain.dw;var g=(o-(f*this._terrain.dh+this._terrain.minH))/this._terrain.dh;j=b.getLimiteNumber(j,0,1);g=b.getLimiteNumber(g,0,1);var r=this._terrain.heights[k][f];var q=this._terrain.heights[k][u];var n=this._terrain.heights[i][f];var m=this._terrain.heights[i][u];var l={};l.height=0;l.normal=[0,0,0,0];var p;if(j<g||k==i||f==u){l.normal=c.crossProduct([0,m-n,this._terrain.dh,0],[this._terrain.dw,m-q,0,0]);c.normalize(l.normal);p=new PlaneData([(i*this._terrain.dw+this._terrain.minW),m,(u*this._terrain.dh+this._terrain.minH),0],l.normal);l.height=p.pointPlaneDistance(t);}else{l.normal=c.crossProduct([0,q-r,this._terrain.dh,0],[this._terrain.dw,n-r,0,0]);c.normalize(l.normal);p=new PlaneData([(k*this._terrain.dw+this._terrain.minW),r,(f*this._terrain.dh+this._terrain.minH),0],l.normal);l.height=p.pointPlaneDistance(t);}return l;};e.prototype.getHeightByPoint=function(f){return this.getHeightAndNormalByPoint(f).height;};e.prototype.getNormalByPoint=function(f){return this.getHeightAndNormalByPoint(f).normal;};e.prototype.getSurfacePosByPoint=function(f){return[f[0],this.getHeightAndNormalByPoint(f).height,f[2],0];};e.prototype.segmentIntersect=function(i,f,j){i.fracOut=0;i.posOut=[0,0,0,0];i.normalOut=[0,0,0,0];if(f.delta[1]>-b.NUM_TINY){return false;}var m=this.getHeightAndNormalByPoint(f.origin);if(m.height<0){return false;}var l=getHeightAndNormalByPoint(f.getEnd());if(l.height>0){return false;}var h=-l.height;var g=1/(b.NUM_TINY+m.height);var k=1/(b.NUM_TINY+l.height);c.scaleBy(m.normal,g);c.scaleBy(l.normal,k);i.normalOut=c.add(m.normal,l.normal);c.scaleBy(i.normalOut,1/(g+k));i.fracOut=m.height/(m.height+h+b.NUM_TINY);i.posOut=f.getPoint(i.fracOut);return true;};e.prototype.limiteInt=function(g,h,f){var i=g;if(i<h){i=h;}else{if(i>f){i=f;}}return i;};a.JTerrain=e;})(jigLib);(function(a){var b=function(){this.accumulatedFrictionImpulse=[0,0,0,0];};b.prototype.initialPenetration=null;b.prototype.r0;b.prototype.r1;b.prototype.position;b.prototype.minSeparationVel=0;b.prototype.denominator=0;b.prototype.accumulatedNormalImpulse=0;b.prototype.accumulatedNormalImpulseAux=0;b.prototype.accumulatedFrictionImpulse=null;a.CollPointInfo=b;})(jigLib);(function(a){var c=a.MaterialProperties;var b=function(){this.mat=new c();this.pointInfo=[];};b.prototype.mat=null;b.prototype.objInfo=null;b.prototype.dirToBody=null;b.prototype.pointInfo=null;b.prototype.satisfied=null;a.CollisionInfo=b;})(jigLib);(function(a){var b=function(){};b.prototype.body0=null;b.prototype.body1=null;a.CollDetectInfo=b;})(jigLib);(function(a){var b=function(){};b.prototype.name=null;b.prototype.type0=null;b.prototype.type1=null;b.prototype.collDetect=function(d,c){};a.CollDetectFunctor=b;})(jigLib);(function(d){var m=d.Vector3DUtil;var b=d.JNumber3D;var f=d.JMatrix3D;var i=d.JConstraint;var o=d.JSegment;var g=d.JConfig;var h=d.JSphere;var c=d.MaterialProperties;var a=d.PhysicsState;var e=d.EdgeData;var j=d.SpanData;var k=d.CollPointInfo;var n=d.CollisionInfo;var l=function(){this.name="BoxBox";this.type0="BOX";this.type1="BOX";};d.extend(l,d.CollDetectFunctor);l.prototype.combinationDist=null;l.prototype.disjoint=function(u,r,x,w){var t=x.getSpan(r);var s=w.getSpan(r);var p=t.min;var v=t.max;var y=s.min;var q=s.max;var z=Math.min;if(p>(q+g.collToll+b.NUM_TINY)||y>(v+g.collToll+b.NUM_TINY)){u.flag=true;return true;}if((v>q)&&(y>p)){u.depth=z(v-y,q-p);}else{if((q>v)&&(p>y)){u.depth=z(q-p,v-y);}else{u.depth=(v<q)?v:q;u.depth-=(p>y)?p:y;}}u.flag=false;return false;};l.prototype.addPoint=function(t,s,p){for(var r=0,q=t.length;r<q;r++){var u=t[r];if(m.get_lengthSquared(m.subtract(u,s))<p){u=b.getDivideVector(m.add(u,s),2);return false;}}t.push(s);return true;};l.prototype.getSupportPoint=function(v,t){var r=v.get_currentState().getOrientationCols();var u=m.dotProduct(t,r[0]);var q=m.dotProduct(t,r[1]);var x=m.dotProduct(t,r[2]);var w=v.get_currentState().position.slice(0);var s=v.get_sideLengths();if(u<-b.NUM_TINY){w=m.add(w,b.getScaleVector(r[0],0.5*s[0]));}else{if(u>=b.NUM_TINY){w=m.subtract(w,b.getScaleVector(r[0],0.5*s[0]));}}if(q<-b.NUM_TINY){w=m.add(w,b.getScaleVector(r[1],0.5*s[1]));}else{if(q>b.NUM_TINY){w=m.subtract(w,b.getScaleVector(r[1],0.5*s[1]));}}if(x<-b.NUM_TINY){w=m.add(w,b.getScaleVector(r[2],0.5*s[2]));}else{if(x>b.NUM_TINY){w=m.subtract(w,b.getScaleVector(r[2],0.5*s[2]));}}return w;};l.prototype.getAABox2EdgeIntersectionPoints=function(t,x,H,J,I){var E;var G;var w;var u;var p;var s=0;var C;var q=m.subtract(I,J);m.normalize(q);var F=[];var r=[];var y=J;var D=I;var A=q;var B=b.getScaleVector(x,0.5);for(var z=2;z>=0;z--){if(Math.abs(A[z])<0.1){continue;}E=(z+1)%3;G=(z+2)%3;r=[-B[z],B[z]];for(var v=1;v>=0;v--){w=y[z]-r[v];u=D[z]-r[v];p=-1;if(w*u<-b.NUM_TINY){p=-w/(u-w);}else{if(Math.abs(w)<b.NUM_TINY){p=0;}else{if(Math.abs(u)<b.NUM_TINY){p=1;}}}if(p>=0){C=m.add(b.getScaleVector(J,1-p),b.getScaleVector(I,p));F=C;if((F[E]>-B[E]-b.NUM_TINY)&&(F[E]<B[E]+b.NUM_TINY)&&(F[G]>-B[G]-b.NUM_TINY)&&(F[G]<B[G]+b.NUM_TINY)){C=C.splice(0);f.multiplyVector(H.get_orientation(),C);C=m.add(C,H.position);this.addPoint(t,C,combinationDist);if(++s==2){return s;}}}}}return s;};l.prototype.getBox2BoxEdgesIntersectionPoints=function(x,B,z,t){var y=0;var u;var C=(t)?B.get_currentState():B.get_oldState();var s=(t)?z.get_currentState():z.get_oldState();var q=z.getCornerPointsInBoxSpace(s,C);var A=z.get_edges();var r;var p;for(var w=0;w<A.length;w++){var v=A[w];r=q[v.ind0];p=q[v.ind1];y+=this.getAABox2EdgeIntersectionPoints(x,B.get_sideLengths(),C,r,p);if(y>=8){return y;}}return y;};l.prototype.getBoxBoxIntersectionPoints=function(s,q,p,r){this.getBox2BoxEdgesIntersectionPoints(s,q,p,r);this.getBox2BoxEdgesIntersectionPoints(s,p,q,r);return m.get_length(s);};l.prototype.collDetect=function(ac,D){var R=ac.body0;var P=ac.body1;if(!R.hitTestObject3D(P)){return;}if(g.aabbDetection&&!R.get_boundingBox().overlapTest(P.get_boundingBox())){return;}var aj=b.NUM_TINY;var v=b.NUM_HUGE;var z=R.get_currentState().getOrientationCols();var M=P.get_currentState().getOrientationCols();var U=[z[0],z[1],z[2],M[0],M[1],M[2],m.crossProduct(z[0],M[0]),m.crossProduct(z[1],M[0]),m.crossProduct(z[2],M[0]),m.crossProduct(z[0],M[1]),m.crossProduct(z[1],M[1]),m.crossProduct(z[2],M[1]),m.crossProduct(z[0],M[2]),m.crossProduct(z[1],M[2]),m.crossProduct(z[2],M[2])];var y;var ab=[];var Z=0;var A=U.length;for(Z=0;Z<A;Z++){var ad=ab[Z]=new j();ad.depth=v;y=m.get_lengthSquared(U[Z]);if(y<aj){continue;}var q=U[Z].slice(0);m.normalize(q);if(this.disjoint(ab[Z],q,R,P)){return;}}var I=v;var O=-1;A=U.length;for(Z=0;Z<A;Z++){y=m.get_lengthSquared(U[Z]);if(y<aj){continue;}if(ab[Z].depth<I){I=ab[Z].depth;O=Z;}}if(O==-1){return;}var w=U[O].splice(0);if(m.dotProduct(m.subtract(P.get_currentState().position,R.get_currentState().position),w)>0){w=b.getScaleVector(w,-1);}var ag=true;var aa=[];var S=R.get_sideLengths();var X=P.get_sideLengths();combinationDist=0.05*Math.min(Math.min(S[0],S[1],S[2]),Math.min(X[0],X[1],X[2]));combinationDist+=(g.collToll*3.464);combinationDist*=combinationDist;if(I>-b.NUM_TINY){this.getBoxBoxIntersectionPoints(aa,R,P,false);}if(aa.length==0){ag=false;this.getBoxBoxIntersectionPoints(aa,R,P,true);}var K=m.subtract(m.subtract(R.get_currentState().position,R.get_oldState().position),m.subtract(P.get_currentState().position,P.get_oldState().position));var p=m.dotProduct(K,w);var J=I+p;var F=[];switch(O){case 0:case 1:case 2:F=this.getSupportPoint(P,b.getScaleVector(w,-1));break;case 3:case 4:case 5:F=this.getSupportPoint(R,w);break;case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:Z=O-6;var T=(Z/3)|0;var Q=Z-T*3;var E=this.getSupportPoint(R,w);var C=this.getSupportPoint(P,b.getScaleVector(w,-1));var V=m.crossProduct(w,M[Q]);var L=m.dotProduct(V,C);var ae=m.dotProduct(z[T],V);if(Math.abs(ae)<b.NUM_TINY){return;}var W=(L-m.dotProduct(E,V))/ae;E=m.add(E,b.getScaleVector(z[T],W));F=m.add(E,b.getScaleVector(w,0.5*I));break;}var ai;if(aa.length>0){ai=[];var B=b.NUM_HUGE;var H=-b.NUM_HUGE;var r;var u;var af;var x;var s;for(var Y=0;Y<aa.length;Y++){s=aa[Y];r=m.get_length(m.subtract(s,F));if(r<B){B=r;}if(r>H){H=r;}}if(H<B+b.NUM_TINY){H=B+b.NUM_TINY;}Z=0;for(var Y=0;Y<aa.length;Y++){s=aa[Y];r=m.get_length(m.subtract(s,F));af=(r-B)/(H-B);u=(1-af)*J;x=new k();if(ag){x.r0=m.subtract(s,R.get_oldState().position);x.r1=m.subtract(s,P.get_oldState().position);}else{x.r0=m.subtract(s,R.get_currentState().position);x.r1=m.subtract(s,P.get_currentState().position);}x.initialPenetration=u;ai[Z++]=x;}}else{x=new k();x.r0=m.subtract(F,R.get_currentState().position);x.r1=m.subtract(F,P.get_currentState().position);x.initialPenetration=J;ai=[];ai[0]=x;}var ah=new n();ah.objInfo=ac;ah.dirToBody=w;ah.pointInfo=ai;var G=new c();G.set_restitution(Math.sqrt(R.get_material().get_restitution()*P.get_material().get_restitution()));G.set_friction(Math.sqrt(R.get_material().get_friction()*P.get_material().get_friction()));ah.mat=G;D.push(ah);ac.body0.collisions.push(ah);ac.body1.collisions.push(ah);};d.CollDetectBoxBox=l;})(jigLib);(function(e){var i=e.Vector3DUtil;var a=e.JNumber3D;var g=e.JConstraint;var f=e.JConfig;var b=e.JPlane;var k=e.JSegment;var d=e.JBox;var c=e.MaterialProperties;var l=e.RigidBody;var h=e.CollPointInfo;var j=e.CollisionInfo;var m=function(){this.name="BoxPlane";this.type0="BOX";this.type1="PLANE";};e.extend(m,e.CollDetectFunctor);m.prototype.collDetect=function(q,A){var v;if(q.body0.get_type()=="PLANE"){v=q.body0;q.body0=q.body1;q.body1=v;}var t=q.body0;var u=q.body1;var B=u.pointPlaneDistance(t.get_currentState().position);if(B>t.get_boundingSphere()+f.collToll){return;}var D=t.getCornerPoints(t.get_currentState());var w=t.getCornerPoints(t.get_oldState());var r=[];var p;var o;var n;var z;var x;for(var s=0;s<8;s++){o=D[s];n=w[s];z=-1*u.pointPlaneDistance(o);x=-1*u.pointPlaneDistance(n);if(Math.max(z,x)>-f.collToll){p=new h();p.r0=i.subtract(n,t.get_oldState().position);p.r1=i.subtract(n,u.get_oldState().position);p.initialPenetration=x;r.push(p);}}if(r.length>0){var y=new j();y.objInfo=q;y.dirToBody=u.get_normal();y.pointInfo=r;var C=new c();C.set_restitution(Math.sqrt(t.get_material().get_restitution()*u.get_material().get_restitution()));C.set_friction(Math.sqrt(t.get_material().get_friction()*u.get_material().get_friction()));y.mat=C;A.push(y);q.body0.collisions.push(y);q.body1.collisions.push(y);}};e.CollDetectBoxPlane=m;})(jigLib);(function(e){var i=e.Vector3DUtil;var a=e.JNumber3D;var h=e.JConstraint;var g=e.JConfig;var f=e.JTerrain;var d=e.JBox;var c=e.MaterialProperties;var j=e.RigidBody;var b=function(){this.name="BoxTerrain";this.type0="BOX";this.type1="TERRAIN";};e.extend(b,e.CollDetectFunctor);b.prototype.collDetect=function(o,y){var t;if(o.body0.type=="TERRAIN"){t=o.body0;o.body0=o.body1;o.body1=t;}var s=o.body0;var m=o.body1;var v=s.getCornerPoints(s.oldState);var A=s.getCornerPoints(s.currentState);var u=[0,0,0,0];var r;var x;var l;var k;var p=[];var n;for(var q=0;q<8;q++){l=A[q];r=m.getHeightAndNormalByPoint(l);if(r.height<g.collToll){k=v[q];x=m.getHeightByPoint(k);u=i.add(u,r.normal);n=new CollPointInfo();n.r0=i.subtract(k,s.oldState.position);n.r1=i.subtract(k,m.oldState.position);n.initialPenetration=-x;p.push(n);}}if(p.length>0){i.normalize(u);var w=new CollisionInfo();w.objInfo=o;w.dirToBody=u;w.pointInfo=p;var z=new c();z.restitution=Math.sqrt(s.material.restitution*m.material.restitution);z.friction=Math.sqrt(s.material.friction*m.material.friction);w.mat=z;y.push(w);o.body0.collisions.push(w);o.body1.collisions.push(w);}};e.CollDetectBoxTerrain=b;})(jigLib);(function(e){var k=e.Vector3DUtil;var f=e.JMatrix3D;var a=e.JNumber3D;var h=e.JConstraint;var g=e.JConfig;var i=e.JCapsule;var m=e.JSegment;var d=e.JBox;var b=e.MaterialProperties;var n=e.RigidBody;var j=e.CollPointInfo;var l=e.CollisionInfo;var c=function(){this.name="CapsuleBox";this.type0="CAPSULE";this.type1="BOX";};e.extend(c,e.CollDetectFunctor);c.prototype.collDetect=function(G,E){var y;if(G.body0.get_type()=="BOX"){y=G.body0;G.body0=G.body1;G.body1=y;}var x=G.body0;var w=G.body1;if(!x.hitTestObject3D(w)){return;}if(g.aabbDetection&&!x.get_boundingBox().overlapTest(w.get_boundingBox())){return;}var D=[];var t;var o=[0,0,0,0];var r=new m(x.getEndPos(x.get_oldState()),a.getScaleVector(x.get_oldState().getOrientationCols()[1],-k.get_length(x)));var A=new m(x.getEndPos(x.get_currentState()),a.getScaleVector(x.get_currentState().getOrientationCols()[1],-k.get_length(x)));var q=x.get_radius();var J={};var I=r.segmentBoxDistanceSq(J,w,w.get_oldState());var u={};var s=A.segmentBoxDistanceSq(u,w,w.get_currentState());var p=w.get_oldState().getOrientationCols();if(Math.min(I,s)<Math.pow(q+g.collToll,2)){var v=r.getPoint(Number(J.pfLParam));var H=w.get_oldState().position.slice(0);H=k.add(H,a.getScaleVector(p[0],J.pfLParam0));H=k.add(H,a.getScaleVector(p[1],J.pfLParam1));H=k.add(H,a.getScaleVector(p[2],J.pfLParam2));var B=Math.sqrt(I);var K=q-B;var z;if(B>a.NUM_TINY){z=k.subtract(v,H);k.normalize(z);}else{if(k.get_length(k.subtract(v,w.get_oldState().position))>a.NUM_TINY){z=k.subtract(v,w.get_oldState().position);k.normalize(z);}else{z=k.Y_AXIS;f.multiplyVector(f.getRotationMatrix(0,0,1,360*Math.random()),z);}}o=k.add(o,z);t=new j();t.r0=k.subtract(H,x.get_oldState().position);t.r1=k.subtract(H,w.get_oldState().position);t.initialPenetration=K;D.push(t);}r=new m(x.getBottomPos(x.get_oldState()),a.getScaleVector(x.get_oldState().getOrientationCols()[1],k.get_length(x)));A=new m(x.getBottomPos(x.get_currentState()),a.getScaleVector(x.get_currentState().getOrientationCols()[1],k.get_length(x)));J={};I=r.segmentBoxDistanceSq(J,w,w.get_oldState());u={};s=A.segmentBoxDistanceSq(u,w,w.get_currentState());if(Math.min(I,s)<Math.pow(q+g.collToll,2)){v=r.getPoint(Number(J.pfLParam));H=w.get_oldState().position.slice(0);H=k.add(H,a.getScaleVector(p[0],J.pfLParam0));H=k.add(H,a.getScaleVector(p[1],J.pfLParam1));H=k.add(H,a.getScaleVector(p[2],J.pfLParam2));B=Math.sqrt(I);K=q-B;if(B>a.NUM_TINY){z=k.subtract(v,H);k.normalize(z);}else{if(k.get_length(k.subtract(v,w.get_oldState().position))>a.NUM_TINY){z=k.subtract(v,w.get_oldState().position);k.normalize(z);}else{z=k.Y_AXIS;f.multiplyVector(f.getRotationMatrix(0,0,1,360*Math.random()),z);}}o=k.add(o,z);t=new j();t.r0=k.subtract(H,x.get_oldState().position);t.r1=k.subtract(H,w.get_oldState().position);t.initialPenetration=K;D.push(t);}if(D.length>0){o.normalize();var C=new l();C.objInfo=G;C.dirToBody=o;C.pointInfo=D;var F=new b();F.set_restitution(Math.sqrt(x.get_material().get_restitution()*w.get_material().get_restitution()));F.set_friction(Math.sqrt(x.get_material().get_friction()*w.get_material().get_friction()));C.mat=F;E.push(C);G.body0.collisions.push(C);G.body1.collisions.push(C);}};e.CollDetectCapsuleBox=c;})(jigLib);(function(d){var j=d.Vector3DUtil;var e=d.JMatrix3D;var a=d.JNumber3D;var g=d.JConstraint;var f=d.JConfig;var h=d.JCapsule;var l=d.JSegment;var c=d.MaterialProperties;var m=d.RigidBody;var i=d.CollPointInfo;var k=d.CollisionInfo;var b=function(){this.name="CapsuleCapsule";this.type0="CAPSULE";this.type1="CAPSULE";};d.extend(b,d.CollDetectFunctor);b.prototype.collDetect=function(E,C){var H=E.body0;var G=E.body1;if(!H.hitTestObject3D(G)){return;}if(f.aabbDetection&&!H.get_boundingBox().overlapTest(G.get_boundingBox())){return;}var B=[];var u;var n=[0,0,0,0];var p=new l(H.getEndPos(H.get_oldState()),a.getScaleVector(H.get_oldState().getOrientationCols()[1],-j.get_length(H)));var y=new l(H.getEndPos(H.get_currentState()),a.getScaleVector(H.get_currentState().getOrientationCols()[1],-j.get_length(H)));var o=new l(G.getEndPos(G.get_oldState()),a.getScaleVector(G.get_oldState().getOrientationCols()[1],-j.get_length(G)));var x=new l(G.getEndPos(G.get_currentState()),a.getScaleVector(G.get_currentState().getOrientationCols()[1],-j.get_length(G)));var q=H.get_radius()+G.get_radius();var J={};var I=p.segmentSegmentDistanceSq(J,o);var v={};var t=y.segmentSegmentDistanceSq(J,x);if(Math.min(I,t)<Math.pow(q+f.collToll,2)){var s=p.getPoint(J.t0);var r=o.getPoint(J.t1);var F=j.subtract(s,r);var z=Math.sqrt(I);var K=q-z;if(z>a.NUM_TINY){F=a.getDivideVector(F,z);}else{F=j.Y_AXIS;e.multiplyVector(e.getRotationMatrix(0,0,1,360*Math.random()),F);}var w=j.add(r,a.getScaleVector(F,G.get_radius()-0.5*K));n=j.add(n,F);u=new i();u.r0=j.subtract(w,H.get_oldState().position);u.r1=j.subtract(w,G.get_oldState().position);u.initialPenetration=K;B.push(u);}p=new l(H.getBottomPos(H.get_oldState()),a.getScaleVector(H.get_oldState().getOrientationCols()[1],j.get_length(H)));y=new l(H.getBottomPos(H.get_currentState()),a.getScaleVector(H.get_currentState().getOrientationCols()[1],j.get_length(H)));o=new l(G.getBottomPos(G.get_oldState()),a.getScaleVector(G.get_oldState().getOrientationCols()[1],j.get_length(G)));x=new l(G.getBottomPos(G.get_currentState()),a.getScaleVector(G.get_currentState().getOrientationCols()[1],j.get_length(G)));J={};I=p.segmentSegmentDistanceSq(J,o);v={};t=y.segmentSegmentDistanceSq(J,x);if(Math.min(I,t)<Math.pow(q+f.collToll,2)){s=p.getPoint(J.t0);r=o.getPoint(J.t1);F=j.subtract(s,r);z=Math.sqrt(I);K=q-z;if(z>a.NUM_TINY){F=a.getDivideVector(F,z);}else{F=j.Y_AXIS;e.multiplyVector(e.getRotationMatrix(0,0,1,360*Math.random()),F);}w=j.add(r,a.getScaleVector(F,G.get_radius()-0.5*K));n=j.add(n,F);u=new i();u.r0=j.subtract(w,H.get_oldState().position);u.r1=j.subtract(w,G.get_oldState().position);u.initialPenetration=K;B.push(u);}if(B.length>0){j.normalize(n);var A=new k();A.objInfo=E;A.dirToBody=n;A.pointInfo=B;var D=new c();D.set_restitution(Math.sqrt(H.get_material().get_restitution()*G.get_material().get_restitution()));D.set_friction(Math.sqrt(H.get_material().get_friction()*G.get_material().get_friction()));A.mat=D;C.push(A);E.body0.collisions.push(A);E.body1.collisions.push(A);}};d.CollDetectCapsuleCapsule=b;})(jigLib);(function(c){var j=c.Vector3DUtil;var a=c.JNumber3D;var g=c.JConstraint;var e=c.JConfig;var h=c.JCapsule;var d=c.JPlane;var b=c.MaterialProperties;var l=c.RigidBody;var i=c.CollPointInfo;var k=c.CollisionInfo;var f=function(){this.name="CapsulePlane";this.type0="CAPSULE";this.type1="PLANE";};c.extend(f,c.CollDetectFunctor);f.prototype.collDetect=function(m,z){var u;if(m.body0.get_type()=="PLANE"){u=m.body0;m.body0=m.body1;m.body1=u;}var r=m.body0;var t=m.body1;var q=[];var n;var s=r.getBottomPos(r.get_oldState());var y=t.pointPlaneDistance(s);var x=r.getBottomPos(r.get_currentState());var p=t.pointPlaneDistance(x);if(Math.min(y,p)<r.get_radius()+e.collToll){var v=r.get_radius()-y;var o=j.subtract(s,a.getScaleVector(t.get_normal(),r.get_radius()));n=new i();n.r0=j.subtract(o,r.get_oldState().position);n.r1=j.subtract(o,t.get_oldState().position);n.initialPenetration=v;q.push(n);}s=r.getEndPos(r.get_oldState());x=r.getEndPos(r.get_currentState());y=t.pointPlaneDistance(s);p=t.pointPlaneDistance(x);if(Math.min(y,p)<r.get_radius()+e.collToll){v=r.get_radius()-y;o=j.subtract(s,a.getScaleVector(t.get_normal(),r.get_radius()));n=new i();n.r0=j.subtract(o,r.get_oldState().position);n.r1=j.subtract(o,t.get_oldState().position);n.initialPenetration=v;q.push(n);}if(q.length>0){var w=new k();w.objInfo=m;w.dirToBody=t.get_normal();w.pointInfo=q;var A=new b();A.set_restitution(Math.sqrt(r.get_material().get_restitution()*t.get_material().get_restitution()));A.set_friction(Math.sqrt(r.get_material().get_friction()*t.get_material().get_friction()));w.mat=A;z.push(w);m.body0.collisions.push(w);m.body1.collisions.push(w);}};c.CollDetectCapsulePlane=f;})(jigLib);(function(c){var h=c.Vector3DUtil;var a=c.JNumber3D;var f=c.JConstraint;var e=c.JConfig;var g=c.JCapsule;var d=c.JTerrain;var b=c.MaterialProperties;var j=c.RigidBody;var i=function(){this.name="BoxTerrain";this.type0="CAPSULE";this.type1="TERRAIN";};c.extend(i,c.CollDetectFunctor);i.prototype.collDetect=function(l,w){var s;if(l.body0.type=="TERRAIN"){s=l.body0;l.body0=l.body1;l.body1=s;}var p=l.body0;var k=l.body1;var o=[];var m;var y=[0,0,0,0];var x=p.getBottomPos(p.oldState);var v=p.getBottomPos(p.currentState);var r=k.getHeightAndNormalByPoint(x);var q=k.getHeightAndNormalByPoint(v);if(Math.min(r.height,q.height)<e.collToll+p.radius){var t=p.radius-r.height;var n=h.subtract(x,a.getScaleVector(q.normal,p.radius));m=new CollPointInfo();m.r0=h.subtract(n,p.oldState.position);m.r1=h.subtract(n,k.oldState.position);m.initialPenetration=t;o.push(m);y=h.add(y,q.normal);}x=p.getEndPos(p.oldState);v=p.getEndPos(p.currentState);r=k.getHeightAndNormalByPoint(x);q=k.getHeightAndNormalByPoint(v);if(Math.min(r.height,q.height)<e.collToll+p.radius){t=p.radius-r.height;n=h.subtract(x,a.getScaleVector(q.normal,p.radius));m=new CollPointInfo();m.r0=h.subtract(n,p.oldState.position);m.r1=h.subtract(n,k.oldState.position);m.initialPenetration=t;o.push(m);y=h.add(y,q.normal);}if(o.length>0){h.normalize(y);var u=new CollisionInfo();u.objInfo=l;u.dirToBody=y;u.pointInfo=o;var z=new b();z.restitution=Math.sqrt(p.material.restitution*k.material.restitution);z.friction=Math.sqrt(p.material.friction*k.material.friction);u.mat=z;w.push(u);l.body0.collisions.push(u);l.body1.collisions.push(u);}};c.CollDetectCapsuleTerrain=i;})(jigLib);(function(b){var f=b.Vector3DUtil;var e=b.JNumber3D;var a=b.JConfig;var h=b.MaterialProperties;var c=b.CollPointInfo;var d=b.CollisionInfo;var g=function(){this.name="SphereBox";this.type0="SPHERE";this.type1="BOX";};b.extend(g,b.CollDetectFunctor);g.prototype.collDetect=function(j,u){var q;if(j.body0.get_type()=="BOX"){q=j.body0;j.body0=j.body1;j.body1=q;}var n=j.body0;var o=j.body1;if(!n.hitTestObject3D(o)){return;}if(a.aabbDetection&&!n.get_boundingBox().overlapTest(o.get_boundingBox())){return;}var p={};var x={};var v=o.getDistanceToPoint(o.get_oldState(),p,n.get_oldState().position);var m=o.getDistanceToPoint(o.get_currentState(),x,n.get_currentState().position);var r=n.get_radius()-v;var t=n.get_radius()-m;if(Math.max(r,t)>-a.collToll){var l;var k=[];if(v<-e.NUM_TINY){l=f.subtract(f.subtract(p.pos,n.get_oldState().position),p.pos);f.normalize(l);}else{if(v>e.NUM_TINY){l=f.subtract(n.get_oldState().position,p.pos);f.normalize(l);}else{l=f.subtract(n.get_oldState().position,o.get_oldState().position);f.normalize(l);}}var i=new c();i.r0=f.subtract(p.pos,n.get_oldState().position);i.r1=f.subtract(p.pos,o.get_oldState().position);i.initialPenetration=r;k.push(i);var s=new d();s.objInfo=j;s.dirToBody=l;s.pointInfo=k;var w=new h();w.set_restitution(Math.sqrt(n.get_material().get_restitution()*o.get_material().get_restitution()));w.set_friction(Math.sqrt(n.get_material().get_friction()*o.get_material().get_friction()));s.mat=w;u.push(s);j.body0.collisions.push(s);j.body1.collisions.push(s);}};b.CollDetectSphereBox=g;})(jigLib);(function(c){var i=c.Vector3DUtil;var d=c.JMatrix3D;var a=c.JNumber3D;var g=c.JConstraint;var e=c.JConfig;var f=c.JSphere;var k=c.JSegment;var b=c.MaterialProperties;var m=c.RigidBody;var h=c.CollPointInfo;var j=c.CollisionInfo;var l=function(){this.name="SphereCapsule";this.type0="SPHERE";this.type1="CAPSULE";};c.extend(l,c.CollDetectFunctor);l.prototype.collDetect=function(D,B){var w;if(D.body0.get_type()=="CAPSULE"){w=D.body0;D.body0=D.body1;D.body1=w;}var p=D.body0;var v=D.body1;if(!p.hitTestObject3D(v)){return;}if(e.aabbDetection&&!p.get_boundingBox().overlapTest(v.get_boundingBox())){return;}var o=new k(v.getBottomPos(v.get_oldState()),a.getScaleVector(v.get_oldState().getOrientationCols()[1],i.get_length(v)+2*v.get_radius()));var x=new k(v.getBottomPos(v.get_currentState()),a.getScaleVector(v.get_currentState().getOrientationCols()[1],i.get_length(v)+2*v.get_radius()));var n=p.get_radius()+v.get_radius();var G={};var F=o.pointSegmentDistanceSq(G,p.get_oldState().position);var s={};var q=x.pointSegmentDistanceSq(s,p.get_currentState().position);if(Math.min(F,q)<Math.pow(n+e.collToll,2)){var u=o.getPoint(G.t);var E=i.subtract(p.get_oldState().position,u);var y=Math.sqrt(F);var H=n-y;if(y>a.NUM_TINY){E=a.getDivideVector(E,y);}else{E=i.Y_AXIS;d.multiplyVector(d.getRotationMatrix(0,0,1,360*Math.random()),E);}var t=i.add(u,a.getScaleVector(E,v.get_radius()-0.5*H));var A=[];var r=new h();r.r0=i.subtract(t,p.get_oldState().position);r.r1=i.subtract(t,v.get_oldState().position);r.initialPenetration=H;A.push(r);var z=new j();z.objInfo=D;z.dirToBody=E;z.pointInfo=A;var C=new b();C.set_restitution(Math.sqrt(p.get_material().get_restitution()*v.get_material().get_restitution()));C.set_friction(Math.sqrt(p.get_material().get_friction()*v.get_material().get_friction()));z.mat=C;B.push(z);D.body0.collisions.push(z);D.body1.collisions.push(z);}};c.CollDetectSphereCapsule=l;})(jigLib);(function(d){var i=d.Vector3DUtil;var a=d.JNumber3D;var g=d.JConstraint;var e=d.JConfig;var f=d.JSphere;var c=d.MaterialProperties;var k=d.RigidBody;var h=d.CollPointInfo;var j=d.CollisionInfo;var b=function(){this.name="SpherePlane";this.type0="SPHERE";this.type1="PLANE";};d.extend(b,d.CollDetectFunctor);b.prototype.collDetect=function(m,v){var t;if(m.body0.get_type()=="PLANE"){t=m.body0;m.body0=m.body1;m.body1=t;}var q=m.body0;var s=m.body1;var w=s.pointPlaneDistance(q.get_oldState().position);var o=s.pointPlaneDistance(q.get_currentState().position);if(Math.min(o,w)>q.get_boundingSphere()+e.collToll){return;}var p=[];var l;var r=q.get_radius()-w;var n=i.subtract(q.get_oldState().position,a.getScaleVector(s.get_normal(),q.get_radius()));l=new h();l.r0=i.subtract(n,q.get_oldState().position);l.r1=i.subtract(n,s.get_oldState().position);l.initialPenetration=r;p.push(l);var u=new j();u.objInfo=m;u.dirToBody=s.get_normal();u.pointInfo=p;var x=new c();x.set_restitution(Math.sqrt(q.get_material().get_restitution()*s.get_material().get_restitution()));x.set_friction(Math.sqrt(q.get_material().get_friction()*s.get_material().get_friction()));u.mat=x;v.push(u);m.body0.collisions.push(u);m.body1.collisions.push(u);};d.CollDetectSpherePlane=b;})(jigLib);(function(d){var j=d.Vector3DUtil;var e=d.JMatrix3D;var a=d.JNumber3D;var h=d.JConstraint;var f=d.JConfig;var g=d.JSphere;var b=d.MaterialProperties;var i=d.CollPointInfo;var k=d.CollisionInfo;var c=function(){this.name="SphereSphere";this.type0="SPHERE";this.type1="SPHERE";};d.extend(c,d.CollDetectFunctor);c.prototype.collDetect=function(r,x){var m=r.body0;var A=r.body1;var n=j.subtract(m.get_oldState().position,A.get_oldState().position);var p=j.subtract(m.get_currentState().position,A.get_currentState().position);var z=j.get_lengthSquared(n);var o=j.get_lengthSquared(p);var l=m.get_radius()+A.get_radius();if(Math.min(z,o)<Math.pow(l+f.collToll,2)){var w=Math.sqrt(z);var u=l-w;if(w>a.NUM_TINY){n=a.getDivideVector(n,w);}else{n=j.Y_AXIS;e.multiplyVector(e.getRotationMatrix(0,0,1,360*Math.random()),n);}var t=j.add(A.get_oldState().position,a.getScaleVector(n,A.get_radius()-0.5*u));var s=[];var q=new i();q.r0=j.subtract(t,m.get_oldState().position);q.r1=j.subtract(t,A.get_oldState().position);q.initialPenetration=u;s.push(q);var v=new k();v.objInfo=r;v.dirToBody=n;v.pointInfo=s;var y=new b();y.set_restitution(Math.sqrt(m.get_material().get_restitution()*A.get_material().get_restitution()));y.set_friction(Math.sqrt(m.get_material().get_friction()*A.get_material().get_friction()));v.mat=y;x.push(v);r.body0.collisions.push(v);r.body1.collisions.push(v);}};d.CollDetectSphereSphere=c;})(jigLib);(function(c){var i=c.Vector3DUtil;var a=c.JNumber3D;var g=c.JConstraint;var e=c.JConfig;var f=c.JSphere;var d=c.JTerrain;var b=c.MaterialProperties;var j=c.RigidBody;var h=function(){this.name="SphereTerrain";this.type0="SPHERE";this.type1="TERRAIN";};c.extend(h,c.CollDetectFunctor);h.prototype.collDetect=function(n,v){var s;if(n.body0.type=="TERRAIN"){s=n.body0;n.body0=n.body1;n.body1=s;}var p=n.body0;var k=n.body1;var r=k.getHeightAndNormalByPoint(p.currentState.position);if(r.height<e.collToll+p.radius){var u=k.getHeightByPoint(p.oldState.position);var q=p.radius-u;var l=i.subtract(p.oldState.position,a.getScaleVector(r.normal,p.radius));var o=[];var m=new CollPointInfo();m.r0=i.subtract(l,p.oldState.position);m.r1=i.subtract(l,k.oldState.position);m.initialPenetration=q;o.push(m);var t=new CollisionInfo();t.objInfo=n;t.dirToBody=r.normal;t.pointInfo=o;var w=new b();w.restitution=Math.sqrt(p.material.restitution*k.material.restitution);w.friction=Math.sqrt(p.material.friction*k.material.friction);t.mat=w;v.push(t);n.body0.collisions.push(t);n.body1.collisions.push(t);}};c.CollDetectSphereTerrain=h;})(jigLib);(function(p){var l=p.JSegment;var i=p.RigidBody;var g=p.Vector3DUtil;var f=p.JNumber3D;var s=p.JConstraint;var t=p.CollDetectBoxBox;var r=p.CollDetectSphereBox;var c=p.CollDetectCapsuleBox;var o=p.CollDetectBoxPlane;var h=p.CollDetectBoxTerrain;var r=p.CollDetectSphereBox;var m=p.CollDetectSphereSphere;var b=p.CollDetectSphereCapsule;var n=p.CollDetectSpherePlane;var q=p.CollDetectSphereTerrain;var k=p.CollDetectCapsuleCapsule;var c=p.CollDetectCapsuleBox;var b=p.CollDetectSphereCapsule;var e=p.CollDetectCapsulePlane;var d=p.CollDetectCapsuleTerrain;var a=p.CollDetectInfo;var j=function(){this.collBody=[];detectionFunctors=[];detectionFunctors["BOX"]=[];detectionFunctors["BOX"]["BOX"]=new t();detectionFunctors["BOX"]["SPHERE"]=new r();detectionFunctors["BOX"]["CAPSULE"]=new c();detectionFunctors["BOX"]["PLANE"]=new o();detectionFunctors["BOX"]["TERRAIN"]=new h();detectionFunctors["SPHERE"]=[];detectionFunctors["SPHERE"]["BOX"]=new r();detectionFunctors["SPHERE"]["SPHERE"]=new m();detectionFunctors["SPHERE"]["CAPSULE"]=new b();detectionFunctors["SPHERE"]["PLANE"]=new n();detectionFunctors["SPHERE"]["TERRAIN"]=new q();detectionFunctors["CAPSULE"]=[];detectionFunctors["CAPSULE"]["CAPSULE"]=new k();detectionFunctors["CAPSULE"]["BOX"]=new c();detectionFunctors["CAPSULE"]["SPHERE"]=new b();detectionFunctors["CAPSULE"]["PLANE"]=new e();detectionFunctors["CAPSULE"]["TERRAIN"]=new d();detectionFunctors["PLANE"]=[];detectionFunctors["PLANE"]["BOX"]=new o();detectionFunctors["PLANE"]["SPHERE"]=new n();detectionFunctors["PLANE"]["CAPSULE"]=new e();detectionFunctors["TERRAIN"]=[];detectionFunctors["TERRAIN"]["SPHERE"]=new q();detectionFunctors["TERRAIN"]["BOX"]=new h();detectionFunctors["TERRAIN"]["CAPSULE"]=new d();this.detectionFunctors=detectionFunctors;};j.prototype.detectionFunctors=null;j.prototype.collBody=null;j.prototype.addCollisionBody=function(u){if(!this.findBody(u)){this.collBody.push(u);}};j.prototype.removeCollisionBody=function(u){if(this.findBody(u)){this.collBody.splice(this.collBody.indexOf(u),1);}};j.prototype.removeAllCollisionBodies=function(){this.collBody=[];};j.prototype.detectCollisions=function(u,x){if(!u.isActive){return;}var y;var z;for(var w=0,A=this.collBody.length;w<A;w++){var v=this.collBody[w];if(u!=v&&this.checkCollidables(u,v)&&this.detectionFunctors[u.get_type()][v.get_type()]!=undefined){y=new a();y.body0=u;y.body1=v;z=detectionFunctors[y.body0.get_type()][y.body1.get_type()];z.collDetect(y,x);}}};j.prototype.detectAllCollisions=function(u,D){var x;var B;var z;var E;for(var C=0,w=u.length;C<w;C++){var y=u[C];z=y.id;E=y.get_type();for(var A=0;A<this.collBody.length;A++){var v=this.collBody[A];if(y==v){continue;}if(v.isActive&&z>v.id){continue;}if(this.checkCollidables(y,v)&&this.detectionFunctors[E][v.get_type()]!=undefined){x=new a();x.body0=y;x.body1=v;B=detectionFunctors[x.body0.get_type()][x.body1.get_type()];B.collDetect(x,D);}}}};j.prototype.segmentIntersect=function(x,u,w){x.fracOut=f.NUM_HUGE;x.posOut=[0,0,0,0];x.normalOut=[0,0,0,0];var z={};for(var y=0,A=this.collBody.length;y<A;y++){var v=this.collBody[y];if(v!=w&&this.segmentBounding(u,v)){if(v.segmentIntersect(z,u,v.get_currentState())){if(z.fracOut<x.fracOut){x.posOut=z.posOut;x.normalOut=z.normalOut;x.fracOut=z.fracOut;x.bodyOut=v;}}}}if(x.fracOut>1){return false;}if(x.fracOut<0){x.fracOut=0;}else{if(x.fracOut>1){x.fracOut=1;}}return true;};j.prototype.segmentBounding=function(u,y){var z=u.getPoint(0.5);var v=g.get_length(u.delta)/2;if(y.get_type()!="PLANE"&&y.get_type()!="TERRAIN"){var x=g.get_length(g.subtract(z,y.get_currentState().position));var w=v+y.get_boundingSphere();if(x<=w){return true;}else{return false;}}else{return true;}};j.prototype.findBody=function(u){for(var w=0,x=this.collBody.length;w<x;w++){var v=this.collBody[w];if(u==v){return true;}}return false;};j.prototype.checkCollidables=function(y,w){if(y.get_nonCollidables().length==0&&w.get_nonCollidables().length==0){return true;}var v=y.get_nonCollidables();for(var x=0,u=v.length;x<u;x++){var A=v[x];if(w==A){return false;}}v=w.get_nonCollidables();for(var x=0,u=v.length;x<u;x++){var z=v[x];if(y==z){return false;}}return true;};p.CollisionSystem=j;})(jigLib);(function(a){var b=function(){this._constraintEnabled=false;this.enableConstraint();};b.prototype._satisfied=null;b.prototype._constraintEnabled=null;b.prototype.set_satisfied=function(c){this._satisfied=c;};b.prototype.get_satisfied=function(){return this._satisfied;};b.prototype.preApply=function(c){this._satisfied=false;};b.prototype.apply=function(c){return false;};b.prototype.enableConstraint=function(){if(this._constraintEnabled){return;}this._constraintEnabled=true;a.PhysicsSystem.getInstance().addConstraint(this);};b.prototype.disableConstraint=function(){if(!this._constraintEnabled){return;}this._constraintEnabled=false;a.PhysicsSystem.getInstance().removeConstraint(this);};b.prototype.get_constraintEnabled=function(){return this._constraintEnabled;};a.JConstraint=b;})(jigLib);(function(b){var e=b.Vector3DUtil;var a=b.JMatrix3D;var c=b.JNumber3D;var g=b.JConstraint;var f=b.RigidBody;var d=function(j,k,h,i,l){if(!l){l=1;}this.Super();this._body0=j;this._body0Pos=k;this._body1=h;this._body1Pos=i;this._maxDistance=l;j.addConstraint(this);h.addConstraint(this);};b.extend(d,b.JConstraint);d.prototype._maxVelMag=20;d.prototype._minVelForProcessing=0.01;d.prototype._body0=null;d.prototype._body1=null;d.prototype._body0Pos=null;d.prototype._body1Pos=null;d.prototype._maxDistance=null;d.prototype.r0=null;d.prototype.r1=null;d.prototype._worldPos=null;d.prototype._currentRelPos0=null;d.prototype.preApply=function(j){this.set_satisfied(false);this.r0=this._body0Pos.slice(0);this.r1=this._body1Pos.slice(0);a.multiplyVector(this._body0.get_currentState().get_orientation(),this.r0);a.multiplyVector(this._body1.get_currentState().get_orientation(),this.r1);var i=e.add(this._body0.get_currentState().position,this.r0);var h=e.add(this._body1.get_currentState().position,this.r1);this._worldPos=c.getScaleVector(e.add(i,h),0.5);this._currentRelPos0=e.subtract(i,h);};d.prototype.apply=function(i){this.set_satisfied(true);if(!this._body0.isActive&&!this._body1.isActive){return false;}var n=this._body0.getVelocity(this.r0);var m=this._body1.getVelocity(this.r1);var p=e.add(this._currentRelPos0,c.getScaleVector(e.subtract(n,m),i));var o=p.slice(0);var u=e.get_length(o);if(u<=c.NUM_TINY){return false;}if(u>this._maxDistance){o=c.getScaleVector(o,this._maxDistance/u);}var s=c.getDivideVector(e.subtract(o,this._currentRelPos0),i);var h=e.subtract(e.subtract(n,m),s);var l=e.get_length(h);if(l>this._maxVelMag){h=c.getScaleVector(h,this._maxVelMag/l);l=this._maxVelMag;}else{if(l<this._minVelForProcessing){return false;}}var r=c.getDivideVector(h,l);var t=e.crossProduct(this.r0,r);a.multiplyVector(this._body0.get_worldInvInertia(),t);var q=e.crossProduct(this.r1,r);a.multiplyVector(this._body1.get_worldInvInertia(),q);var k=this._body0.get_invMass()+this._body1.get_invMass()+e.dotProduct(r,e.crossProduct(t,this.r0))+e.dotProduct(r,e.crossProduct(q,this.r1));if(k<c.NUM_TINY){return false;}var j=c.getScaleVector(r,-l/k);this._body0.applyWorldImpulse(j,this._worldPos);this._body1.applyWorldImpulse(c.getScaleVector(j,-1),this._worldPos);this._body0.setConstraintsAndCollisionsUnsatisfied();this._body1.setConstraintsAndCollisionsUnsatisfied();this.set_satisfied(true);return true;};b.JConstraintMaxDistance=d;})(jigLib);(function(c){var e=c.Vector3DUtil;var b=c.JMatrix3D;var d=c.JNumber3D;var g=c.JConstraint;var f=c.RigidBody;var a=function(k,m,i,j,l,h){this.Super();this._body0=k;this._body0Pos=m;this._body1=i;this._body1Pos=j;this._allowedDistance=(l)?l:1;this._timescale=(h)?h:1;if(this._timescale<d.NUM_TINY){_timescale=d.NUM_TINY;}k.addConstraint(this);i.addConstraint(this);};c.extend(a,c.JConstraint);a.prototype._maxVelMag=20;a.prototype._minVelForProcessing=0.01;a.prototype._body0=null;a.prototype._body1=null;a.prototype._body0Pos=null;a.prototype._body1Pos=null;a.prototype._timescale=null;a.prototype._allowedDistance=null;a.prototype.r0=null;a.prototype.r1=null;a.prototype._worldPos=null;a.prototype._vrExtra=null;a.prototype.preApply=function(l){this.set_satisfied(false);this.r0=this._body0Pos.slice(0);b.multiplyVector(this._body0.get_currentState().get_orientation(),this.r0);this.r1=this._body1Pos.slice(0);b.multiplyVector(this._body1.get_currentState().get_orientation(),this.r1);var i=e.add(this._body0.get_currentState().position,this.r0);var h=e.add(this._body1.get_currentState().position,this.r1);this._worldPos=d.getScaleVector(e.add(i,h),0.5);var k=e.subtract(i,h);var j=e.get_length(k);if(j>this._allowedDistance){this._vrExtra=d.getScaleVector(k,(j-this._allowedDistance)/(j*Math.max(this._timescale,l)));}else{this._vrExtra=[0,0,0,0];}};a.prototype.apply=function(j){this.set_satisfied(true);if(!this._body0.isActive&&!this._body1.isActive){return false;}var o=this._body0.getVelocity(this.r0);var n=this._body1.getVelocity(this.r1);var h=e.add(this._vrExtra,e.subtract(o,n));var m=e.get_length(h);if(m<this._minVelForProcessing){return false;}if(m>this._maxVelMag){h=d.getScaleVector(h,this._maxVelMag/m);m=this._maxVelMag;}var p=d.getDivideVector(h,m);var r=e.crossProduct(this.r0,p);b.multiplyVector(this._body0.get_worldInvInertia(),r);var q=e.crossProduct(this.r1,p);b.multiplyVector(this._body1.get_worldInvInertia(),q);var l=this._body0.get_invMass()+this._body1.get_invMass()+e.dotProduct(p,e.crossProduct(r,this.r0))+e.dotProduct(p,e.crossProduct(q,this.r1));if(l<d.NUM_TINY){return false;}var k=d.getScaleVector(p,-m/l);var i=d.getScaleVector(k,-1);this._body0.applyWorldImpulse(k,this._worldPos);this._body1.applyWorldImpulse(i,this._worldPos);this._body0.setConstraintsAndCollisionsUnsatisfied();this._body1.setConstraintsAndCollisionsUnsatisfied();this.set_satisfied(true);return true;};c.JConstraintPoint=a;})(jigLib);(function(c){var e=c.Vector3DUtil;var b=c.JMatrix3D;var d=c.JNumber3D;var g=c.JConstraint;var f=c.RigidBody;var a=function(h,i,j){this.Super();this._body=h;this._pointOnBody=i;this._worldPosition=j;h.addConstraint(this);};c.extend(a,c.JConstraint);a.prototype.minVelForProcessing=0.001;a.prototype.allowedDeviation=0.01;a.prototype.timescale=4;a.prototype._body=null;a.prototype._pointOnBody=null;a.prototype._worldPosition=null;a.prototype.set_worldPosition=function(h){this._worldPosition=h;};a.prototype.get_worldPosition=function(){return this._worldPosition;};a.prototype.apply=function(h){this.set_satisfied(true);var m=this._pointOnBody.slice(0);b.multiplyVector(this._body.get_currentState().get_orientation(),m);m=e.add(m,this._body.get_currentState().position);var o=e.subtract(m,this._body.get_currentState().position);var s=e.add(this._body.get_currentState().linVelocity,e.crossProduct(this._body.get_currentState().rotVelocity,o));var i;var r;var l=e.subtract(m,this._worldPosition);var t=e.get_length(l);if(t>this.allowedDeviation){r=d.getDivideVector(l,t);i=d.getScaleVector(r,(this.allowedDeviation-t)/(this.timescale*h));}else{i=[0,0,0,0];}var q=e.subtract(s,i);var n=e.get_length(q);if(n<this.minVelForProcessing){return false;}q=d.getDivideVector(q,n);var p=e.crossProduct(o,q);b.multiplyVector(this._body.get_worldInvInertia(),p);var k=this._body.get_invMass()+e.dotProduct(q,e.crossProduct(p,o));if(k<d.NUM_TINY){return false;}var j=-n/k;this._body.applyWorldImpulse(d.getScaleVector(q,j),m);this._body.setConstraintsAndCollisionsUnsatisfied();this.set_satisfied(true);return true;};c.JConstraintWorldPoint=a;})(jigLib);(function(c){var f=c.Vector3DUtil;var b=c.JMatrix3D;var d=c.JNumber3D;var g=c.PhysicsController;var e=c.JConstraintMaxDistance;var a=c.JConstraintPoint;var h=function(v,s,y,D,m,p,j,J,l){this._body0=v;this._body1=s;this._hingeAxis=y.slice(0);this._hingePosRel0=D.slice(0);this._usingLimit=false;this._hingeEnabled=false;this._broken=false;this._damping=l;this._extraTorque=0;f.normalize(this._hingeAxis);var k=f.add(this._body0.get_currentState().position,f.subtract(this._hingePosRel0,this._body1.get_currentState().position));var r=f.add(this._hingePosRel0,d.getScaleVector(this._hingeAxis,m));var q=f.subtract(this._hingePosRel0,d.getScaleVector(this._hingeAxis,m));var G=f.add(k,d.getScaleVector(this._hingeAxis,m));var E=f.subtract(k,d.getScaleVector(this._hingeAxis,m));var u=1/20;var B=0.005;var n=J*m;this.sidePointConstraints=[];this.sidePointConstraints[0]=new e(this._body0,r,this._body1,G,n);this.sidePointConstraints[1]=new e(this._body0,q,this._body1,E,n);this.midPointConstraint=new a(this._body0,this._hingePosRel0,this._body1,k,B,u);if(p<=this.MAX_HINGE_ANGLE_LIMIT){var i=f.Y_AXIS;if(f.dotProduct(i,this._hingeAxis)>0.1){i[0]=1;i[1]=0;i[2]=0;}var x=f.crossProduct(this._hingeAxis,i);i=f.crossProduct(x,this._hingeAxis);f.normalize(i);var F=10*m;var C=d.getScaleVector(i,F);var I=0.5*(p-j);var A=C.slice(0);b.multiplyVector(b.getRotationMatrix(this._hingeAxis[0],this._hingeAxis[1],this._hingeAxis[2],-I),A);var w=0.5*(p+j);var t=F*2*Math.sin(0.5*w*Math.PI/180);var H=f.add(this._body1.get_currentState().position,this._hingePosRel0);var o=f.add(H,f.subtract(C,this._body0.get_currentState().position));var z=f.add(H,f.subtract(A,this._body1.get_currentState().position));this.maxDistanceConstraint=new e(this._body0,o,this._body1,z,t);this._usingLimit=true;}if(this._damping<=0){this._damping=-1;}else{this._damping=d.getLimiteNumber(this._damping,0,1);}this.enableHinge();};c.extend(h,c.PhysicsController);h.prototype.MAX_HINGE_ANGLE_LIMIT=150;h.prototype._hingeAxis=null;h.prototype._hingePosRel0=null;h.prototype._body0=null;h.prototype._body1=null;h.prototype._usingLimit=null;h.prototype._hingeEnabled=null;h.prototype._broken=null;h.prototype._damping=null;h.prototype._extraTorque=null;h.prototype.sidePointConstraints=null;h.prototype.midPointConstraint=null;h.prototype.maxDistanceConstraint=null;h.prototype.enableHinge=function(){if(this._hingeEnabled){return;}this.midPointConstraint.enableConstraint();this.sidePointConstraints[0].enableConstraint();this.sidePointConstraints[1].enableConstraint();if(this._usingLimit&&!this._broken){this.maxDistanceConstraint.enableConstraint();}this.enableController();this._hingeEnabled=true;};h.prototype.disableHinge=function(){if(!this._hingeEnabled){return;}this.midPointConstraint.disableConstraint();this.sidePointConstraints[0].disableConstraint();this.sidePointConstraints[1].disableConstraint();if(this._usingLimit&&!this._broken){this.maxDistanceConstraint.disableConstraint();}this.disableController();this._hingeEnabled=false;};h.prototype.breakHinge=function(){if(this._broken){return;}if(this._usingLimit){this.maxDistanceConstraint.disableConstraint();}this._broken=true;};h.prototype.mendHinge=function(){if(!this._broken){return;}if(this._usingLimit){this.maxDistanceConstraint.enableConstraint();}this._broken=false;};h.prototype.setExtraTorque=function(i){this._extraTorque=i;};h.prototype.getHingeEnabled=function(){return this._hingeEnabled;};h.prototype.isBroken=function(){return this._broken;};h.prototype.getHingePosRel0=function(){return this._hingePosRel0;};h.prototype.updateController=function(j){if(this._damping>0){var k=f.subtract(this._body1.get_currentState().rotVelocity,this._body0.get_currentState().rotVelocity);f.normalize(k);var p=f.dotProduct(this._body0.get_currentState().rotVelocity,k);var o=f.dotProduct(this._body1.get_currentState().rotVelocity,k);var m=0.5*(p+o);var i=1-this._damping;var r=m+(p-m)*i;var q=m+(o-m)*i;var n=f.add(this._body0.get_currentState().rotVelocity,d.getScaleVector(k,r-p));var l=f.add(this._body1.get_currentState().rotVelocity,d.getScaleVector(k,q-o));this._body0.setAngVel(n);this._body1.setAngVel(l);}if(this._extraTorque!=0){var s=this._hingeAxis.slice(0);b.multiplyVector(this._body0.get_currentState().get_orientation(),s);s=d.getScaleVector(s,this._extraTorque);this._body0.addWorldTorque(s);this._body1.addWorldTorque(d.getScaleVector(s,-1));}};c.HingeJoint=h;})(jigLib);(function(d){var l=d.Vector3DUtil;var h=d.JConfig;var k=d.CollPointInfo;var m=d.CollisionInfo;var i=d.CollisionSystem;var g=d.ContactData;var e=d.JMatrix3D;var b=d.JNumber3D;var j=d.JConstraint;var c=d.BodyPair;var a=d.CachedImpulse;var f=function(){this.setSolverType(h.solverType);this._doingIntegration=false;this._bodies=[];this._collisions=[];this._effects=[];this._activeBodies=[];this._constraints=[];this._controllers=[];this._cachedContacts=[];this._collisionSystem=new i();this.setGravity(b.getScaleVector(l.Y_AXIS,-10));};f.prototype._currentPhysicsSystem=null;f.prototype._maxVelMag=0.5;f.prototype._minVelForProcessing=0.001;f.prototype._bodies=null;f.prototype._activeBodies=null;f.prototype._collisions=null;f.prototype._constraints=null;f.prototype._controllers=null;f.prototype._effects=null;f.prototype._gravityAxis=null;f.prototype._gravity=null;f.prototype._doingIntegration=null;f.prototype.preProcessCollisionFn=function(){};f.prototype.preProcessContactFn=function(){};f.prototype.processCollisionFn=function(){};f.prototype.processContactFn=function(){};f.prototype._cachedContacts=null;f.prototype._collisionSystem=null;f.getInstance=function(){if(!f._currentPhysicsSystem){f._currentPhysicsSystem=new f();}return f._currentPhysicsSystem;};f.prototype.getAllExternalForces=function(p){for(var o=0,q=this._bodies.length;o<q;o++){this._bodies[o].addExternalForces(p);}for(var o=0,n=this._controllers.length;o<n;o++){this._controllers[o].updateController(p);}};f.prototype.getCollisionSystem=function(){return this._collisionSystem;};f.prototype.setGravity=function(n){this._gravity=n;if(this._gravity[0]==this._gravity[1]&&this._gravity[1]==this._gravity[2]){this._gravityAxis=-1;}this._gravityAxis=0;if(Math.abs(this._gravity[1])>Math.abs(this._gravity[2])){this._gravityAxis=1;}if(Math.abs(this._gravity[2])>Math.abs(this._gravity[this._gravityAxis])){this._gravityAxis=2;}};f.prototype.get_gravity=function(){return this._gravity;};f.prototype.get_gravityAxis=function(){return this._gravityAxis;};f.prototype.get_bodies=function(){return this._bodies;};f.prototype.addBody=function(n){if(!this.findBody(n)){this._bodies.push(n);this._collisionSystem.addCollisionBody(n);}};f.prototype.removeBody=function(n){if(this.findBody(n)){this._bodies.splice(this._bodies.indexOf(n),1);this._collisionSystem.removeCollisionBody(n);}};f.prototype.removeAllBodies=function(){this._bodies=[];this._collisionSystem.removeAllCollisionBodies();};f.prototype.addConstraint=function(n){if(!this.findConstraint(n)){this._constraints.push(n);}};f.prototype.removeConstraint=function(n){if(this.findConstraint(n)){this._constraints.splice(this._constraints.indexOf(n),1);}};f.prototype.removeAllConstraints=function(){this._constraints=[];};f.prototype.addEffect=function(n){if(!this.findEffect(n)){this._effects.push(n);}};f.prototype.removeEffect=function(n){if(this.findEffect(n)){this._effects.splice(this._effects.indexOf(n),1);}};f.prototype.removeAllEffects=function(){this._effects=[];};f.prototype.addController=function(n){if(!this.findController(n)){this._controllers.push(n);}};f.prototype.removeController=function(n){if(this.findController(n)){this._controllers.splice(this._controllers.indexOf(n),1);}};f.prototype.removeAllControllers=function(){this._controllers=[];};f.prototype.setSolverType=function(n){switch(n){case"FAST":this.preProcessCollisionFn=this.preProcessCollisionFast;this.preProcessContactFn=this.preProcessCollisionFast;this.processCollisionFn=this.processCollision;this.processContactFn=this.processCollision;return;case"NORMAL":this.preProcessCollisionFn=this.preProcessCollisionNormal;this.preProcessContactFn=this.preProcessCollisionNormal;this.processCollisionFn=this.processCollision;this.processContactFn=this.processCollision;return;case"ACCUMULATED":this.preProcessCollisionFn=this.preProcessCollisionAccumulated;this.preProcessContactFn=this.preProcessCollisionAccumulated;this.processCollisionFn=this.processCollision;this.processContactFn=this.processCollisionAccumulated;return;default:this.preProcessCollisionFn=this.preProcessCollisionNormal;this.preProcessContactFn=this.preProcessCollisionNormal;this.processCollisionFn=this.processCollision;this.processContactFn=this.processCollision;return;}};f.prototype.findBody=function(n){var o=this._bodies.length-1;if(o>0){do{if(n==this._bodies[o]){return true;}}while(o--);}return false;};f.prototype.findConstraint=function(o){var n=this._constraints.length-1;if(n>0){do{if(o==this._constraints[n]){return true;}}while(n--);}return false;};f.prototype.findEffect=function(o){var n=this._effects.length-1;if(n>0){do{if(o==this._effects[n]){return true;}}while(n--);}return false;};f.prototype.findController=function(n){var o=this._controllers.length-1;if(o>0){do{if(n==this._controllers[o]){return true;}}while(o--);}return false;};f.prototype.preProcessCollisionFast=function(z,p){z.satisfied=false;var o=z.objInfo.body0;var n=z.objInfo.body1;var u=z.dirToBody;var B=h.numPenetrationRelaxationTimesteps*p;var y=0;var A;var s;var r=z.pointInfo.length;var t=b.NUM_TINY;if(r>1){var x=[0,0,0,0];var v=[0,0,0,0];var D=0;for(var q=0;q<r;q++){A=z.pointInfo[q];x=l.add(x,A.r0);v=l.add(v,A.r1);D+=A.initialPenetration;}x=b.getDivideVector(x,r);v=b.getDivideVector(v,r);D/=r;var C=new k();C.r0=x;C.r1=v;C.initialPenetration=D;z.pointInfo=[C];}A=z.pointInfo[0];if(!o.get_movable()){A.denominator=0;}else{s=l.crossProduct(A.r0,u);e.multiplyVector(o.get_worldInvInertia(),s);A.denominator=o.get_invMass()+l.dotProduct(u,l.crossProduct(s,A.r0));}if(n.get_movable()){s=l.crossProduct(A.r1,u);e.multiplyVector(n.get_worldInvInertia(),s);A.denominator+=(n.get_invMass()+l.dotProduct(u,l.crossProduct(s,A.r1)));}if(A.denominator<t){A.denominator=t;}if(A.initialPenetration>h.allowedPenetration){A.minSeparationVel=(A.initialPenetration-h.allowedPenetration)/B;}else{y=-0.1*(A.initialPenetration-h.allowedPenetration)/h.allowedPenetration;if(y<t){y=t;}else{if(y>1){y=1;}}var w=(p>t)?p:t;A.minSeparationVel=y*(A.initialPenetration-h.allowedPenetration)/w;}if(A.minSeparationVel>this._maxVelMag){A.minSeparationVel=this._maxVelMag;}};f.prototype.preProcessCollisionNormal=function(w,p){w.satisfied=false;var o=w.objInfo.body0;var n=w.objInfo.body1;var t=w.dirToBody;var y=h.numPenetrationRelaxationTimesteps*p;var v=0;var x;var s;var r=w.pointInfo.length;for(var q=0;q<r;q++){x=w.pointInfo[q];if(!o.get_movable()){x.denominator=0;}else{s=l.crossProduct(x.r0,t);e.multiplyVector(o.get_worldInvInertia(),s);x.denominator=o.get_invMass()+l.dotProduct(t,l.crossProduct(s,x.r0));}if(n.get_movable()){s=l.crossProduct(x.r1,t);e.multiplyVector(n.get_worldInvInertia(),s);x.denominator+=(n.get_invMass()+l.dotProduct(t,l.crossProduct(s,x.r1)));}if(x.denominator<b.NUM_TINY){x.denominator=b.NUM_TINY;}if(x.initialPenetration>h.allowedPenetration){x.minSeparationVel=(x.initialPenetration-h.allowedPenetration)/y;}else{v=-0.1*(x.initialPenetration-h.allowedPenetration)/h.allowedPenetration;if(v<b.NUM_TINY){v=b.NUM_TINY;}else{if(v>1){v=1;}}var u=(p>b.NUM_TINY)?p:b.NUM_TINY;x.minSeparationVel=v*(x.initialPenetration-h.allowedPenetration)/u;}if(x.minSeparationVel>this._maxVelMag){x.minSeparationVel=this._maxVelMag;}}};f.prototype.preProcessCollisionAccumulated=function(s,A){s.satisfied=false;var z=s.objInfo.body0;var x=s.objInfo.body1;var t=s.dirToBody;var y=h.numPenetrationRelaxationTimesteps*A;var r;var v;var J;var G=0;var H=b.NUM_TINY;var w=h.allowedPenetration;var F=s.pointInfo.length;for(var E=0;E<F;E++){v=s.pointInfo[E];J=v.initialPenetration-w;if(!z.get_movable()){v.denominator=0;}else{r=l.crossProduct(v.r0,t);e.multiplyVector(z.get_worldInvInertia(),r);v.denominator=z.get_invMass()+l.dotProduct(t,l.crossProduct(r,v.r0));}if(x.get_movable()){r=l.crossProduct(v.r1,t);e.multiplyVector(x.get_worldInvInertia(),r);v.denominator+=(x.get_invMass()+l.dotProduct(t,l.crossProduct(r,v.r1)));}if(v.denominator<H){v.denominator=H;}if(v.initialPenetration>w){v.minSeparationVel=J/y;}else{G=-0.1*J/w;if(G<H){G=H;}else{if(G>1){G=1;}}var D=(A>H)?A:H;v.minSeparationVel=G*J/D;}v.accumulatedNormalImpulse=0;v.accumulatedNormalImpulseAux=0;v.accumulatedFrictionImpulse=[0,0,0,0];var q=0.04;var I=new c(z,x,[0,0,0,0],[0,0,0,0]);for(var C=0,p=this._cachedContacts.length;C<p;C++){var n=this._cachedContacts[C];var B=n.pair;if(I.body0!=B.body0||I.body1==B.body1){continue;}var o=(B.body0==z)?l.get_lengthSquared(l.subtract(B.r,v.r0)):l.get_lengthSquared(l.subtract(B.r,v.r1));if(o<q){q=o;v.accumulatedNormalImpulse=this._cachedContacts[C].impulse.normalImpulse;v.accumulatedNormalImpulseAux=this._cachedContacts[C].impulse.normalImpulseAux;v.accumulatedFrictionImpulse=this._cachedContacts[C].impulse.frictionImpulse;if(this._cachedContacts[C].pair.body0!=z){v.accumulatedFrictionImpulse=b.getScaleVector(v.accumulatedFrictionImpulse,-1);}}}var u;if(v.accumulatedNormalImpulse!=0){u=b.getScaleVector(t,v.accumulatedNormalImpulse);u=l.add(u,v.accumulatedFrictionImpulse);z.applyBodyWorldImpulse(u,v.r0);x.applyBodyWorldImpulse(b.getScaleVector(u,-1),v.r1);}if(v.accumulatedNormalImpulseAux!=0){u=b.getScaleVector(t,v.accumulatedNormalImpulseAux);z.applyBodyWorldImpulseAux(u,v.r0);x.applyBodyWorldImpulseAux(b.getScaleVector(u,-1),v.r1);}}};f.prototype.processCollision=function(t,F){t.satisfied=true;var C=t.objInfo.body0;var B=t.objInfo.body1;var x=false;var v=t.dirToBody;var I=0;var J=0;var p=0;var E=0;var z;var w;var u;var A;var H=t.pointInfo.length;for(var G=0;G<H;G++){A=t.pointInfo[G];w=C.getVelocity(A.r0);u=B.getVelocity(A.r1);J=l.dotProduct(l.subtract(w,u),v);if(J>A.minSeparationVel){continue;}p=-1*t.mat.get_restitution()*J;if(p<this._minVelForProcessing){p=A.minSeparationVel;}I=p-J;if(I<=this._minVelForProcessing){continue;}E=I/A.denominator;x=true;z=b.getScaleVector(v,E);C.applyBodyWorldImpulse(z,A.r0);B.applyBodyWorldImpulse(b.getScaleVector(z,-1),A.r1);var r;var D=w.slice(0);if(B.get_movable()){D=l.subtract(w,u);}var s=l.subtract(D,b.getScaleVector(v,l.dotProduct(D,v)));var y=l.get_length(s);if(y>this._minVelForProcessing){var q=b.getDivideVector(s,-y);var n=0;if(C.get_movable()){r=l.crossProduct(A.r0,q);e.multiplyVector(C.get_worldInvInertia(),r);n=C.get_invMass()+l.dotProduct(q,l.crossProduct(r,A.r0));}if(B.get_movable()){r=l.crossProduct(A.r1,q);e.multiplyVector(B.get_worldInvInertia(),r);n+=(B.get_invMass()+l.dotProduct(q,l.crossProduct(r,A.r1)));}if(n>b.NUM_TINY){var o=y/n;q=b.getScaleVector(q,o);C.applyBodyWorldImpulse(q,A.r0);B.applyBodyWorldImpulse(b.getScaleVector(q,-1),A.r1);}}}if(x){C.setConstraintsAndCollisionsUnsatisfied();B.setConstraintsAndCollisionsUnsatisfied();}return x;};f.prototype.processCollisionAccumulated=function(t,K){t.satisfied=true;var y=false;var w=t.dirToBody;var H=t.objInfo.body0;var G=t.objInfo.body1;var Q=0;var S=0;var J=0;var B;var x;var v;var C;var P=t.pointInfo.length;for(var M=0;M<P;M++){C=t.pointInfo[M];x=H.getVelocity(C.r0);v=G.getVelocity(C.r1);S=l.dotProduct(l.subtract(x,v),w);Q=-S;if(C.minSeparationVel<0){Q+=C.minSeparationVel;}if(Math.abs(Q)>this._minVelForProcessing){J=Q/C.denominator;var E=C.accumulatedNormalImpulse;var L=(E+J);if(L<0){L=0;}C.accumulatedNormalImpulse=L;var u=L-E;B=b.getScaleVector(w,u);H.applyBodyWorldImpulse(B,C.r0);G.applyBodyWorldImpulse(b.getScaleVector(B,-1),C.r1);y=true;}x=H.getVelocityAux(C.r0);v=G.getVelocityAux(C.r1);S=l.dotProduct(l.subtract(x,v),w);Q=-S;if(C.minSeparationVel>0){Q+=C.minSeparationVel;}if(Math.abs(Q)>this._minVelForProcessing){J=Q/C.denominator;E=C.accumulatedNormalImpulseAux;var F=C.accumulatedNormalImpulseAux+J;if(F<0){F=0;}C.accumulatedNormalImpulseAux=F;u=F-E;B=b.getScaleVector(w,u);H.applyBodyWorldImpulseAux(B,C.r0);G.applyBodyWorldImpulseAux(b.getScaleVector(B,-1),C.r1);y=true;}if(C.accumulatedNormalImpulse>0){x=H.getVelocity(C.r0);v=G.getVelocity(C.r1);var r;var I=l.subtract(x,v);var s=l.subtract(I,b.getScaleVector(w,l.dotProduct(I,w)));var A=l.get_length(s);if(A>this._minVelForProcessing){var q=b.getScaleVector(b.getDivideVector(s,A),-1);var o=0;if(H.get_movable()){r=l.crossProduct(C.r0,q);e.multiplyVector(H.get_worldInvInertia(),r);o=H.invMass+l.dotProduct(q,l.crossProduct(r,C.r0));}if(G.get_movable()){r=l.crossProduct(C.r1,q);e.multiplyVector(G.get_worldInvInertia(),r);o+=(G.invMass+l.dotProduct(q,l.crossProduct(r,C.r1)));}if(o>b.NUM_TINY){var p=A/o;var n=b.getScaleVector(q,p);var R=C.accumulatedFrictionImpulse.slice(0);C.accumulatedFrictionImpulse=l.add(C.accumulatedFrictionImpulse,n);var O=l.get_length(C.accumulatedFrictionImpulse);var D=t.mat.friction*C.accumulatedNormalImpulse;if(O>b.NUM_TINY&&O>D){C.accumulatedFrictionImpulse=b.getScaleVector(C.accumulatedFrictionImpulse,D/O);}var z=l.subtract(C.accumulatedFrictionImpulse,R);H.applyBodyWorldImpulse(z,C.r0);G.applyBodyWorldImpulse(b.getScaleVector(z,-1),C.r1);}}}}if(y){H.setConstraintsAndCollisionsUnsatisfied();G.setConstraintsAndCollisionsUnsatisfied();}return y;};f.prototype.sortPositionX=function(o,n){if(o.get_currentState().position[0]<n.get_currentState().position[0]){return -1;}else{if(o.get_currentState().position[0]>n.get_currentState().position[0]){return 1;}else{return 0;}}};f.prototype.sortPositionY=function(o,n){if(o.get_currentState().position[1]<n.get_currentState().position[1]){return -1;}else{if(o.get_currentState().position[1]>n.get_currentState().position[1]){return 1;}else{return 0;}}};f.prototype.sortPositionZ=function(o,n){if(o.get_currentState().position[2]<n.get_currentState().position[2]){return -1;}else{if(o.get_currentState().position[2]>n.get_currentState().position[2]){return 1;}else{return 0;}}};f.prototype.doShockStep=function(q){if(Math.abs(this._gravity[0])>Math.abs(this._gravity[1])&&Math.abs(this._gravity[0])>Math.abs(this._gravity[2])){this._bodies=this._bodies.sort(this.sortPositionX);this._collisionSystem.collBody=this._collisionSystem.collBody.sort(this.sortPositionX);}else{if(Math.abs(this._gravity[1])>Math.abs(this._gravity[2])&&Math.abs(this._gravity[1])>Math.abs(this._gravity[0])){this._bodies=this._bodies.sort(this.sortPositionY);this._collisionSystem.collBody=this._collisionSystem.collBody.sort(this.sortPositionY);}else{if(Math.abs(this._gravity[2])>Math.abs(this._gravity[0])&&Math.abs(this._gravity[2])>Math.abs(this._gravity[1])){this._bodies=this._bodies.sort(this.sortPositionZ);this._collisionSystem.collBody=this._collisionSystem.collBody.sort(this.sortPositionZ);}}}var r;var n;var s=true;var t=[];var p;var o;while(s){s=false;for(var v=0;v<this._bodies.length;v++){var w=this._bodies[v];if(w.get_movable()&&w.get_doShockProcessing()){if(w.collisions.length==0||!w.isActive){w.internalSetImmovable();}else{n=false;t=w.collisions;for(var u=0;u<t.length;u++){r=t[u];p=r.objInfo.body0;o=r.objInfo.body1;if((p==w&&!o.get_movable())||(o==w&&!p.get_movable())){this.preProcessCollisionFast(r,q);this.processCollision(r,q);n=true;}}if(n){w.internalSetImmovable();s=true;}}}}}for(var v=0;v<this._bodies.length;v++){w=this._bodies[v];w.internalRestoreImmovable();t=w.collisions;for(var u=0;u<t.length;u++){r=t[u];this.preProcessCollisionFn(r,q);this.processCollisionFn(r,q);}}};f.prototype.updateContactCache=function(){this._cachedContacts=[];var s;var u;var n;for(var q=0,o=this._collisions.length;q<o;q++){var t=this._collisions[q];for(var p=0,r=t.pointInfo.length;p<r;p++){s=t.pointInfo[p];u=(t.objInfo.body0.id>t.objInfo.body1.id)?s.accumulatedFrictionImpulse:b.getScaleVector(s.accumulatedFrictionImpulse,-1);n=new g();n.pair=new c(t.objInfo.body0,t.objInfo.body1,s.r0,s.r1);n.impulse=new a(s.accumulatedNormalImpulse,s.accumulatedNormalImpulseAux,s.accumulatedFrictionImpulse);this._cachedContacts.push(n);}}};f.prototype.handleAllConstraints=function(n,w,y){var z=this._collisions.length;var v;var r;for(var s=0,x=this._constraints.length;s<x;s++){this._constraints[s].preApply(n);}if(y){for(var s=0,x=this._collisions.length;s<x;s++){this.preProcessContactFn(this._collisions[s],n);this._collisions[s].mat.set_restitution(0);this._collisions[s].satisfied=false;}}else{for(var s=0,x=this._collisions.length;s<x;s++){this.preProcessCollisionFn(this._collisions[s],n);
}}var u;var p;var t;for(var o=0;o<w;o++){p=false;for(var s=0,x=this._collisions.length;s<x;s++){v=this._collisions[s];if(!v.satisfied){if(y){u=this.processContactFn(v,n);p=p||u;}else{u=this.processCollisionFn(v,n);p=p||u;}}}for(var s=0,x=this._constraints.length;s<x;s++){var r=this._constraints[s];if(!r.get_satisfied()){u=r.apply(n);p=p||u;}}this.tryToActivateAllFrozenObjects();if(y){t=this._collisions.length;for(var q=z;q<t;q++){this._collisions[q].mat.set_restitution(0);this._collisions[q].satisfied=false;this.preProcessContactFn(this._collisions[q],n);}}else{t=this._collisions.length;for(q=z;q<t;q++){this.preProcessCollisionFn(this._collisions[q],n);}}z=this._collisions.length;if(!p){break;}}};f.prototype.handleAllEffects=function(){var o;var n=this._effects.length-1;if(n<0){return;}do{o=this._effects[n];if(o.enabled){o.Apply();}}while(n--);};f.prototype.activateObject=function(p){if(!p.get_movable()||p.isActive){return;}p.setActive();this._activeBodies.push(p);var r=this._collisions.length;this._collisionSystem.detectCollisions(p,this._collisions);var o;var s;for(var q=r,n=this._collisions.length;q<n;q++){o=this._collisions[q].objInfo.body0;s=this._collisions[q].dirToBody;if(o==p){o=this._collisions[q].objInfo.body1;s=b.getScaleVector(this._collisions[q].dirToBody,-1);}if(!o.isActive&&l.dotProduct(o.get_force(),s)<-b.NUM_TINY){this.activateObject(o);}}};f.prototype.dampAllActiveBodies=function(){for(var n=0,o=this._activeBodies.length;n<o;n++){_activeBody=this._activeBodies[n];_activeBody.dampForDeactivation();}};f.prototype.tryToActivateAllFrozenObjects=function(){for(var n=0,p=this._bodies.length;n<p;n++){var o=this._bodies[n];if(!o.isActive){if(o.getShouldBeActive()){this.activateObject(o);}else{if(o.getVelChanged()){o.setVelocity([0,0,0,0]);o.setAngVel([0,0,0,0]);o.clearVelChanged();}}}}};f.prototype.activateAllFrozenObjectsLeftHanging=function(){var n;for(var p=0,s=this._bodies.length;p<s;p++){var r=this._bodies[p];if(r.isActive){r.doMovementActivations();if(r.collisions.length>0){for(var o=0,q=r.collisions.length;o<q;o++){n=r.collisions[o].objInfo.body0;if(n==r){n=r.collisions[o].objInfo.body1;}if(!n.isActive){r.addMovementActivation(r.get_currentState().position,n);}}}}}};f.prototype.updateAllVelocities=function(o){for(var n=0,p=this._activeBodies.length;n<p;n++){_activeBody=this._activeBodies[n];_activeBody.updateVelocity(o);}};f.prototype.updateAllPositions=function(o){for(var n=0,p=this._activeBodies.length;n<p;n++){_activeBody=this._activeBodies[n];_activeBody.updatePositionWithAux(o);}};f.prototype.notifyAllPostPhysics=function(o){for(var n=0,p=this._bodies.length;n<p;n++){_body=this._bodies[n];_body.postPhysics(o);}};f.prototype.updateAllObject3D=function(){for(var n=0,o=this._bodies.length;n<o;n++){_body=this._bodies[n];_body.updateObject3D();}};f.prototype.limitAllVelocities=function(){for(var n=0,o=this._activeBodies.length;n<o;n++){_activeBody=this._activeBodies[n];_activeBody.limitVel();_activeBody.limitAngVel();}};f.prototype.tryToFreezeAllObjects=function(o){for(var n=0,p=this._activeBodies.length;n<p;n++){_activeBody=this._activeBodies[n];_activeBody.tryToFreeze(o);}};f.prototype.detectAllCollisions=function(o){for(var n=0,p=this._activeBodies.length;n<p;n++){_activeBody=this._activeBodies[n];_activeBody.storeState();}this.updateAllVelocities(o);this.updateAllPositions(o);for(var n=0,q=this._bodies.length;n<q;n++){_body=this._bodies[n];_body.collisions=[];}this._collisions=[];this._collisionSystem.detectAllCollisions(this._activeBodies,this._collisions);for(var n=0,p=this._activeBodies.length;n<p;n++){_activeBody=this._activeBodies[n];_activeBody.restoreState();}};f.prototype.copyAllCurrentStatesToOld=function(){for(var n=0,o=this._bodies.length;n<o;n++){_body=this._bodies[n];if(_body.isActive||_body.getVelChanged()){_body.copyCurrentStateToOld();}}};f.prototype.findAllActiveBodies=function(){this._activeBodies=[];for(var n=0,p=this._bodies.length;n<p;n++){var o=this._bodies[n];if(o.isActive){this._activeBodies.push(o);}}};f.prototype.integrate=function(o){this._doingIntegration=true;this.findAllActiveBodies();this.copyAllCurrentStatesToOld();this.getAllExternalForces(o);this.handleAllEffects();this.detectAllCollisions(o);this.handleAllConstraints(o,h.numCollisionIterations,false);this.updateAllVelocities(o);this.handleAllConstraints(o,h.numContactIterations,true);if(h.doShockStep){this.doShockStep(o);}this.dampAllActiveBodies();this.tryToFreezeAllObjects(o);this.activateAllFrozenObjectsLeftHanging();this.limitAllVelocities();this.updateAllPositions(o);this.notifyAllPostPhysics(o);this.updateAllObject3D();if(h.solverType=="ACCUMULATED"){this.updateContactCache();}for(var n=0,p=this._bodies.length;n<p;n++){_body=this._bodies[n];_body.clearForces();}this._doingIntegration=false;};d.PhysicsSystem=f;})(jigLib);(function(e){var j=e.Vector3DUtil;var a=e.JNumber3D;var k=e.JSegment;var b=e.JChassis;var d=e.JWheel;var f=e.PhysicsSystem;var c=Math,i=c.abs,h=c.sqrt;var g=function(l){this._chassis=new b(this,l);this._wheels=[];this._steerWheels=[];this._destSteering=this._destAccelerate=this._steering=this._accelerate=this._HBrake=0;this.setCar();};g.prototype._maxSteerAngle=null;g.prototype._steerRate=null;g.prototype._driveTorque=null;g.prototype._destSteering=null;g.prototype._destAccelerate=null;g.prototype._steering=null;g.prototype._accelerate=null;g.prototype._HBrake=null;g.prototype._chassis=null;g.prototype._wheels=null;g.prototype._steerWheels=null;g.prototype.setCar=function(n,m,l){if(n==null){n=45;}if(m==null){m=4;}if(l==null){l=500;}this._maxSteerAngle=n;this._steerRate=m;this._driveTorque=l;};g.prototype.setupWheel=function(z,p,u,x,n,E,D,q,t,A){if(u==null){u=2;}if(x==null){x=2;}if(n==null){n=3;}if(E==null){E=10;}if(D==null){D=0.5;}if(q==null){q=0.5;}if(t==null){t=1;}if(A==null){A=1;}var o=f.getInstance().get_gravity().slice(0);var w=this._chassis.get_mass();var r=0.25*w;var B=j.get_length(o);j.normalize(o);var l=a.getScaleVector(o,-1);var v=r*B/(D*n);var s=0.015*E*E*w;var m=q/2;var y=B*r;var C=new d(this);C.name=z;C.setup(p,l,v,n,s,E,u,x,m,t,A,y);this._wheels.push(C);};g.prototype.setAccelerate=function(l){this._destAccelerate=l;};g.prototype.setSteer=function(q,p){this._destSteering=p;this._steerWheels=[];var n=null;for(var o=0,m=q.length;o<m;o++){n=this.getWheel(q[o]);if(n){this._steerWheels.push(n);}}};g.prototype.findWheel=function(n){for(var o=0,m=this._wheels.length;o<m;o++){if(this._wheels[o].name==n){return true;}}return false;};g.prototype.getWheel=function(l){for(var m=0;m<this._wheels.length;m++){if(this._wheels[m].name==l){return this._wheels[m];}}return null;};g.prototype.setHBrake=function(l){this._HBrake=l;};g.prototype.addExternalForces=function(m){for(var l=0,n=this._wheels.length;l<n;l++){this._wheels[l].addForcesToCar(m);}};g.prototype.postPhysics=function(m){for(var p=0,u=this._wheels.length;p<u;p++){this._wheels[p].update(m);}var l=m;var r=m*this._steerRate;var n=this._destAccelerate-this._accelerate;if(n<-l){n=-l;}else{if(n>l){n=l;}}this._accelerate+=n;var s=this._destSteering-this._steering;if(s<-r){s=-r;}else{if(s>r){s=r;}}this._steering+=s;for(var p=0;p<this._wheels.length;p++){this._wheels[p].addTorque(this._driveTorque*this._accelerate);this._wheels[p].setLock(this._HBrake>0.5);}var o=i(this._maxSteerAngle*this._steering);var q=(this._steering>0)?1:-1;for(var p=0,t=this._steerWheels.length;p<t;p++){this._steerWheels[p].setSteerAngle(q*o);}};g.prototype.getNumWheelsOnFloor=function(n){var m=0;for(var l=0,o=this._wheels.length;l<o;l++){if(this._wheels[l].getOnFloor()){m++;}}return m;};e.JCar=g;})(jigLib);(function(b){var c=b.JNumber3D;var a=b.JBox;var d=function(f,h,g,i,e){if(g==null){g=40;}if(i==null){i=70;}if(e==null){e=30;}this.Super(h,g,i,e);this._car=f;};b.extend(d,b.JBox);d.prototype._car=null;d.prototype.addExternalForces=function(e){this.clearForces();this.addGravity();this._car.addExternalForces(e);};d.prototype.postPhysics=function(e){this._car.postPhysics(e);};b.JChassis=d;})(jigLib);(function(f){var o=f.Vector3DUtil;var h=f.JMatrix3D;var a=f.JNumber3D;var p=f.JSegment;var j=f.JConfig;var i=f.PhysicsSystem;var c=Math,g=c.PI,e=c.min,k=c.max,m=c.cos,n=c.abs,l=c.sqrt;var d=function(q){this._car=q;};d.prototype.name=null;d.prototype.noslipVel=0.2;d.prototype.slipVel=0.4;d.prototype.slipFactor=0.7;d.prototype.smallVel=3;d.prototype._car=null;d.prototype._pos=null;d.prototype._axisUp=null;d.prototype._spring=null;d.prototype._travel=null;d.prototype._inertia=null;d.prototype._radius=null;d.prototype._sideFriction=null;d.prototype._fwdFriction=null;d.prototype._damping=null;d.prototype._numRays=null;d.prototype._angVel=null;d.prototype._steerAngle=null;d.prototype._torque=null;d.prototype._driveTorque=null;d.prototype._axisAngle=null;d.prototype._displacement=null;d.prototype._upSpeed=null;d.prototype._rotDamping=null;d.prototype._normalForce=null;d.prototype._locked=null;d.prototype._lastDisplacement=null;d.prototype._lastOnFloor=null;d.prototype._angVelForGrip=null;d.prototype.worldPos=null;d.prototype.worldAxis=null;d.prototype.wheelFwd=null;d.prototype.wheelUp=null;d.prototype.wheelLeft=null;d.prototype.wheelRayEnd=null;d.prototype.wheelRay=null;d.prototype.groundUp=null;d.prototype.groundLeft=null;d.prototype.groundFwd=null;d.prototype.wheelPointVel=null;d.prototype.rimVel=null;d.prototype.worldVel=null;d.prototype.wheelCentreVel=null;d.prototype._collSystem=null;d.prototype.setup=function(y,v,A,r,w,x,s,u,t,z,B,q){if(A==null){A=0;}if(r==null){r=0;}if(w==null){w=0;}if(x==null){x=0;}if(s==null){s=0;}if(u==null){u=0;}if(t==null){t=0;}if(z==null){z=0;}if(B==null){B=0;}if(q==null){q=0;}this._pos=y;this._axisUp=v;this._spring=A;this._travel=r;this._inertia=w;this._radius=x;this._sideFriction=s;this._fwdFriction=u;this._damping=t;this._numRays=z;this._drive=B;this._normalForce=q;this._torque=0;this.reset();};d.prototype.addTorque=function(q){this._driveTorque+=q;};d.prototype.setLock=function(q){this._locked=q;};d.prototype.setSteerAngle=function(q){this._steerAngle=q;};d.prototype.getSteerAngle=function(){return this._steerAngle;};d.prototype.getPos=function(){return this._pos;};d.prototype.getLocalAxisUp=function(){return this._axisUp;};d.prototype.getActualPos=function(){return o.add(this._pos,a.getScaleVector(this._axisUp,this._displacement));};d.prototype.getRadius=function(){return this._radius;};d.prototype.getDisplacement=function(){return this._displacement;};d.prototype.getAxisAngle=function(){return this._axisAngle;};d.prototype.getRollAngle=function(){return 0.1*this._angVel*180/g;};d.prototype.setRotationDamping=function(q){this._rotDamping=q;};d.prototype.getRotationDamping=function(){return this._rotDamping;};d.prototype.getOnFloor=function(){return this._lastOnFloor;};var b=0;d.prototype.addForcesToCar=function(P){var r=[0,0,0,0];this._lastDisplacement=this._displacement;this._displacement=0;var Y=this._car._chassis;worldPos=this._pos.slice(0);h.multiplyVector(Y.get_currentState().get_orientation(),worldPos);worldPos=o.add(Y.get_currentState().position,worldPos);worldAxis=this._axisUp.slice(0);h.multiplyVector(Y.get_currentState().get_orientation(),worldAxis);wheelFwd=Y.get_currentState().getOrientationCols()[2].slice(0);h.multiplyVector(h.getRotationMatrix(worldAxis[0],worldAxis[1],worldAxis[2],this._steerAngle/180*2*Math.PI),wheelFwd);wheelUp=worldAxis;wheelLeft=o.crossProduct(wheelUp,wheelFwd);o.normalize(wheelLeft);var X=2*this._radius+this._travel;wheelRayEnd=o.subtract(worldPos,a.getScaleVector(worldAxis,this._radius));wheelRay=new p(o.add(wheelRayEnd,a.getScaleVector(worldAxis,X)),a.getScaleVector(worldAxis,-X));if(this._collSystem==null){this._collSystem=i.getInstance().getCollisionSystem();}var V=10;var t=e(this._numRays,V);var x=[];var T=[];var B=(2*this._radius)/(t+1);var W=B;this._lastOnFloor=false;var z;var I;var D=0;var L=0;var q=null;for(L=0;L<t;L++){x[L]={};z=(W+L*B)-this._radius;I=this._radius*(1-m(90*(z/this._radius)*g/180));q=wheelRay.clone();q.origin=o.add(q.origin,o.add(a.getScaleVector(wheelFwd,z),a.getScaleVector(wheelUp,I)));if(this._collSystem.segmentIntersect(x[L],q,Y)){this._lastOnFloor=true;if(x[L].fracOut<x[D].fracOut){D=L;}}T[L]=q;}if(!this._lastOnFloor){return false;}var v=x[D].fracOut;var O=x[D].posOut;var M=x[D].bodyOut;var R=worldAxis.slice(0);if(t>1){for(L=0;L<t;L++){var G=x[L].fracOut;if(G<=1){R=o.add(R,a.getScaleVector(o.subtract(worldPos,T[L].getEnd()),1-G));}}o.normalize(R);}else{R=x[D].normalOut;}wheelFwd=o.crossProduct(wheelLeft,R);this._displacement=X*(1-v);if(this._displacement<0){this._displacement=0;}var Q=Y.get_mass();var F=Q/4;var s=M.get_friction();var K=Y.getVelocity(this._pos);var y=this._displacement;if(this._displacement>this._travel){this._displacement=this._travel;var w=o.dotProduct(K,R)/P*F;w=w*2*M.get_restitution()/10;A=a.getScaleVector(R,-w);r=o.add(r,A);}A=a.getScaleVector(this._axisUp,this._spring*this._displacement+this._upSpeed*this._damping);r=o.add(r,A);groundUp=R;groundLeft=o.crossProduct(R,wheelFwd);o.normalize(groundLeft);groundFwd=o.crossProduct(groundLeft,groundUp);var S=a.getScaleVector(o.crossProduct(groundLeft,o.subtract(O,worldPos)),-this._angVel);var u=a.getScaleVector(groundFwd,o.dotProduct(K,groundFwd));var C=this._fwdFriction*s;var A=a.getScaleVector(o.subtract(S,u),F/P/this._radius*C);var H=o.get_length(A);if(H>this._normalForce*C){A=a.getScaleVector(A,this._normalForce*C/H);}r=o.add(r,A);this._torque-=o.dotProduct(o.subtract(S,u),groundFwd)/this._radius*F/P;this._angVelForGrip=o.dotProduct(K,groundFwd)/this._radius;var E=o.dotProduct(K,groundLeft);var C=this._sideFriction*s;var U=a.getScaleVector(groundLeft,-E*C);var A=a.getScaleVector(U,F/P/this._radius);var H=o.get_length(A);if(H>this._normalForce*C){A=a.getScaleVector(A,this._normalForce*C/H);}r=o.add(r,A);Y.addWorldForce(r,O);if(M.get_movable()){var J=500;var N=J*M.get_mass();if(o.get_lengthSquared(r)>(N*N)){r=a.getScaleVector(r,N/o.get_length(r));}M.addWorldForce(a.getScaleVector(r,-1),O);}return true;};d.prototype.update=function(r){if(r<=0){return;}var q=this._angVel;this._upSpeed=(this._displacement-this._lastDisplacement)/k(r,a.NUM_TINY);if(this._locked){this._angVel=0;this._torque=0;}else{this._angVel+=(this._torque*r/this._inertia);this._torque=0;if(((q>this._angVelForGrip)&&(this._angVel<this._angVelForGrip))||((q<this._angVelForGrip)&&(this._angVel>this._angVelForGrip))){this._angVel=this._angVelForGrip;}this._angVel+=this._driveTorque*r/this._inertia*this._drive;this._driveTorque=0;if(this._angVel<-100){this._angVel=-100;}else{if(this._angVel>100){this._angVel=100;}}this._angVel*=this._rotDamping;this._axisAngle+=(this._angVel*r*180/g);}};d.prototype.reset=function(){this._angVel=0;this._steerAngle=0;this._torque=0;this._driveTorque=0;this._axisAngle=0;this._displacement=0;this._upSpeed=0;this._locked=false;this._lastDisplacement=0;this._lastOnFloor=false;this._angVelForGrip=0;this._rotDamping=0.99;};f.JWheel=d;})(jigLib);